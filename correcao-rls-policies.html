<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Corre√ß√£o RLS Policies - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            background: #f8f9ff;
        }
        .success { border-left-color: #10b981; background: #f0fdf4; }
        .error { border-left-color: #ef4444; background: #fef2f2; }
        .warning { border-left-color: #f59e0b; background: #fffbeb; }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #5a67d8; transform: translateY(-2px); }
        .btn.danger { background: #ef4444; }
        .btn.danger:hover { background: #dc2626; }
        .btn.success { background: #10b981; }
        .btn.success:hover { background: #059669; }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .policy-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .policy-header {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .policy-details {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6b7280;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        
        .sql-command {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Corre√ß√£o RLS Policies</h1>
            <p>Ferramenta para diagnosticar e corrigir pol√≠ticas de Row Level Security</p>
        </div>

        <!-- Status Atual -->
        <div class="section">
            <h3>üìä Status Atual das Pol√≠ticas RLS</h3>
            <button class="btn" onclick="verificarPoliticasAtuais()">üîç Verificar Pol√≠ticas</button>
            <button class="btn" onclick="testarAcessoTabelas()">üß™ Testar Acesso</button>
            <div class="result" id="statusResults"></div>
        </div>

        <!-- Pol√≠ticas Problem√°ticas -->
        <div class="section warning">
            <h3>‚ö†Ô∏è Pol√≠ticas Que Podem Estar Causando Problemas</h3>
            <div id="problematicPolicies">
                <div class="policy-card">
                    <div class="policy-header">usuarios_empresa - Pol√≠tica Restritiva</div>
                    <div class="policy-details">
Pol√≠tica atual: usuarios_empresa_allow_all_authenticated
Condi√ß√£o: (current_setting('role'::text, true) = 'service_role'::text) OR (auth.uid() IS NOT NULL)

PROBLEMA: Requer autentica√ß√£o para qualquer acesso, mas o frontend pode n√£o estar autenticado.
                    </div>
                </div>
                
                <div class="policy-card">
                    <div class="policy-header">empresas - Pol√≠tica de Associa√ß√£o</div>
                    <div class="policy-details">
Pol√≠tica: Ver empresas do usuario
Condi√ß√£o: EXISTS (SELECT 1 FROM usuarios_empresa WHERE user_id = auth.uid() AND empresa_id = empresas.id)

PROBLEMA: S√≥ permite ver empresas se o usu√°rio j√° estiver associado na usuarios_empresa.
                    </div>
                </div>
            </div>
        </div>

        <!-- Corre√ß√µes Sugeridas -->
        <div class="section">
            <h3>üîß Corre√ß√µes Dispon√≠veis</h3>
            
            <h4>Op√ß√£o 1: Pol√≠ticas Tempor√°rias (Desenvolvimento)</h4>
            <button class="btn success" onclick="aplicarPoliticasTemporarias()">üöÄ Aplicar Pol√≠ticas Tempor√°rias</button>
            <p><small>‚ö†Ô∏è Permite acesso mais amplo para desenvolvimento. N√ÉO usar em produ√ß√£o!</small></p>
            
            <h4>Op√ß√£o 2: Pol√≠ticas de Produ√ß√£o (Recomendado)</h4>
            <button class="btn" onclick="aplicarPoliticasProducao()">üîí Aplicar Pol√≠ticas Seguras</button>
            <p><small>‚úÖ Mant√©m seguran√ßa mas permite acesso necess√°rio para o sistema funcionar.</small></p>
            
            <h4>Op√ß√£o 3: Desabilitar RLS Temporariamente</h4>
            <button class="btn danger" onclick="desabilitarRLS()">‚ö†Ô∏è Desabilitar RLS</button>
            <p><small>üö® CUIDADO: Remove toda prote√ß√£o RLS. S√≥ para debug!</small></p>
            
            <div class="result" id="correctionResults"></div>
        </div>

        <!-- Comandos SQL -->
        <div class="section">
            <h3>üìù Comandos SQL para Execu√ß√£o Manual</h3>
            <p>Se as corre√ß√µes autom√°ticas n√£o funcionarem, execute estes comandos diretamente no Supabase:</p>
            
            <h4>1. Pol√≠ticas Tempor√°rias de Desenvolvimento:</h4>
            <div class="sql-command">
-- Remover pol√≠ticas restritivas
DROP POLICY IF EXISTS "usuarios_empresa_allow_all_authenticated" ON usuarios_empresa;
DROP POLICY IF EXISTS "Ver empresas do usuario" ON empresas;

-- Criar pol√≠ticas tempor√°rias mais permissivas
CREATE POLICY "usuarios_empresa_temp_allow_all" ON usuarios_empresa
    FOR ALL USING (true);

CREATE POLICY "empresas_temp_allow_all" ON empresas
    FOR ALL USING (true);

CREATE POLICY "permissoes_temp_allow_all" ON permissoes_usuario
    FOR ALL USING (true);
            </div>
            
            <h4>2. Pol√≠ticas de Produ√ß√£o Seguras:</h4>
            <div class="sql-command">
-- Pol√≠tica para usuarios_empresa (permite acesso autenticado + service_role)
CREATE OR REPLACE POLICY "usuarios_empresa_secure_access" ON usuarios_empresa
    FOR ALL USING (
        auth.role() = 'service_role' OR 
        (auth.uid() IS NOT NULL AND (
            auth.uid() = user_id OR 
            EXISTS (
                SELECT 1 FROM usuarios_empresa ue2 
                WHERE ue2.user_id = auth.uid() 
                AND ue2.papel IN ('SUPER_ADMIN', 'ADMIN')
            )
        ))
    );

-- Pol√≠tica para empresas (permite ver empresa se usu√°rio pertence a ela)
CREATE OR REPLACE POLICY "empresas_secure_access" ON empresas
    FOR ALL USING (
        auth.role() = 'service_role' OR
        EXISTS (
            SELECT 1 FROM usuarios_empresa 
            WHERE user_id = auth.uid() 
            AND empresa_id = empresas.id
        )
    );
            </div>
            
            <h4>3. Desabilitar RLS (Emerg√™ncia):</h4>
            <div class="sql-command">
-- CUIDADO: Remove toda prote√ß√£o RLS
ALTER TABLE usuarios_empresa DISABLE ROW LEVEL SECURITY;
ALTER TABLE empresas DISABLE ROW LEVEL SECURITY;
ALTER TABLE permissoes_usuario DISABLE ROW LEVEL SECURITY;
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jtfdzjmravketpkwjkvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZmR6am1yYXZrZXRwa3dqa3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjM1NjIsImV4cCI6MjA3MzkzOTU2Mn0.AOFSlSLFVw-pU1-lpUzxJ2fov3kR95eBlz_92mtSMgs';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function verificarPoliticasAtuais() {
            log('üîç Verificando pol√≠ticas RLS atuais...');
            
            try {
                // Tentar acessar cada tabela para ver quais pol√≠ticas est√£o bloqueando
                const tabelas = ['usuarios_empresa', 'empresas', 'permissoes_usuario', 'profiles'];
                
                for (const tabela of tabelas) {
                    log(`\\nüìã Testando tabela: ${tabela}`);
                    
                    try {
                        const { data, error } = await supabase
                            .from(tabela)
                            .select('*')
                            .limit(1);
                        
                        if (error) {
                            log(`‚ùå ${tabela}: ${error.message}`);
                            if (error.message.includes('RLS') || error.message.includes('policy')) {
                                log(`üõ°Ô∏è Problema de RLS detectado na tabela ${tabela}`);
                            }
                        } else {
                            log(`‚úÖ ${tabela}: Acesso OK (${data.length} registros)`);
                        }
                    } catch (err) {
                        log(`‚ùå ${tabela}: Erro de conex√£o - ${err.message}`);
                    }
                }
                
                // Verificar se h√° usu√°rio autenticado
                log('\\nüë§ Verificando autentica√ß√£o...');
                const { data: user, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user.user) {
                    log('‚ö†Ô∏è Usu√°rio n√£o autenticado - isso pode causar problemas com RLS');
                    log('üí° Sugest√£o: Fa√ßa login no sistema antes de testar');
                } else {
                    log(`‚úÖ Usu√°rio autenticado: ${user.user.email}`);
                }
                
            } catch (error) {
                log('‚ùå Erro ao verificar pol√≠ticas: ' + error.message);
            }
        }

        async function testarAcessoTabelas() {
            log('üß™ Testando acesso espec√≠fico √†s tabelas...');
            
            try {
                // Teste 1: Buscar usu√°rio riltons
                log('\\nüë§ Testando busca do usu√°rio riltons@gmail.com...');
                
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', '02f69247-ca96-4356-bb9c-820f5fcaa761');
                
                if (profileError) {
                    log('‚ùå Erro ao buscar profile: ' + profileError.message);
                } else if (profileData.length > 0) {
                    log('‚úÖ Profile encontrado: ' + JSON.stringify(profileData[0], null, 2));
                } else {
                    log('‚ö†Ô∏è Profile n√£o encontrado');
                }
                
                // Teste 2: Buscar na usuarios_empresa
                log('\\nüè¢ Testando busca na usuarios_empresa...');
                
                const { data: usuarioData, error: usuarioError } = await supabase
                    .from('usuarios_empresa')
                    .select('*')
                    .eq('email', 'riltons@gmail.com');
                
                if (usuarioError) {
                    log('‚ùå Erro ao buscar usuarios_empresa: ' + usuarioError.message);
                    log('üîç Detalhes do erro: ' + JSON.stringify(usuarioError, null, 2));
                } else if (usuarioData.length > 0) {
                    log('‚úÖ Usu√°rio empresa encontrado: ' + JSON.stringify(usuarioData[0], null, 2));
                } else {
                    log('‚ö†Ô∏è Usu√°rio empresa n√£o encontrado');
                }
                
                // Teste 3: Buscar empresa
                log('\\nüè¢ Testando busca de empresas...');
                
                const { data: empresaData, error: empresaError } = await supabase
                    .from('empresas')
                    .select('*')
                    .limit(1);
                
                if (empresaError) {
                    log('‚ùå Erro ao buscar empresas: ' + empresaError.message);
                } else {
                    log('‚úÖ Empresas acess√≠veis: ' + empresaData.length);
                }
                
            } catch (error) {
                log('‚ùå Erro no teste de acesso: ' + error.message);
            }
        }

        async function aplicarPoliticasTemporarias() {
            log('üöÄ Aplicando pol√≠ticas tempor√°rias de desenvolvimento...');
            log('‚ö†Ô∏è ATEN√á√ÉO: Estas pol√≠ticas s√£o menos seguras e devem ser usadas apenas para desenvolvimento!');
            
            try {
                // Nota: Como n√£o temos acesso direto ao SQL via frontend,
                // vamos mostrar as instru√ß√µes para execu√ß√£o manual
                log('\\nüìù INSTRU√á√ïES PARA EXECU√á√ÉO MANUAL:');
                log('1. Acesse o Supabase Dashboard');
                log('2. V√° para SQL Editor');
                log('3. Execute os seguintes comandos:');
                log('\\n-- Remover pol√≠ticas restritivas');
                log('DROP POLICY IF EXISTS "usuarios_empresa_allow_all_authenticated" ON usuarios_empresa;');
                log('DROP POLICY IF EXISTS "Ver empresas do usuario" ON empresas;');
                log('\\n-- Criar pol√≠ticas tempor√°rias');
                log('CREATE POLICY "usuarios_empresa_temp_allow_all" ON usuarios_empresa FOR ALL USING (true);');
                log('CREATE POLICY "empresas_temp_allow_all" ON empresas FOR ALL USING (true);');
                log('CREATE POLICY "permissoes_temp_allow_all" ON permissoes_usuario FOR ALL USING (true);');
                
                log('\\n‚úÖ Instru√ß√µes geradas! Execute no Supabase Dashboard.');
                
            } catch (error) {
                log('‚ùå Erro: ' + error.message);
            }
        }

        async function aplicarPoliticasProducao() {
            log('üîí Gerando pol√≠ticas seguras para produ√ß√£o...');
            
            log('\\nüìù POL√çTICAS SEGURAS RECOMENDADAS:');
            log('Execute no SQL Editor do Supabase:');
            
            log('\\n-- 1. Pol√≠tica segura para usuarios_empresa');
            log(`CREATE OR REPLACE POLICY "usuarios_empresa_secure_access" ON usuarios_empresa
    FOR ALL USING (
        auth.role() = 'service_role' OR 
        (auth.uid() IS NOT NULL AND (
            auth.uid() = user_id OR 
            EXISTS (
                SELECT 1 FROM usuarios_empresa ue2 
                WHERE ue2.user_id = auth.uid() 
                AND ue2.papel IN ('SUPER_ADMIN', 'ADMIN')
            )
        ))
    );`);
            
            log('\\n-- 2. Pol√≠tica segura para empresas');
            log(`CREATE OR REPLACE POLICY "empresas_secure_access" ON empresas
    FOR ALL USING (
        auth.role() = 'service_role' OR
        EXISTS (
            SELECT 1 FROM usuarios_empresa 
            WHERE user_id = auth.uid() 
            AND empresa_id = empresas.id
        )
    );`);
            
            log('\\n-- 3. Pol√≠tica segura para permiss√µes');
            log(`CREATE OR REPLACE POLICY "permissoes_secure_access" ON permissoes_usuario
    FOR ALL USING (
        auth.role() = 'service_role' OR
        EXISTS (
            SELECT 1 FROM usuarios_empresa 
            WHERE user_id = auth.uid() 
            AND id = permissoes_usuario.usuario_empresa_id
        )
    );`);
            
            log('\\n‚úÖ Pol√≠ticas seguras geradas!');
        }

        async function desabilitarRLS() {
            log('‚ö†Ô∏è GERANDO COMANDOS PARA DESABILITAR RLS...');
            log('üö® CUIDADO: Isso remove TODA a prote√ß√£o de seguran√ßa!');
            log('üö® Use apenas para debug e reative o RLS depois!');
            
            log('\\nüìù Execute no SQL Editor do Supabase:');
            log('\\n-- Desabilitar RLS (TEMPOR√ÅRIO)');
            log('ALTER TABLE usuarios_empresa DISABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE empresas DISABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE permissoes_usuario DISABLE ROW LEVEL SECURITY;');
            
            log('\\n-- Para REABILITAR depois do debug:');
            log('ALTER TABLE usuarios_empresa ENABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE empresas ENABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE permissoes_usuario ENABLE ROW LEVEL SECURITY;');
            
            log('\\n‚ö†Ô∏è LEMBRE-SE: Reabilite o RLS ap√≥s resolver o problema!');
        }

        function log(message, elementId = 'statusResults') {
            const results = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += '[' + timestamp + '] ' + message + '\\n';
            results.scrollTop = results.scrollHeight;
        }
    </script>
</body>
</html>