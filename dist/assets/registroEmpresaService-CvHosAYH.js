import{s as i}from"./index-6WbGME8T.js";class l{static async empresaTemPrimeiroUsuario(r){try{const{data:e,error:o}=await i.from("usuarios_empresa").select("id").eq("empresa_id",r).eq("is_primeiro_usuario",!0).single();return o&&o.code!=="PGRST116"?(console.error("Erro ao verificar primeiro usuário:",o),!1):!!e}catch(e){return console.error("Erro ao verificar primeiro usuário:",e),!1}}static async criarPrimeiroUsuario(r){try{if(await this.empresaTemPrimeiroUsuario(r.empresa_id))return{success:!1,error:"Esta empresa já possui um primeiro usuário (SUPER_ADMIN)"};const{data:o,error:a}=await i.from("usuarios_empresa").insert({user_id:r.user_id,empresa_id:r.empresa_id,nome_completo:r.nome_completo,email:r.email,telefone:r.telefone,cargo:r.cargo,is_primeiro_usuario:!0,status:"ativo"}).select().single();return a?(console.error("Erro ao criar primeiro usuário:",a),{success:!1,error:a.message}):{success:!0,usuarioId:o.id}}catch(e){return console.error("Erro ao criar primeiro usuário:",e),{success:!1,error:"Erro interno do servidor"}}}static async validarPrimeiroUsuario(r,e){try{const{data:o,error:a}=await i.from("usuarios_empresa").select("id, nome_completo").eq("empresa_id",r).eq("is_primeiro_usuario",!0);return a?(console.error("Erro ao validar primeiro usuário:",a),{valido:!1,motivo:"Erro ao verificar dados existentes"}):!o||o.length===0?{valido:!0}:e&&o.some(s=>s.id===e)?{valido:!0}:{valido:!1,motivo:`Já existe um primeiro usuário: ${o[0].nome_completo}`}}catch(o){return console.error("Erro ao validar primeiro usuário:",o),{valido:!1,motivo:"Erro interno do servidor"}}}static async obterPrimeiroUsuario(r){try{const{data:e,error:o}=await i.from("usuarios_empresa").select("*").eq("empresa_id",r).eq("is_primeiro_usuario",!0).single();return o&&o.code!=="PGRST116"?(console.error("Erro ao obter primeiro usuário:",o),null):e}catch(e){return console.error("Erro ao obter primeiro usuário:",e),null}}static async verificarConfiguracaoesAutomaticas(r){try{const{data:e,error:o}=await i.from("configuracoes_empresa").select("categoria").eq("empresa_id",r);if(o)return console.error("Erro ao verificar configurações:",o),{criadas:!1,categorias_faltando:[]};const a=e.map(c=>c.categoria),t=["geral","seguranca","sistema","notificacoes","integracao"].filter(c=>!a.includes(c));return{criadas:t.length===0,categorias_faltando:t}}catch(e){return console.error("Erro ao verificar configurações:",e),{criadas:!1,categorias_faltando:[]}}}static async verificarPermissoesAutomaticas(r){try{const{data:e,error:o}=await i.from("permissoes_usuario").select("modulo").eq("usuario_empresa_id",r);if(o)return console.error("Erro ao verificar permissões:",o),{criadas:!1,modulos_faltando:[]};const a=e.map(c=>c.modulo),t=["dashboard","monitor_bar","atendimento_bar","monitor_cozinha","gestao_caixa","clientes","funcionarios","socios","configuracoes","relatorios"].filter(c=>!a.includes(c));return{criadas:t.length===0,modulos_faltando:t}}catch(e){return console.error("Erro ao verificar permissões:",e),{criadas:!1,modulos_faltando:[]}}}static async criarConfiguracoesPadrao(r){try{const e=[{empresa_id:r,categoria:"geral",configuracoes:{tema:"claro",idioma:"pt-BR",timezone:"America/Sao_Paulo"}},{empresa_id:r,categoria:"seguranca",configuracoes:{tempo_sessao:480,tentativas_login:5,bloqueio_temporario:15}},{empresa_id:r,categoria:"sistema",configuracoes:{backup_automatico:!0,retencao_logs_dias:90,limite_usuarios:50}},{empresa_id:r,categoria:"notificacoes",configuracoes:{email_novos_usuarios:!0,email_tentativas_login:!0}},{empresa_id:r,categoria:"integracao",configuracoes:{}}],{error:o}=await i.from("configuracoes_empresa").upsert(e,{onConflict:"empresa_id,categoria",ignoreDuplicates:!0});return o?(console.error("Erro ao criar configurações padrão:",o),{success:!1,error:o.message}):{success:!0}}catch(e){return console.error("Erro ao criar configurações padrão:",e),{success:!1,error:"Erro interno do servidor"}}}static async criarPermissoesCompletas(r){try{const o=["dashboard","monitor_bar","atendimento_bar","monitor_cozinha","gestao_caixa","clientes","funcionarios","socios","configuracoes","relatorios"].map(s=>({usuario_empresa_id:r,modulo:s,permissoes:{visualizar:!0,criar:!0,editar:!0,excluir:!0,administrar:!0}})),{error:a}=await i.from("permissoes_usuario").upsert(o,{onConflict:"usuario_empresa_id,modulo",ignoreDuplicates:!0});return a?(console.error("Erro ao criar permissões completas:",a),{success:!1,error:a.message}):{success:!0}}catch(e){return console.error("Erro ao criar permissões completas:",e),{success:!1,error:"Erro interno do servidor"}}}}class p{static async registrarEmpresa(r){try{const e=this.validarDadosRegistro(r);if(!e.valido)return{success:!1,error:e.erro};if(await this.verificarCNPJExistente(r.cnpj))return{success:!1,error:"CNPJ já cadastrado no sistema"};const{data:a,error:s}=await i.auth.signUp({email:r.email_admin,password:r.senha,options:{data:{name:r.nome_admin,full_name:r.nome_admin}}});if(s||!a.user)return console.error("Erro ao criar usuário no auth:",s),{success:!1,error:(s==null?void 0:s.message)||"Erro ao criar usuário"};const t=await this.criarEmpresa(r);return!t.success||!t.empresa?{success:!1,error:t.error}:t}catch(e){return console.error("Erro no registro da empresa:",e),{success:!1,error:"Erro interno do servidor"}}}static validarDadosRegistro(r){var e,o,a,s;return(e=r.nome_empresa)!=null&&e.trim()?(o=r.cnpj)!=null&&o.trim()?this.validarCNPJ(r.cnpj)?(a=r.nome_admin)!=null&&a.trim()?(s=r.email_admin)!=null&&s.trim()?this.validarEmail(r.email_admin)?!r.senha||r.senha.length<8?{valido:!1,erro:"Senha deve ter pelo menos 8 caracteres"}:r.senha!==r.confirmar_senha?{valido:!1,erro:"Senhas não coincidem"}:{valido:!0}:{valido:!1,erro:"Email inválido"}:{valido:!1,erro:"Email é obrigatório"}:{valido:!1,erro:"Nome do administrador é obrigatório"}:{valido:!1,erro:"CNPJ inválido"}:{valido:!1,erro:"CNPJ é obrigatório"}:{valido:!1,erro:"Nome da empresa é obrigatório"}}static validarCNPJ(r){const e=r.replace(/[^\d]/g,"");if(e.length!==14||/^(\d)\1{13}$/.test(e))return!1;let o=0,a=2;for(let n=11;n>=0;n--)o+=parseInt(e[n])*a,a=a===9?2:a+1;const s=o%11,t=s<2?0:11-s;if(parseInt(e[12])!==t)return!1;o=0,a=2;for(let n=12;n>=0;n--)o+=parseInt(e[n])*a,a=a===9?2:a+1;const c=o%11,m=c<2?0:11-c;return parseInt(e[13])===m}static validarEmail(r){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)}static async verificarCNPJExistente(r){try{const{data:e,error:o}=await i.from("empresas").select("id").eq("cnpj",r).single();return o&&o.code!=="PGRST116"?(console.error("Erro ao verificar CNPJ:",o),!1):!!e}catch(e){return console.error("Erro ao verificar CNPJ:",e),!1}}static async criarEmpresa(r){try{const{data:e,error:o}=await i.from("empresas").insert({nome:r.nome_empresa,cnpj:r.cnpj,email_admin:r.email_admin,telefone:r.telefone_empresa,endereco:r.endereco,status:"ativo"}).select().single();if(o||!e)return console.error("Erro ao criar empresa:",o),{success:!1,error:(o==null?void 0:o.message)||"Erro ao criar empresa"};const{data:{user:a}}=await i.auth.getUser();if(!a)return{success:!1,error:"Usuário não autenticado"};const s=await l.criarPrimeiroUsuario({user_id:a.id,empresa_id:e.id,nome_completo:r.nome_admin,email:r.email_admin,telefone:r.telefone_admin,cargo:"Administrador Principal"});return s.success?(sessionStorage.setItem("show_onboarding","true"),sessionStorage.setItem("onboarding_user_name",r.nome_admin),sessionStorage.setItem("onboarding_company_name",r.nome_empresa),{success:!0,empresa:e,usuario:{id:s.usuarioId}}):(await i.from("empresas").delete().eq("id",e.id),{success:!1,error:s.error})}catch(e){return console.error("Erro ao criar empresa:",e),{success:!1,error:"Erro interno do servidor"}}}}export{p as RegistroEmpresaService};
