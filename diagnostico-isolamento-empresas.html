<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico de Isolamento entre Empresas</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        .error-section {
            background: #fff5f5;
            border-left-color: #e53e3e;
        }
        .success-section {
            background: #f0fff4;
            border-left-color: #38a169;
        }
        .warning-section {
            background: #fffaf0;
            border-left-color: #d69e2e;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .user-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .empresa-info {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #3498db;
        }
        .isolation-test {
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #e53e3e;
        }
        .config-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #cbd5e0;
        }
        .config-section input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-family: monospace;
        }
        pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Isolamento entre Empresas</h1>
        
        <div class="config-section">
            <h3>‚öôÔ∏è Configura√ß√£o do Supabase</h3>
            <input type="text" id="supabaseUrl" placeholder="URL do Supabase" value="">
            <input type="password" id="serviceKey" placeholder="Service Role Key" value="">
            <button onclick="initializeSupabase()">üîß Configurar Supabase</button>
        </div>

        <div class="section">
            <h2>üìã Testes Dispon√≠veis</h2>
            <button onclick="listAllUsers()" disabled id="listUsersBtn">üë• 1. Listar Todos os Usu√°rios</button>
            <button onclick="listAllCompanies()" disabled id="listCompaniesBtn">üè¢ 2. Listar Todas as Empresas</button>
            <button onclick="testUserIsolation()" disabled id="testIsolationBtn">üîí 3. Testar Isolamento por Usu√°rio</button>
            <button onclick="testCrossCompanyAccess()" disabled id="testCrossBtn">‚ö†Ô∏è 4. Testar Acesso Entre Empresas</button>
            <button onclick="generateIsolationReport()" disabled id="reportBtn">üìä 5. Gerar Relat√≥rio Completo</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let supabase = null;
        let allUsers = [];
        let allCompanies = [];

        function addMessage(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const messageDiv = document.createElement('div');
            
            let className = 'section';
            if (type === 'success') className = 'section success-section';
            if (type === 'error') className = 'section error-section';
            if (type === 'warning') className = 'section warning-section';
            
            messageDiv.className = className;
            messageDiv.innerHTML = message;
            resultsDiv.appendChild(messageDiv);
            
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function initializeSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('serviceKey').value;

            if (!url || !key) {
                addMessage('‚ùå <strong>Erro:</strong> Preencha URL e Service Role Key', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                addMessage('‚úÖ <strong>Supabase configurado com sucesso!</strong>', 'success');
                
                // Habilitar bot√µes
                document.querySelectorAll('button[disabled]').forEach(btn => {
                    btn.disabled = false;
                });
                
            } catch (error) {
                addMessage(`‚ùå <strong>Erro ao configurar Supabase:</strong> ${error.message}`, 'error');
            }
        }

        async function listAllUsers() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            const btn = document.getElementById('listUsersBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Carregando usu√°rios...';

            try {
                addMessage('üë• <strong>Listando todos os usu√°rios do sistema...</strong>', 'info');
                
                // Buscar todos os usu√°rios da tabela usuarios_empresa
                const { data: usuarios, error: usuariosError } = await supabase
                    .from('usuarios_empresa')
                    .select(`
                        id,
                        user_id,
                        empresa_id,
                        nome_completo,
                        email,
                        tipo_usuario,
                        status,
                        ativo,
                        tem_acesso_sistema,
                        created_at,
                        empresas!inner(nome, cnpj)
                    `)
                    .order('created_at', { ascending: false });

                if (usuariosError) {
                    addMessage(`‚ùå <strong>Erro:</strong> ${usuariosError.message}`, 'error');
                    return;
                }

                allUsers = usuarios || [];
                
                let html = `<h3>üë• Total de usu√°rios encontrados: ${allUsers.length}</h3>`;
                
                if (allUsers.length > 0) {
                    // Agrupar por empresa
                    const usuariosPorEmpresa = {};
                    allUsers.forEach(user => {
                        const empresaId = user.empresa_id;
                        if (!usuariosPorEmpresa[empresaId]) {
                            usuariosPorEmpresa[empresaId] = [];
                        }
                        usuariosPorEmpresa[empresaId].push(user);
                    });

                    html += '<div style="margin-top: 20px;">';
                    Object.keys(usuariosPorEmpresa).forEach(empresaId => {
                        const usuarios = usuariosPorEmpresa[empresaId];
                        const empresa = usuarios[0].empresas;
                        
                        html += `
                            <div class="empresa-info">
                                <h4>üè¢ ${empresa.nome} (${empresa.cnpj})</h4>
                                <p><strong>ID da Empresa:</strong> ${empresaId}</p>
                                <p><strong>Usu√°rios nesta empresa:</strong> ${usuarios.length}</p>
                                
                                <div style="margin-left: 20px;">
                        `;
                        
                        usuarios.forEach(user => {
                            const statusIcon = user.ativo ? '‚úÖ' : '‚ùå';
                            const acessoIcon = user.tem_acesso_sistema ? 'üîì' : 'üîí';
                            
                            html += `
                                <div class="user-card">
                                    <strong>${user.nome_completo}</strong> (${user.email})<br>
                                    <span style="color: #666;">
                                        ${statusIcon} Status: ${user.status} | 
                                        ${acessoIcon} Acesso: ${user.tem_acesso_sistema ? 'Sim' : 'N√£o'} | 
                                        Tipo: ${user.tipo_usuario}
                                    </span><br>
                                    <small>User ID: ${user.user_id || 'N√£o vinculado'}</small>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                    });
                    html += '</div>';
                }
                
                addMessage(html, 'success');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üë• 1. Listar Todos os Usu√°rios';
            }
        }

        async function listAllCompanies() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            const btn = document.getElementById('listCompaniesBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Carregando empresas...';

            try {
                addMessage('üè¢ <strong>Listando todas as empresas...</strong>', 'info');
                
                const { data: empresas, error } = await supabase
                    .from('empresas')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
                    return;
                }

                allCompanies = empresas || [];
                
                let html = `<h3>üè¢ Total de empresas: ${allCompanies.length}</h3>`;
                
                if (allCompanies.length > 0) {
                    html += '<div style="margin-top: 20px;">';
                    allCompanies.forEach(empresa => {
                        html += `
                            <div class="empresa-info">
                                <h4>${empresa.nome}</h4>
                                <p><strong>CNPJ:</strong> ${empresa.cnpj}</p>
                                <p><strong>Email Admin:</strong> ${empresa.email_admin}</p>
                                <p><strong>Status:</strong> ${empresa.status}</p>
                                <p><strong>ID:</strong> ${empresa.id}</p>
                                <p><strong>Criada em:</strong> ${new Date(empresa.created_at).toLocaleString('pt-BR')}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                addMessage(html, 'success');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üè¢ 2. Listar Todas as Empresas';
            }
        }

        async function testUserIsolation() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            const btn = document.getElementById('testIsolationBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testando isolamento...';

            try {
                addMessage('üîí <strong>Testando isolamento de dados por usu√°rio...</strong>', 'info');
                
                // Pegar dois usu√°rios de empresas diferentes
                if (allUsers.length < 2) {
                    await listAllUsers();
                }

                const empresasUnicas = [...new Set(allUsers.map(u => u.empresa_id))];
                
                if (empresasUnicas.length < 2) {
                    addMessage('‚ö†Ô∏è <strong>Aviso:</strong> Apenas uma empresa encontrada. N√£o √© poss√≠vel testar isolamento.', 'warning');
                    return;
                }

                addMessage(`üìä <strong>Empresas detectadas:</strong> ${empresasUnicas.length}`, 'info');
                
                // Testar se cada usu√°rio v√™ apenas funcion√°rios da sua empresa
                for (let i = 0; i < Math.min(2, empresasUnicas.length); i++) {
                    const empresaId = empresasUnicas[i];
                    const usuariosDaEmpresa = allUsers.filter(u => u.empresa_id === empresaId);
                    
                    if (usuariosDaEmpresa.length > 0) {
                        const usuario = usuariosDaEmpresa[0];
                        
                        addMessage(`üîç <strong>Testando isolamento para:</strong> ${usuario.nome_completo} (${usuario.empresas.nome})`, 'info');
                        
                        // Tentar buscar funcion√°rios com o filtro de empresa
                        const { data: funcionarios, error } = await supabase
                            .from('bar_employees')
                            .select('*')
                            .eq('empresa_id', empresaId);

                        if (error) {
                            addMessage(`‚ùå <strong>Erro ao buscar funcion√°rios:</strong> ${error.message}`, 'error');
                        } else {
                            const count = funcionarios?.length || 0;
                            addMessage(`‚úÖ <strong>Funcion√°rios encontrados para ${usuario.empresas.nome}:</strong> ${count}`, 'success');
                            
                            if (count > 0) {
                                let html = '<div style="margin-left: 20px;">';
                                funcionarios.slice(0, 3).forEach(func => {
                                    html += `<div>‚Ä¢ ${func.nome || 'Nome n√£o informado'} (${func.email || 'Email n√£o informado'})</div>`;
                                });
                                if (count > 3) {
                                    html += `<div>... e mais ${count - 3} funcion√°rios</div>`;
                                }
                                html += '</div>';
                                addMessage(html, 'success');
                            }
                        }
                    }
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîí 3. Testar Isolamento por Usu√°rio';
            }
        }

        async function testCrossCompanyAccess() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            const btn = document.getElementById('testCrossBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testando acesso cruzado...';

            try {
                addMessage('‚ö†Ô∏è <strong>Testando se existe vazamento entre empresas...</strong>', 'warning');
                
                if (allUsers.length === 0) {
                    await listAllUsers();
                }

                const empresasUnicas = [...new Set(allUsers.map(u => u.empresa_id))];
                
                if (empresasUnicas.length < 2) {
                    addMessage('‚ö†Ô∏è <strong>Aviso:</strong> Apenas uma empresa. Teste n√£o aplic√°vel.', 'warning');
                    return;
                }

                // Teste: tentar buscar dados de uma empresa usando ID de outra
                const empresa1 = empresasUnicas[0];
                const empresa2 = empresasUnicas[1];
                
                addMessage(`üîç <strong>Testando cruzamento:</strong> Empresa A (${empresa1.slice(0,8)}...) vs Empresa B (${empresa2.slice(0,8)}...)`, 'info');
                
                // Buscar funcion√°rios da empresa1
                const { data: func1, error: err1 } = await supabase
                    .from('bar_employees')
                    .select('*')
                    .eq('empresa_id', empresa1);
                
                // Buscar funcion√°rios da empresa2  
                const { data: func2, error: err2 } = await supabase
                    .from('bar_employees')
                    .select('*')
                    .eq('empresa_id', empresa2);

                if (err1 || err2) {
                    addMessage(`‚ùå <strong>Erro na consulta:</strong> ${err1?.message || err2?.message}`, 'error');
                    return;
                }

                const count1 = func1?.length || 0;
                const count2 = func2?.length || 0;
                
                addMessage(`üìä <strong>Resultados:</strong><br>
                    ‚Ä¢ Empresa A: ${count1} funcion√°rios<br>
                    ‚Ä¢ Empresa B: ${count2} funcion√°rios`, 'info');

                // Verificar se h√° sobreposi√ß√£o (vazamento)
                if (count1 > 0 && count2 > 0) {
                    const emails1 = new Set((func1 || []).map(f => f.email));
                    const emails2 = new Set((func2 || []).map(f => f.email));
                    
                    const overlap = [...emails1].filter(email => emails2.has(email));
                    
                    if (overlap.length > 0) {
                        addMessage(`üö® <strong>VAZAMENTO DETECTADO!</strong><br>
                            Funcion√°rios compartilhados entre empresas: ${overlap.join(', ')}`, 'error');
                    } else {
                        addMessage(`‚úÖ <strong>Isolamento OK!</strong> N√£o h√° funcion√°rios compartilhados.`, 'success');
                    }
                } else {
                    addMessage(`‚úÖ <strong>Isolamento OK!</strong> Empresas t√™m conjuntos separados.`, 'success');
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ö†Ô∏è 4. Testar Acesso Entre Empresas';
            }
        }

        async function generateIsolationReport() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            const btn = document.getElementById('reportBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Gerando relat√≥rio...';

            try {
                addMessage('üìä <strong>Gerando relat√≥rio completo de isolamento...</strong>', 'info');
                
                // Garantir que temos os dados
                if (allUsers.length === 0) await listAllUsers();
                if (allCompanies.length === 0) await listAllCompanies();

                let report = `
                    <h2>üìä Relat√≥rio de Isolamento Multitenant</h2>
                    <p><strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                    
                    <h3>üìà Estat√≠sticas Gerais</h3>
                    <ul>
                        <li><strong>Total de Empresas:</strong> ${allCompanies.length}</li>
                        <li><strong>Total de Usu√°rios:</strong> ${allUsers.length}</li>
                        <li><strong>Usu√°rios com Acesso:</strong> ${allUsers.filter(u => u.tem_acesso_sistema).length}</li>
                        <li><strong>Usu√°rios Ativos:</strong> ${allUsers.filter(u => u.ativo).length}</li>
                    </ul>
                `;

                // An√°lise por empresa
                const empresasUnicas = [...new Set(allUsers.map(u => u.empresa_id))];
                report += `<h3>üè¢ An√°lise por Empresa</h3>`;
                
                for (const empresaId of empresasUnicas) {
                    const usuariosDaEmpresa = allUsers.filter(u => u.empresa_id === empresaId);
                    const empresa = allCompanies.find(e => e.id === empresaId);
                    
                    if (empresa && usuariosDaEmpresa.length > 0) {
                        report += `
                            <div class="empresa-info">
                                <h4>${empresa.nome}</h4>
                                <ul>
                                    <li>ID: ${empresaId.slice(0,8)}...</li>
                                    <li>Usu√°rios: ${usuariosDaEmpresa.length}</li>
                                    <li>Administradores: ${usuariosDaEmpresa.filter(u => u.tipo_usuario === 'administrador').length}</li>
                                    <li>Funcion√°rios: ${usuariosDaEmpresa.filter(u => u.tipo_usuario === 'funcionario').length}</li>
                                </ul>
                            </div>
                        `;
                    }
                }

                // Verifica√ß√µes de seguran√ßa
                report += `<h3>üîí Verifica√ß√µes de Seguran√ßa</h3>`;
                
                // 1. Usu√°rios sem empresa_id
                const usuariosSemEmpresa = allUsers.filter(u => !u.empresa_id);
                if (usuariosSemEmpresa.length > 0) {
                    report += `<div class="isolation-test">‚ö†Ô∏è <strong>Problema:</strong> ${usuariosSemEmpresa.length} usu√°rios sem empresa_id</div>`;
                } else {
                    report += `<div class="success-section">‚úÖ Todos os usu√°rios t√™m empresa_id definido</div>`;
                }

                // 2. Empresas sem usu√°rios
                const empresasSemUsuarios = allCompanies.filter(e => !allUsers.some(u => u.empresa_id === e.id));
                if (empresasSemUsuarios.length > 0) {
                    report += `<div class="warning-section">‚ö†Ô∏è ${empresasSemUsuarios.length} empresas sem usu√°rios</div>`;
                }

                // 3. M√∫ltiplos administradores por empresa
                empresasUnicas.forEach(empresaId => {
                    const admins = allUsers.filter(u => u.empresa_id === empresaId && u.tipo_usuario === 'administrador');
                    if (admins.length > 1) {
                        const empresa = allCompanies.find(e => e.id === empresaId);
                        report += `<div class="warning-section">‚ö†Ô∏è ${empresa?.nome}: ${admins.length} administradores</div>`;
                    }
                });

                report += `
                    <h3>üí° Recomenda√ß√µes</h3>
                    <ul>
                        <li>‚úÖ Implementar verifica√ß√£o de empresa_id em todas as consultas</li>
                        <li>‚úÖ Usar RLS (Row Level Security) no Supabase</li>
                        <li>‚úÖ Validar permiss√µes no backend antes de retornar dados</li>
                        <li>‚úÖ Auditar logs de acesso entre empresas</li>
                        <li>‚úÖ Implementar testes automatizados de isolamento</li>
                    </ul>
                `;

                addMessage(report, 'info');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìä 5. Gerar Relat√≥rio Completo';
            }
        }

        // Carregar configura√ß√µes salvas
        window.addEventListener('load', () => {
            const savedUrl = localStorage.getItem('supabase_url');
            const savedKey = localStorage.getItem('supabase_key');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('serviceKey').value = savedKey;
        });

        // Salvar configura√ß√µes
        document.getElementById('supabaseUrl').addEventListener('change', (e) => {
            localStorage.setItem('supabase_url', e.target.value);
        });
        
        document.getElementById('serviceKey').addEventListener('change', (e) => {
            localStorage.setItem('supabase_key', e.target.value);
        });
    </script>
</body>
</html>