<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug - Database Error</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #c62828;
            text-align: center;
            margin-bottom: 30px;
        }
        .error-section {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .solution-section {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .test-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196f3;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .warning-card {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 1px solid #ff9800;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            padding: 18px 35px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        button:disabled {
            background: linear-gradient(135deg, #cccccc, #999999);
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sql-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug - Database Error</h1>
        
        <div class="error-section">
            <h3>‚ùå Erro Identificado</h3>
            <p><strong>Erro:</strong> "Database error saving new user"</p>
            <p><strong>Local:</strong> Cria√ß√£o de usu√°rio no Supabase Auth</p>
            <p><strong>Causa:</strong> Problema com trigger/fun√ß√£o no banco que executa quando usu√°rio √© criado</p>
            
            <div class="warning-card">
                <h4>üîç Poss√≠veis Causas Espec√≠ficas:</h4>
                <ol>
                    <li><strong>Trigger handle_new_user:</strong> Falha ao criar perfil automaticamente</li>
                    <li><strong>Tabela profiles:</strong> N√£o existe ou estrutura incorreta</li>
                    <li><strong>Fun√ß√£o SQL:</strong> Erro na fun√ß√£o que processa novos usu√°rios</li>
                    <li><strong>Permiss√µes:</strong> Trigger sem permiss√£o para inserir dados</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Diagn√≥sticos</h3>
            <button onclick="testAuthWithoutTrigger()">1Ô∏è‚É£ Testar Auth Sem Trigger</button>
            <button onclick="checkProfilesTable()">2Ô∏è‚É£ Verificar Tabela Profiles</button>
            <button onclick="testMinimalSignup()">3Ô∏è‚É£ Testar Signup M√≠nimo</button>
            <button onclick="checkTriggers()">4Ô∏è‚É£ Verificar Triggers/Fun√ß√µes</button>
        </div>

        <div class="solution-section">
            <h3>üõ†Ô∏è Solu√ß√µes</h3>
            <button onclick="createProfilesTable()">üîß Criar Tabela Profiles</button>
            <button onclick="disableTrigger()">‚ö†Ô∏è Desabilitar Trigger Temporariamente</button>
            <button onclick="testWorkaround()">üöÄ Testar Solu√ß√£o Alternativa</button>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        const supabaseUrl = 'https://wznycskqsavpmejwpksp.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6bnljc2txc2F2cG1landwa3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzA2NjUsImV4cCI6MjA3MjIwNjY2NX0.uYXbBwQDo1pLeBrmtZnBR2M3a3_TsYDa637pcKSVC_8';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        function addMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            let className = 'test-section';
            if (type === 'success') className = 'solution-section';
            if (type === 'error') className = 'error-section';
            if (type === 'warning') className = 'warning-card';
            
            messageDiv.className = className;
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function testAuthWithoutTrigger() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testando Auth...';

            try {
                addMessage('1Ô∏è‚É£ <strong>Testando Auth sem depend√™ncias de trigger...</strong>', 'info');
                
                const testEmail = `no.trigger.${Date.now()}@exemplo.com`;
                const testPassword = 'NoTrigger123@';
                
                // Tentar signup com dados m√≠nimos
                addMessage(`üß™ Tentando criar: ${testEmail}`, 'info');
                
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword
                    // SEM user_metadata para evitar trigger
                });

                if (error) {
                    addMessage(`‚ùå <strong>Erro mesmo sem metadata:</strong> ${error.message}`, 'error');
                    
                    if (error.message.includes('Database error')) {
                        addMessage(`üîç <strong>Confirmado:</strong> Problema √© no banco, n√£o nos dados enviados`, 'error');
                        addMessage(`üí° <strong>Solu√ß√£o:</strong> Precisa corrigir trigger/fun√ß√£o no banco`, 'warning');
                    }
                } else {
                    addMessage(`‚úÖ <strong>Funcionou sem metadata!</strong><br>
                        User ID: ${data.user?.id}<br>
                        Email: ${data.user?.email}`, 'success');
                    
                    // Fazer logout
                    await supabase.auth.signOut();
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '1Ô∏è‚É£ Testar Auth Sem Trigger';
            }
        }

        async function checkProfilesTable() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Verificando profiles...';

            try {
                addMessage('2Ô∏è‚É£ <strong>Verificando se tabela profiles existe...</strong>', 'info');
                
                // Tentar acessar tabela profiles
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        addMessage(`‚ùå <strong>Tabela profiles N√ÉO EXISTE!</strong><br>
                            C√≥digo: ${error.code}<br>
                            Mensagem: ${error.message}`, 'error');
                        
                        addMessage(`üîç <strong>Diagn√≥stico:</strong><br>
                            O trigger handle_new_user tenta inserir na tabela profiles,<br>
                            mas ela n√£o existe, causando o erro "Database error saving new user"`, 'error');
                        
                        addMessage(`
                            <h4>üõ†Ô∏è SQL para criar a tabela profiles:</h4>
                            <div class="sql-block">
-- Criar tabela profiles
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    role TEXT DEFAULT 'employee',
    avatar_url TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Criar pol√≠tica permissiva
CREATE POLICY "Allow all operations" ON public.profiles
FOR ALL USING (true);

-- Criar √≠ndices
CREATE INDEX IF NOT EXISTS profiles_id_idx ON public.profiles(id);
                            </div>
                        `, 'error');
                    } else {
                        addMessage(`‚ùå <strong>Erro ao acessar profiles:</strong> ${error.message}`, 'error');
                    }
                } else {
                    addMessage(`‚úÖ <strong>Tabela profiles existe!</strong> Encontrados ${data.length} registros`, 'success');
                    
                    if (data.length > 0) {
                        addMessage(`<h4>üìã Estrutura da tabela:</h4><pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'success');
                    }
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '2Ô∏è‚É£ Verificar Tabela Profiles';
            }
        }

        async function testMinimalSignup() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testando signup...';

            try {
                addMessage('3Ô∏è‚É£ <strong>Testando signup com diferentes configura√ß√µes...</strong>', 'info');
                
                const testCases = [
                    {
                        name: 'Sem metadata',
                        email: `minimal1.${Date.now()}@exemplo.com`,
                        config: {}
                    },
                    {
                        name: 'S√≥ com name',
                        email: `minimal2.${Date.now()}@exemplo.com`,
                        config: {
                            options: {
                                data: { name: 'Teste M√≠nimo' }
                            }
                        }
                    },
                    {
                        name: 'Com emailRedirectTo',
                        email: `minimal3.${Date.now()}@exemplo.com`,
                        config: {
                            options: {
                                emailRedirectTo: window.location.origin
                            }
                        }
                    }
                ];

                for (const testCase of testCases) {
                    addMessage(`üß™ Testando: ${testCase.name}`, 'info');
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: testCase.email,
                        password: 'TestMinimal123@',
                        ...testCase.config
                    });

                    if (error) {
                        addMessage(`‚ùå ${testCase.name}: ${error.message}`, 'error');
                    } else {
                        addMessage(`‚úÖ ${testCase.name}: Funcionou! User ID: ${data.user?.id}`, 'success');
                        
                        // Fazer logout
                        await supabase.auth.signOut();
                        break; // Se um funcionou, n√£o precisa testar os outros
                    }
                    
                    // Aguardar entre testes
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '3Ô∏è‚É£ Testar Signup M√≠nimo';
            }
        }

        async function checkTriggers() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Verificando triggers...';

            try {
                addMessage('4Ô∏è‚É£ <strong>Verificando triggers e fun√ß√µes...</strong>', 'info');
                
                addMessage(`
                    <h4>üîç Triggers Comuns que Causam Este Erro:</h4>
                    <ol>
                        <li><strong>handle_new_user:</strong> Cria perfil automaticamente</li>
                        <li><strong>on_auth_user_created:</strong> Processa novos usu√°rios</li>
                        <li><strong>create_profile_for_new_user:</strong> Insere na tabela profiles</li>
                    </ol>
                    
                    <h4>üí° Como Verificar no Dashboard:</h4>
                    <ol>
                        <li>Acesse o <strong>Supabase Dashboard</strong></li>
                        <li>V√° para <strong>Database</strong> ‚Üí <strong>Functions</strong></li>
                        <li>Procure por fun√ß√µes relacionadas a "user" ou "profile"</li>
                        <li>V√° para <strong>Database</strong> ‚Üí <strong>Triggers</strong></li>
                        <li>Procure por triggers na tabela <strong>auth.users</strong></li>
                    </ol>
                    
                    <h4>üõ†Ô∏è Solu√ß√µes Poss√≠veis:</h4>
                    <ul>
                        <li><strong>Criar tabela profiles:</strong> Se o trigger precisa dela</li>
                        <li><strong>Corrigir fun√ß√£o:</strong> Se h√° erro na l√≥gica SQL</li>
                        <li><strong>Desabilitar trigger:</strong> Temporariamente para testar</li>
                        <li><strong>Usar service role:</strong> Para bypass de algumas valida√ß√µes</li>
                    </ul>
                `, 'warning');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '4Ô∏è‚É£ Verificar Triggers/Fun√ß√µes';
            }
        }

        async function createProfilesTable() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Criando tabela...';

            try {
                addMessage('üîß <strong>Tentando criar tabela profiles...</strong>', 'info');
                
                addMessage(`
                    <h4>‚ùå N√£o √© poss√≠vel criar tabelas via JavaScript</h4>
                    <p>Para criar a tabela profiles, voc√™ precisa:</p>
                    <ol>
                        <li>Acessar o <strong>Supabase Dashboard</strong></li>
                        <li>Ir para <strong>SQL Editor</strong></li>
                        <li>Executar o SQL abaixo:</li>
                    </ol>
                    
                    <div class="sql-block">
-- Criar tabela profiles
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    role TEXT DEFAULT 'employee',
    avatar_url TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Criar pol√≠tica permissiva para desenvolvimento
CREATE POLICY "Allow all operations for development" ON public.profiles
FOR ALL USING (true);

-- Criar √≠ndices
CREATE INDEX IF NOT EXISTS profiles_id_idx ON public.profiles(id);

-- Verificar se funcionou
SELECT * FROM public.profiles LIMIT 1;
                    </div>
                    
                    <p><strong>Ap√≥s executar o SQL, teste novamente a cria√ß√£o de funcion√°rios.</strong></p>
                `, 'warning');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîß Criar Tabela Profiles';
            }
        }

        async function disableTrigger() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Desabilitando trigger...';

            try {
                addMessage('‚ö†Ô∏è <strong>Instru√ß√µes para desabilitar trigger...</strong>', 'warning');
                
                addMessage(`
                    <h4>‚ö†Ô∏è Como Desabilitar Trigger Temporariamente</h4>
                    <p>Execute no <strong>SQL Editor</strong> do Supabase:</p>
                    
                    <div class="sql-block">
-- Listar triggers existentes
SELECT trigger_name, event_object_table, action_statement 
FROM information_schema.triggers 
WHERE event_object_schema = 'auth' 
AND event_object_table = 'users';

-- Desabilitar trigger espec√≠fico (substitua NOME_DO_TRIGGER)
ALTER TABLE auth.users DISABLE TRIGGER handle_new_user;

-- Ou desabilitar todos os triggers da tabela users
ALTER TABLE auth.users DISABLE TRIGGER ALL;

-- Para reabilitar depois:
-- ALTER TABLE auth.users ENABLE TRIGGER handle_new_user;
-- ALTER TABLE auth.users ENABLE TRIGGER ALL;
                    </div>
                    
                    <p><strong>‚ö†Ô∏è CUIDADO:</strong> Desabilitar triggers pode afetar outras funcionalidades.</p>
                    <p><strong>üí° RECOMENDA√á√ÉO:</strong> Melhor criar a tabela profiles primeiro.</p>
                `, 'warning');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ö†Ô∏è Desabilitar Trigger Temporariamente';
            }
        }

        async function testWorkaround() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testando solu√ß√£o...';

            try {
                addMessage('üöÄ <strong>Testando solu√ß√£o alternativa...</strong>', 'info');
                
                addMessage(`
                    <h3>üöÄ Solu√ß√£o Alternativa Recomendada</h3>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #2e7d32; margin-top: 0;">üí° Estrat√©gia:</h4>
                        <ol>
                            <li><strong>Criar tabela profiles</strong> no Dashboard</li>
                            <li><strong>Testar signup simples</strong> para confirmar que funciona</li>
                            <li><strong>Modificar servi√ßo</strong> para lidar com erros de trigger</li>
                            <li><strong>Implementar fallback</strong> se Auth falhar</li>
                        </ol>
                        
                        <h4 style="color: #2e7d32;">üîß Passos Imediatos:</h4>
                        <ol>
                            <li>Execute o SQL para criar tabela profiles</li>
                            <li>Teste cria√ß√£o de funcion√°rio novamente</li>
                            <li>Se ainda falhar, desabilite trigger temporariamente</li>
                        </ol>
                    </div>
                    
                    <h4>üìã SQL Completo para Copiar:</h4>
                    <div class="sql-block">
-- 1. Criar tabela profiles
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    role TEXT DEFAULT 'employee',
    avatar_url TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Configurar RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 3. Pol√≠tica permissiva para desenvolvimento
CREATE POLICY "Allow all for development" ON public.profiles FOR ALL USING (true);

-- 4. √çndices
CREATE INDEX IF NOT EXISTS profiles_id_idx ON public.profiles(id);

-- 5. Testar
INSERT INTO public.profiles (id, name, role) 
VALUES ('00000000-0000-0000-0000-000000000000', 'Teste', 'employee');

DELETE FROM public.profiles WHERE id = '00000000-0000-0000-0000-000000000000';

-- 6. Verificar triggers
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE event_object_schema = 'auth' AND event_object_table = 'users';
                    </div>
                `, 'success');

            } catch (error) {
                addMessage(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Testar Solu√ß√£o Alternativa';
            }
        }
    </script>
</body>
</html>