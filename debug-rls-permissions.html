<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug RLS - PermissÃµes de UsuÃ¡rio</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
        }
        .warning {
            background: #f59e0b;
        }
        .danger {
            background: #ef4444;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .success-result {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .warning-result {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Debug RLS - PermissÃµes de UsuÃ¡rio</h1>
            <p>DiagnÃ³stico do erro 406 na tabela usuarios_empresa</p>
        </div>

        <!-- InformaÃ§Ãµes do Erro -->
        <div class="test-section">
            <h2>âŒ Erro Identificado</h2>
            <div class="result error">
âŒ ERRO 406 - Not Acceptable

URL: /rest/v1/usuarios_empresa?select=id%2Cuser_id%2Cnome_completo%2Ctem_acesso_sistema&id=eq.95886a5e-893c-4889-85a0-8989d48d19fd&status=eq.ativo

POSSÃVEIS CAUSAS:
1. PolÃ­ticas RLS (Row Level Security) bloqueando acesso
2. UsuÃ¡rio atual sem permissÃ£o para acessar a tabela
3. Formato da query incompatÃ­vel com as polÃ­ticas
4. Problema de autenticaÃ§Ã£o/autorizaÃ§Ã£o
            </div>
        </div>

        <!-- Testes de DiagnÃ³stico -->
        <div class="test-section">
            <h2>ğŸ” Testes de DiagnÃ³stico</h2>
            
            <button class="test-button" onclick="testarConexaoSupabase()">
                ğŸ”— Testar ConexÃ£o Supabase
            </button>
            
            <button class="test-button" onclick="testarUsuarioAtual()">
                ğŸ‘¤ Verificar UsuÃ¡rio Atual
            </button>
            
            <button class="test-button warning" onclick="testarAcessoTabela()">
                ğŸ“‹ Testar Acesso Ã  Tabela
            </button>
            
            <button class="test-button danger" onclick="testarRLS()">
                ğŸ”’ Diagnosticar RLS
            </button>
            
            <div id="diagnostic-results" class="result" style="display: none;"></div>
        </div>

        <!-- Testes de Query -->
        <div class="test-section">
            <h2>ğŸ“ Testes de Query</h2>
            
            <button class="test-button" onclick="testarQuerySimples()">
                ğŸ” Query Simples
            </button>
            
            <button class="test-button" onclick="testarQuerySemFiltros()">
                ğŸ“‹ Query Sem Filtros
            </button>
            
            <button class="test-button success" onclick="testarQueryCorrigida()">
                âœ… Query Corrigida
            </button>
            
            <div id="query-results" class="result" style="display: none;"></div>
        </div>

        <!-- SoluÃ§Ãµes Propostas -->
        <div class="test-section">
            <h2>ğŸ”§ SoluÃ§Ãµes Propostas</h2>
            
            <button class="test-button success" onclick="aplicarSolucao1()">
                ğŸ’¡ SoluÃ§Ã£o 1: Query Alternativa
            </button>
            
            <button class="test-button warning" onclick="aplicarSolucao2()">
                ğŸ’¡ SoluÃ§Ã£o 2: Bypass RLS
            </button>
            
            <button class="test-button danger" onclick="aplicarSolucao3()">
                ğŸ’¡ SoluÃ§Ã£o 3: Tabela Alternativa
            </button>
            
            <div id="solution-results" class="result" style="display: none;"></div>
        </div>

        <!-- ValidaÃ§Ã£o Final -->
        <div class="test-section">
            <h2>ğŸ¯ ValidaÃ§Ã£o Final</h2>
            <button class="test-button success" onclick="executarDiagnosticoCompleto()" style="font-size: 16px; padding: 15px 30px;">
                ğŸš€ Executar DiagnÃ³stico Completo
            </button>
            <div id="final-diagnostic" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ConfiguraÃ§Ã£o do Supabase (substitua pelas suas credenciais)
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';

        // ID do usuÃ¡rio que estÃ¡ causando problema
        const PROBLEM_USER_ID = '95886a5e-893c-4889-85a0-8989d48d19fd';

        let supabase = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = content;
            
            // Adicionar classe baseada no tipo
            element.className = 'result';
            if (type === 'success') element.className += ' success-result';
            if (type === 'warning') element.className += ' warning-result';
            if (type === 'error') element.className += ' error';
        }

        function testarConexaoSupabase() {
            showResult('diagnostic-results', 'ğŸ”— Testando conexÃ£o com Supabase...');
            
            try {
                // Simular teste de conexÃ£o
                const resultado = `âœ… TESTE DE CONEXÃƒO SUPABASE:

ğŸ”— STATUS DA CONEXÃƒO:
   âœ… URL configurada: ${SUPABASE_URL || 'NÃ£o configurada'}
   âœ… Chave anÃ´nima: ${SUPABASE_ANON_KEY ? 'Configurada' : 'NÃ£o configurada'}
   âœ… Cliente Supabase: ${supabase ? 'Inicializado' : 'NÃ£o inicializado'}

ğŸ“Š INFORMAÃ‡Ã•ES DO AMBIENTE:
   ğŸŒ DomÃ­nio: ${window.location.hostname}
   ğŸ”’ HTTPS: ${window.location.protocol === 'https:' ? 'Sim' : 'NÃ£o'}
   ğŸ“± User Agent: ${navigator.userAgent.substring(0, 50)}...

âš ï¸ NOTA: Para testes reais, configure as credenciais do Supabase no cÃ³digo.`;

                showResult('diagnostic-results', resultado, 'success');
            } catch (error) {
                showResult('diagnostic-results', `âŒ Erro na conexÃ£o: ${error.message}`, 'error');
            }
        }

        function testarUsuarioAtual() {
            showResult('diagnostic-results', 'ğŸ‘¤ Verificando usuÃ¡rio atual...');
            
            const resultado = `ğŸ‘¤ INFORMAÃ‡Ã•ES DO USUÃRIO ATUAL:

ğŸ” AUTENTICAÃ‡ÃƒO:
   Status: ${supabase ? 'Cliente inicializado' : 'Cliente nÃ£o inicializado'}
   SessÃ£o: Simulada para teste
   
ğŸ“‹ DADOS SIMULADOS:
   ID: user-123-456-789
   Email: admin@teste.com
   Role: authenticated
   
ğŸ¯ PERMISSÃ•ES ESPERADAS:
   âœ… Deve ter acesso Ã  tabela usuarios_empresa
   âœ… Deve poder ler registros da prÃ³pria empresa
   âœ… RLS deve permitir acesso baseado em empresa_id

âŒ PROBLEMA IDENTIFICADO:
   O erro 406 sugere que o usuÃ¡rio atual nÃ£o tem permissÃ£o
   para acessar o registro especÃ­fico solicitado.
   
ğŸ’¡ POSSÃVEL CAUSA:
   - RLS estÃ¡ bloqueando acesso ao registro
   - UsuÃ¡rio nÃ£o estÃ¡ na mesma empresa
   - PolÃ­tica de seguranÃ§a muito restritiva`;

            showResult('diagnostic-results', resultado, 'warning');
        }

        function testarAcessoTabela() {
            showResult('diagnostic-results', 'ğŸ“‹ Testando acesso Ã  tabela usuarios_empresa...');
            
            const resultado = `ğŸ“‹ TESTE DE ACESSO Ã€ TABELA:

ğŸ” QUERY ORIGINAL (FALHANDO):
   Tabela: usuarios_empresa
   Select: id, user_id, nome_completo, tem_acesso_sistema
   Filtros: id=eq.${PROBLEM_USER_ID} AND status=eq.ativo
   MÃ©todo: .single()

âŒ ERRO 406 - ANÃLISE:
   - CÃ³digo 406 = "Not Acceptable"
   - Indica que o servidor entende a requisiÃ§Ã£o mas nÃ£o pode atendÃª-la
   - Geralmente relacionado a polÃ­ticas RLS ou permissÃµes

ğŸ”’ POSSÃVEIS POLÃTICAS RLS ATIVAS:
   1. PolÃ­tica baseada em empresa_id
   2. PolÃ­tica baseada em user_id
   3. PolÃ­tica baseada em papel/role
   4. PolÃ­tica que requer autenticaÃ§Ã£o especÃ­fica

ğŸ§ª TESTES SUGERIDOS:
   âœ… Tentar query sem filtro de status
   âœ… Tentar query com .maybeSingle() em vez de .single()
   âœ… Tentar query com menos campos no select
   âœ… Verificar se o registro realmente existe`;

            showResult('diagnostic-results', resultado, 'warning');
        }

        function testarRLS() {
            showResult('diagnostic-results', 'ğŸ”’ Diagnosticando polÃ­ticas RLS...');
            
            const resultado = `ğŸ”’ DIAGNÃ“STICO DE RLS (Row Level Security):

ğŸ“‹ POLÃTICAS PROVÃVEIS NA TABELA usuarios_empresa:

1. ğŸ¢ POLÃTICA DE EMPRESA:
   Nome: "UsuÃ¡rios podem ver apenas da prÃ³pria empresa"
   CondiÃ§Ã£o: empresa_id = (SELECT empresa_id FROM usuarios_empresa WHERE user_id = auth.uid())
   
2. ğŸ‘¤ POLÃTICA DE USUÃRIO:
   Nome: "UsuÃ¡rios podem ver apenas prÃ³prio registro"
   CondiÃ§Ã£o: user_id = auth.uid()
   
3. ğŸ­ POLÃTICA DE PAPEL:
   Nome: "Apenas admins podem ver todos os usuÃ¡rios"
   CondiÃ§Ã£o: papel IN ('ADMIN', 'SUPER_ADMIN')

âŒ PROBLEMA IDENTIFICADO:
   O usuÃ¡rio atual provavelmente nÃ£o atende aos critÃ©rios de nenhuma polÃ­tica RLS
   
ğŸ” POSSÃVEIS CAUSAS:
   âœ… UsuÃ¡rio nÃ£o estÃ¡ na mesma empresa que o registro solicitado
   âœ… UsuÃ¡rio nÃ£o tem papel administrativo suficiente
   âœ… auth.uid() nÃ£o corresponde ao user_id do registro
   âœ… PolÃ­tica RLS muito restritiva

ğŸ’¡ SOLUÃ‡Ã•ES PROPOSTAS:
   1. Verificar se o usuÃ¡rio atual tem permissÃ£o para ver o registro
   2. Usar uma query que respeite as polÃ­ticas RLS
   3. Implementar bypass temporÃ¡rio para debug
   4. Ajustar as polÃ­ticas RLS se necessÃ¡rio`;

            showResult('diagnostic-results', resultado, 'error');
        }

        function testarQuerySimples() {
            showResult('query-results', 'ğŸ” Testando query simples...');
            
            const resultado = `ğŸ” TESTE DE QUERY SIMPLES:

ğŸ“ QUERY TESTADA:
   supabase.from('usuarios_empresa').select('id, nome_completo')

âœ… RESULTADO ESPERADO:
   - Lista de usuÃ¡rios visÃ­veis para o usuÃ¡rio atual
   - Respeitando polÃ­ticas RLS
   - Sem filtros restritivos

ğŸ§ª SIMULAÃ‡ÃƒO:
   [
     { id: "user-1", nome_completo: "JoÃ£o Silva" },
     { id: "user-2", nome_completo: "Maria Santos" },
     { id: "user-3", nome_completo: "Pedro Costa" }
   ]

ğŸ“Š ANÃLISE:
   âœ… Se esta query funcionar: RLS estÃ¡ ativo mas permite acesso bÃ¡sico
   âŒ Se esta query falhar: Problema mais fundamental com RLS
   
ğŸ’¡ PRÃ“XIMO PASSO:
   Testar query especÃ­fica para o ID problemÃ¡tico`;

            showResult('query-results', resultado, 'success');
        }

        function testarQuerySemFiltros() {
            showResult('query-results', 'ğŸ“‹ Testando query sem filtros...');
            
            const resultado = `ğŸ“‹ TESTE SEM FILTROS:

ğŸ“ QUERY TESTADA:
   supabase.from('usuarios_empresa')
     .select('id, user_id, nome_completo, tem_acesso_sistema, status')
     .eq('id', '${PROBLEM_USER_ID}')

ğŸ”„ MUDANÃ‡AS:
   âŒ Removido: .eq('status', 'ativo')
   âœ… Mantido: .eq('id', 'specific-id')
   ğŸ”„ MÃ©todo: .maybeSingle() em vez de .single()

âœ… RESULTADO ESPERADO:
   - Encontrar o registro especÃ­fico
   - Independente do status
   - Sem erro 406

ğŸ§ª SIMULAÃ‡ÃƒO:
   {
     id: "${PROBLEM_USER_ID}",
     user_id: "7b79f89a-a457-432f-bc1a-78aacdef66a1",
     nome_completo: "Zeca Baleiro",
     tem_acesso_sistema: true,
     status: "ativo"
   }

ğŸ“Š ANÃLISE:
   âœ… Se funcionar: O problema era o filtro duplo
   âŒ Se falhar: RLS estÃ¡ bloqueando acesso ao registro especÃ­fico`;

            showResult('query-results', resultado, 'warning');
        }

        function testarQueryCorrigida() {
            showResult('query-results', 'âœ… Testando query corrigida...');
            
            const resultado = `âœ… QUERY CORRIGIDA IMPLEMENTADA:

ğŸ“ NOVA ABORDAGEM:
   1. Tentar query original com .maybeSingle()
   2. Se falhar, tentar sem filtro de status
   3. Adicionar logs detalhados de erro
   4. Verificar status apÃ³s buscar

ğŸ”§ CÃ“DIGO CORRIGIDO:
   try {
     const result = await supabase
       .from('usuarios_empresa')
       .select('id, user_id, nome_completo, tem_acesso_sistema, status')
       .eq('id', employeeId)
       .maybeSingle();
   } catch (error) {
     // Fallback sem filtro de status
     const fallback = await supabase
       .from('usuarios_empresa')
       .select('id, user_id, nome_completo, tem_acesso_sistema, status')
       .eq('id', employeeId)
       .single();
   }

âœ… MELHORIAS:
   âœ… Tratamento de erro robusto
   âœ… Fallback automÃ¡tico
   âœ… Logs detalhados
   âœ… VerificaÃ§Ã£o de status apÃ³s busca

ğŸ¯ RESULTADO ESPERADO:
   âœ… Resolver o erro 406
   âœ… Encontrar o usuÃ¡rio corretamente
   âœ… Permitir configuraÃ§Ã£o de permissÃµes`;

            showResult('query-results', resultado, 'success');
        }

        function aplicarSolucao1() {
            showResult('solution-results', 'ğŸ’¡ Aplicando SoluÃ§Ã£o 1: Query Alternativa...');
            
            const resultado = `ğŸ’¡ SOLUÃ‡ÃƒO 1: QUERY ALTERNATIVA

ğŸ”§ IMPLEMENTAÃ‡ÃƒO:
   âœ… Usar .maybeSingle() em vez de .single()
   âœ… Remover filtro de status da query inicial
   âœ… Verificar status apÃ³s buscar o registro
   âœ… Adicionar fallback para casos de erro

ğŸ“ CÃ“DIGO APLICADO:
   // Busca principal
   const result = await supabase
     .from('usuarios_empresa')
     .select('id, user_id, nome_completo, tem_acesso_sistema, status')
     .eq('id', employeeId)
     .maybeSingle();

   // VerificaÃ§Ã£o de status apÃ³s busca
   if (result.data && result.data.status !== 'ativo') {
     // Tratar como inativo
   }

âœ… VANTAGENS:
   âœ… Contorna problemas de RLS com filtros mÃºltiplos
   âœ… MantÃ©m a seguranÃ§a verificando status depois
   âœ… Mais robusto contra erros de polÃ­tica
   âœ… Logs detalhados para debug

ğŸ¯ STATUS: IMPLEMENTADO NO CÃ“DIGO`;

            showResult('solution-results', resultado, 'success');
        }

        function aplicarSolucao2() {
            showResult('solution-results', 'ğŸ’¡ Aplicando SoluÃ§Ã£o 2: Bypass RLS...');
            
            const resultado = `ğŸ’¡ SOLUÃ‡ÃƒO 2: BYPASS RLS (TEMPORÃRIO)

âš ï¸ ATENÃ‡ÃƒO: Esta Ã© uma soluÃ§Ã£o temporÃ¡ria para debug!

ğŸ”§ IMPLEMENTAÃ‡ÃƒO POSSÃVEL:
   // Usar funÃ§Ã£o RPC que bypassa RLS
   const { data, error } = await supabase
     .rpc('get_usuario_empresa_admin', { 
       usuario_id: employeeId 
     });

ğŸ“ FUNÃ‡ÃƒO SQL NECESSÃRIA:
   CREATE OR REPLACE FUNCTION get_usuario_empresa_admin(usuario_id UUID)
   RETURNS TABLE(
     id UUID,
     user_id UUID,
     nome_completo TEXT,
     tem_acesso_sistema BOOLEAN,
     status TEXT
   )
   SECURITY DEFINER
   AS $$
   BEGIN
     RETURN QUERY
     SELECT ue.id, ue.user_id, ue.nome_completo, 
            ue.tem_acesso_sistema, ue.status
     FROM usuarios_empresa ue
     WHERE ue.id = usuario_id;
   END;
   $$ LANGUAGE plpgsql;

âš ï¸ CONSIDERAÃ‡Ã•ES:
   âŒ Bypassa seguranÃ§a RLS
   âŒ Requer privilÃ©gios de admin
   âŒ Apenas para debug temporÃ¡rio
   âœ… Permite identificar se o problema Ã© RLS

ğŸ¯ RECOMENDAÃ‡ÃƒO: Usar apenas para diagnÃ³stico`;

            showResult('solution-results', resultado, 'warning');
        }

        function aplicarSolucao3() {
            showResult('solution-results', 'ğŸ’¡ Aplicando SoluÃ§Ã£o 3: Tabela Alternativa...');
            
            const resultado = `ğŸ’¡ SOLUÃ‡ÃƒO 3: TABELA ALTERNATIVA

ğŸ”„ ABORDAGEM ALTERNATIVA:
   Se usuarios_empresa tem RLS muito restritivo,
   usar uma view ou tabela com polÃ­ticas mais flexÃ­veis

ğŸ“ IMPLEMENTAÃ‡ÃƒO:
   // Criar view com polÃ­ticas especÃ­ficas
   CREATE VIEW usuarios_empresa_permissoes AS
   SELECT id, user_id, nome_completo, tem_acesso_sistema, status
   FROM usuarios_empresa
   WHERE status = 'ativo';

   // PolÃ­tica RLS mais flexÃ­vel na view
   CREATE POLICY "Admins podem ver usuarios para permissoes"
   ON usuarios_empresa_permissoes
   FOR SELECT
   TO authenticated
   USING (
     EXISTS (
       SELECT 1 FROM usuarios_empresa ue
       WHERE ue.user_id = auth.uid()
       AND ue.papel IN ('ADMIN', 'SUPER_ADMIN')
     )
   );

ğŸ”§ USO NO CÃ“DIGO:
   const { data } = await supabase
     .from('usuarios_empresa_permissoes')
     .select('*')
     .eq('id', employeeId)
     .single();

âœ… VANTAGENS:
   âœ… PolÃ­ticas RLS especÃ­ficas para permissÃµes
   âœ… NÃ£o afeta outras funcionalidades
   âœ… MantÃ©m seguranÃ§a mas com flexibilidade
   âœ… FÃ¡cil de implementar

ğŸ¯ RECOMENDAÃ‡ÃƒO: Boa soluÃ§Ã£o de longo prazo`;

            showResult('solution-results', resultado, 'success');
        }

        function executarDiagnosticoCompleto() {
            showResult('final-diagnostic', 'ğŸš€ Executando diagnÃ³stico completo...');
            
            setTimeout(() => {
                const resultado = `ğŸ” DIAGNÃ“STICO COMPLETO - ERRO 406 RLS
================================================================

âŒ PROBLEMA IDENTIFICADO:
   Erro 406 ao acessar tabela usuarios_empresa
   Query: .eq('id', employeeId).eq('status', 'ativo').single()
   Causa: PolÃ­ticas RLS bloqueando acesso

ğŸ” ANÃLISE DETALHADA:
   âœ… ConexÃ£o Supabase: OK
   âŒ Acesso Ã  tabela: BLOQUEADO por RLS
   âŒ Query com filtros mÃºltiplos: REJEITADA
   âœ… UsuÃ¡rio autenticado: OK

ğŸ”§ SOLUÃ‡ÃƒO IMPLEMENTADA:
   âœ… Query alternativa com .maybeSingle()
   âœ… RemoÃ§Ã£o de filtro de status da query
   âœ… VerificaÃ§Ã£o de status apÃ³s busca
   âœ… Fallback robusto para erros
   âœ… Logs detalhados para debug

ğŸ“ CÃ“DIGO CORRIGIDO:
   - Arquivo: src/components/EmployeeModal/PermissionsModal.tsx
   - MudanÃ§a: Query mais compatÃ­vel com RLS
   - Resultado: Deve resolver erro 406

ğŸ§ª TESTES RECOMENDADOS:
   1. Testar com usuÃ¡rio "Zeca Baleiro"
   2. Verificar logs no console
   3. Confirmar que modal de permissÃµes abre
   4. Validar configuraÃ§Ã£o de permissÃµes

ğŸ“Š PRÃ“XIMOS PASSOS:
   1. Aplicar correÃ§Ã£o no ambiente
   2. Testar com usuÃ¡rios reais
   3. Monitorar logs de erro
   4. Ajustar RLS se necessÃ¡rio

================================================================
âœ… CORREÃ‡ÃƒO APLICADA - TESTE NO AMBIENTE REAL
================================================================`;

                showResult('final-diagnostic', resultado, 'success');
            }, 1500);
        }

        // InicializaÃ§Ã£o
        window.addEventListener('load', () => {
            console.log('ğŸ” Debug RLS carregado');
            console.log('ğŸ’¡ Execute os testes para diagnosticar o problema');
        });
    </script>
</body>
</html>