<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Debug RLS - Permissões de Usuário</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
        }
        .warning {
            background: #f59e0b;
        }
        .danger {
            background: #ef4444;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .success-result {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .warning-result {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 Debug RLS - Permissões de Usuário</h1>
            <p>Diagnóstico do erro 406 na tabela usuarios_empresa</p>
        </div>

        <!-- Informações do Erro -->
        <div class="test-section">
            <h2>❌ Erro Identificado</h2>
            <div class="result error">
❌ ERRO 406 - Not Acceptable

URL: /rest/v1/usuarios_empresa?select=id%2Cuser_id%2Cnome_completo%2Ctem_acesso_sistema&id=eq.95886a5e-893c-4889-85a0-8989d48d19fd&status=eq.ativo

POSSÍVEIS CAUSAS:
1. Políticas RLS (Row Level Security) bloqueando acesso
2. Usuário atual sem permissão para acessar a tabela
3. Formato da query incompatível com as políticas
4. Problema de autenticação/autorização
            </div>
        </div>

        <!-- Testes de Diagnóstico -->
        <div class="test-section">
            <h2>🔍 Testes de Diagnóstico</h2>
            
            <button class="test-button" onclick="testarConexaoSupabase()">
                🔗 Testar Conexão Supabase
            </button>
            
            <button class="test-button" onclick="testarUsuarioAtual()">
                👤 Verificar Usuário Atual
            </button>
            
            <button class="test-button warning" onclick="testarAcessoTabela()">
                📋 Testar Acesso à Tabela
            </button>
            
            <button class="test-button danger" onclick="testarRLS()">
                🔒 Diagnosticar RLS
            </button>
            
            <div id="diagnostic-results" class="result" style="display: none;"></div>
        </div>

        <!-- Testes de Query -->
        <div class="test-section">
            <h2>📝 Testes de Query</h2>
            
            <button class="test-button" onclick="testarQuerySimples()">
                🔍 Query Simples
            </button>
            
            <button class="test-button" onclick="testarQuerySemFiltros()">
                📋 Query Sem Filtros
            </button>
            
            <button class="test-button success" onclick="testarQueryCorrigida()">
                ✅ Query Corrigida
            </button>
            
            <div id="query-results" class="result" style="display: none;"></div>
        </div>

        <!-- Soluções Propostas -->
        <div class="test-section">
            <h2>🔧 Soluções Propostas</h2>
            
            <button class="test-button success" onclick="aplicarSolucao1()">
                💡 Solução 1: Query Alternativa
            </button>
            
            <button class="test-button warning" onclick="aplicarSolucao2()">
                💡 Solução 2: Bypass RLS
            </button>
            
            <button class="test-button danger" onclick="aplicarSolucao3()">
                💡 Solução 3: Tabela Alternativa
            </button>
            
            <div id="solution-results" class="result" style="display: none;"></div>
        </div>

        <!-- Validação Final -->
        <div class="test-section">
            <h2>🎯 Validação Final</h2>
            <button class="test-button success" onclick="executarDiagnosticoCompleto()" style="font-size: 16px; padding: 15px 30px;">
                🚀 Executar Diagnóstico Completo
            </button>
            <div id="final-diagnostic" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuração do Supabase (substitua pelas suas credenciais)
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';

        // ID do usuário que está causando problema
        const PROBLEM_USER_ID = '95886a5e-893c-4889-85a0-8989d48d19fd';

        let supabase = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = content;
            
            // Adicionar classe baseada no tipo
            element.className = 'result';
            if (type === 'success') element.className += ' success-result';
            if (type === 'warning') element.className += ' warning-result';
            if (type === 'error') element.className += ' error';
        }

        function testarConexaoSupabase() {
            showResult('diagnostic-results', '🔗 Testando conexão com Supabase...');
            
            try {
                // Simular teste de conexão
                const resultado = `✅ TESTE DE CONEXÃO SUPABASE:

🔗 STATUS DA CONEXÃO:
   ✅ URL configurada: ${SUPABASE_URL || 'Não configurada'}
   ✅ Chave anônima: ${SUPABASE_ANON_KEY ? 'Configurada' : 'Não configurada'}
   ✅ Cliente Supabase: ${supabase ? 'Inicializado' : 'Não inicializado'}

📊 INFORMAÇÕES DO AMBIENTE:
   🌐 Domínio: ${window.location.hostname}
   🔒 HTTPS: ${window.location.protocol === 'https:' ? 'Sim' : 'Não'}
   📱 User Agent: ${navigator.userAgent.substring(0, 50)}...

⚠️ NOTA: Para testes reais, configure as credenciais do Supabase no código.`;

                showResult('diagnostic-results', resultado, 'success');
            } catch (error) {
                showResult('diagnostic-results', `❌ Erro na conexão: ${error.message}`, 'error');
            }
        }

        function testarUsuarioAtual() {
            showResult('diagnostic-results', '👤 Verificando usuário atual...');
            
            const resultado = `👤 INFORMAÇÕES DO USUÁRIO ATUAL:

🔐 AUTENTICAÇÃO:
   Status: ${supabase ? 'Cliente inicializado' : 'Cliente não inicializado'}
   Sessão: Simulada para teste
   
📋 DADOS SIMULADOS:
   ID: user-123-456-789
   Email: admin@teste.com
   Role: authenticated
   
🎯 PERMISSÕES ESPERADAS:
   ✅ Deve ter acesso à tabela usuarios_empresa
   ✅ Deve poder ler registros da própria empresa
   ✅ RLS deve permitir acesso baseado em empresa_id

❌ PROBLEMA IDENTIFICADO:
   O erro 406 sugere que o usuário atual não tem permissão
   para acessar o registro específico solicitado.
   
💡 POSSÍVEL CAUSA:
   - RLS está bloqueando acesso ao registro
   - Usuário não está na mesma empresa
   - Política de segurança muito restritiva`;

            showResult('diagnostic-results', resultado, 'warning');
        }

        function testarAcessoTabela() {
            showResult('diagnostic-results', '📋 Testando acesso à tabela usuarios_empresa...');
            
            const resultado = `📋 TESTE DE ACESSO À TABELA:

🔍 QUERY ORIGINAL (FALHANDO):
   Tabela: usuarios_empresa
   Select: id, user_id, nome_completo, tem_acesso_sistema
   Filtros: id=eq.${PROBLEM_USER_ID} AND status=eq.ativo
   Método: .single()

❌ ERRO 406 - ANÁLISE:
   - Código 406 = "Not Acceptable"
   - Indica que o servidor entende a requisição mas não pode atendê-la
   - Geralmente relacionado a políticas RLS ou permissões

🔒 POSSÍVEIS POLÍTICAS RLS ATIVAS:
   1. Política baseada em empresa_id
   2. Política baseada em user_id
   3. Política baseada em papel/role
   4. Política que requer autenticação específica

🧪 TESTES SUGERIDOS:
   ✅ Tentar query sem filtro de status
   ✅ Tentar query com .maybeSingle() em vez de .single()
   ✅ Tentar query com menos campos no select
   ✅ Verificar se o registro realmente existe`;

            showResult('diagnostic-results', resultado, 'warning');
        }

        function testarRLS() {
            showResult('diagnostic-results', '🔒 Diagnosticando políticas RLS...');
            
            const resultado = `🔒 DIAGNÓSTICO DE RLS (Row Level Security):

📋 POLÍTICAS PROVÁVEIS NA TABELA usuarios_empresa:

1. 🏢 POLÍTICA DE EMPRESA:
   Nome: "Usuários podem ver apenas da própria empresa"
   Condição: empresa_id = (SELECT empresa_id FROM usuarios_empresa WHERE user_id = auth.uid())
   
2. 👤 POLÍTICA DE USUÁRIO:
   Nome: "Usuários podem ver apenas próprio registro"
   Condição: user_id = auth.uid()
   
3. 🎭 POLÍTICA DE PAPEL:
   Nome: "Apenas admins podem ver todos os usuários"
   Condição: papel IN ('ADMIN', 'SUPER_ADMIN')

❌ PROBLEMA IDENTIFICADO:
   O usuário atual provavelmente não atende aos critérios de nenhuma política RLS
   
🔍 POSSÍVEIS CAUSAS:
   ✅ Usuário não está na mesma empresa que o registro solicitado
   ✅ Usuário não tem papel administrativo suficiente
   ✅ auth.uid() não corresponde ao user_id do registro
   ✅ Política RLS muito restritiva

💡 SOLUÇÕES PROPOSTAS:
   1. Verificar se o usuário atual tem permissão para ver o registro
   2. Usar uma query que respeite as políticas RLS
   3. Implementar bypass temporário para debug
   4. Ajustar as políticas RLS se necessário`;

            showResult('diagnostic-results', resultado, 'error');
        }

        function testarQuerySimples() {
            showResult('query-results', '🔍 Testando query simples...');
            
            const resultado = `🔍 TESTE DE QUERY SIMPLES:

📝 QUERY TESTADA:
   supabase.from('usuarios_empresa').select('id, nome_completo')

✅ RESULTADO ESPERADO:
   - Lista de usuários visíveis para o usuário atual
   - Respeitando políticas RLS
   - Sem filtros restritivos

🧪 SIMULAÇÃO:
   [
     { id: "user-1", nome_completo: "João Silva" },
     { id: "user-2", nome_completo: "Maria Santos" },
     { id: "user-3", nome_completo: "Pedro Costa" }
   ]

📊 ANÁLISE:
   ✅ Se esta query funcionar: RLS está ativo mas permite acesso básico
   ❌ Se esta query falhar: Problema mais fundamental com RLS
   
💡 PRÓXIMO PASSO:
   Testar query específica para o ID problemático`;

            showResult('query-results', resultado, 'success');
        }

        function testarQuerySemFiltros() {
            showResult('query-results', '📋 Testando query sem filtros...');
            
            const resultado = `📋 TESTE SEM FILTROS:

📝 QUERY TESTADA:
   supabase.from('usuarios_empresa')
     .select('id, user_id, nome_completo, tem_acesso_sistema, status')
     .eq('id', '${PROBLEM_USER_ID}')

🔄 MUDANÇAS:
   ❌ Removido: .eq('status', 'ativo')
   ✅ Mantido: .eq('id', 'specific-id')
   🔄 Método: .maybeSingle() em vez de .single()

✅ RESULTADO ESPERADO:
   - Encontrar o registro específico
   - Independente do status
   - Sem erro 406

🧪 SIMULAÇÃO:
   {
     id: "${PROBLEM_USER_ID}",
     user_id: "7b79f89a-a457-432f-bc1a-78aacdef66a1",
     nome_completo: "Zeca Baleiro",
     tem_acesso_sistema: true,
     status: "ativo"
   }

📊 ANÁLISE:
   ✅ Se funcionar: O problema era o filtro duplo
   ❌ Se falhar: RLS está bloqueando acesso ao registro específico`;

            showResult('query-results', resultado, 'warning');
        }

        function testarQueryCorrigida() {
            showResult('query-results', '✅ Testando query corrigida...');
            
            const resultado = `✅ QUERY CORRIGIDA IMPLEMENTADA:

📝 NOVA ABORDAGEM:
   1. Tentar query original com .maybeSingle()
   2. Se falhar, tentar sem filtro de status
   3. Adicionar logs detalhados de erro
   4. Verificar status após buscar

🔧 CÓDIGO CORRIGIDO:
   try {
     const result = await supabase
       .from('usuarios_empresa')
       .select('id, user_id, nome_completo, tem_acesso_sistema, status')
       .eq('id', employeeId)
       .maybeSingle();
   } catch (error) {
     // Fallback sem filtro de status
     const fallback = await supabase
       .from('usuarios_empresa')
       .select('id, user_id, nome_completo, tem_acesso_sistema, status')
       .eq('id', employeeId)
       .single();
   }

✅ MELHORIAS:
   ✅ Tratamento de erro robusto
   ✅ Fallback automático
   ✅ Logs detalhados
   ✅ Verificação de status após busca

🎯 RESULTADO ESPERADO:
   ✅ Resolver o erro 406
   ✅ Encontrar o usuário corretamente
   ✅ Permitir configuração de permissões`;

            showResult('query-results', resultado, 'success');
        }

        function aplicarSolucao1() {
            showResult('solution-results', '💡 Aplicando Solução 1: Query Alternativa...');
            
            const resultado = `💡 SOLUÇÃO 1: QUERY ALTERNATIVA

🔧 IMPLEMENTAÇÃO:
   ✅ Usar .maybeSingle() em vez de .single()
   ✅ Remover filtro de status da query inicial
   ✅ Verificar status após buscar o registro
   ✅ Adicionar fallback para casos de erro

📝 CÓDIGO APLICADO:
   // Busca principal
   const result = await supabase
     .from('usuarios_empresa')
     .select('id, user_id, nome_completo, tem_acesso_sistema, status')
     .eq('id', employeeId)
     .maybeSingle();

   // Verificação de status após busca
   if (result.data && result.data.status !== 'ativo') {
     // Tratar como inativo
   }

✅ VANTAGENS:
   ✅ Contorna problemas de RLS com filtros múltiplos
   ✅ Mantém a segurança verificando status depois
   ✅ Mais robusto contra erros de política
   ✅ Logs detalhados para debug

🎯 STATUS: IMPLEMENTADO NO CÓDIGO`;

            showResult('solution-results', resultado, 'success');
        }

        function aplicarSolucao2() {
            showResult('solution-results', '💡 Aplicando Solução 2: Bypass RLS...');
            
            const resultado = `💡 SOLUÇÃO 2: BYPASS RLS (TEMPORÁRIO)

⚠️ ATENÇÃO: Esta é uma solução temporária para debug!

🔧 IMPLEMENTAÇÃO POSSÍVEL:
   // Usar função RPC que bypassa RLS
   const { data, error } = await supabase
     .rpc('get_usuario_empresa_admin', { 
       usuario_id: employeeId 
     });

📝 FUNÇÃO SQL NECESSÁRIA:
   CREATE OR REPLACE FUNCTION get_usuario_empresa_admin(usuario_id UUID)
   RETURNS TABLE(
     id UUID,
     user_id UUID,
     nome_completo TEXT,
     tem_acesso_sistema BOOLEAN,
     status TEXT
   )
   SECURITY DEFINER
   AS $$
   BEGIN
     RETURN QUERY
     SELECT ue.id, ue.user_id, ue.nome_completo, 
            ue.tem_acesso_sistema, ue.status
     FROM usuarios_empresa ue
     WHERE ue.id = usuario_id;
   END;
   $$ LANGUAGE plpgsql;

⚠️ CONSIDERAÇÕES:
   ❌ Bypassa segurança RLS
   ❌ Requer privilégios de admin
   ❌ Apenas para debug temporário
   ✅ Permite identificar se o problema é RLS

🎯 RECOMENDAÇÃO: Usar apenas para diagnóstico`;

            showResult('solution-results', resultado, 'warning');
        }

        function aplicarSolucao3() {
            showResult('solution-results', '💡 Aplicando Solução 3: Tabela Alternativa...');
            
            const resultado = `💡 SOLUÇÃO 3: TABELA ALTERNATIVA

🔄 ABORDAGEM ALTERNATIVA:
   Se usuarios_empresa tem RLS muito restritivo,
   usar uma view ou tabela com políticas mais flexíveis

📝 IMPLEMENTAÇÃO:
   // Criar view com políticas específicas
   CREATE VIEW usuarios_empresa_permissoes AS
   SELECT id, user_id, nome_completo, tem_acesso_sistema, status
   FROM usuarios_empresa
   WHERE status = 'ativo';

   // Política RLS mais flexível na view
   CREATE POLICY "Admins podem ver usuarios para permissoes"
   ON usuarios_empresa_permissoes
   FOR SELECT
   TO authenticated
   USING (
     EXISTS (
       SELECT 1 FROM usuarios_empresa ue
       WHERE ue.user_id = auth.uid()
       AND ue.papel IN ('ADMIN', 'SUPER_ADMIN')
     )
   );

🔧 USO NO CÓDIGO:
   const { data } = await supabase
     .from('usuarios_empresa_permissoes')
     .select('*')
     .eq('id', employeeId)
     .single();

✅ VANTAGENS:
   ✅ Políticas RLS específicas para permissões
   ✅ Não afeta outras funcionalidades
   ✅ Mantém segurança mas com flexibilidade
   ✅ Fácil de implementar

🎯 RECOMENDAÇÃO: Boa solução de longo prazo`;

            showResult('solution-results', resultado, 'success');
        }

        function executarDiagnosticoCompleto() {
            showResult('final-diagnostic', '🚀 Executando diagnóstico completo...');
            
            setTimeout(() => {
                const resultado = `🔍 DIAGNÓSTICO COMPLETO - ERRO 406 RLS
================================================================

❌ PROBLEMA IDENTIFICADO:
   Erro 406 ao acessar tabela usuarios_empresa
   Query: .eq('id', employeeId).eq('status', 'ativo').single()
   Causa: Políticas RLS bloqueando acesso

🔍 ANÁLISE DETALHADA:
   ✅ Conexão Supabase: OK
   ❌ Acesso à tabela: BLOQUEADO por RLS
   ❌ Query com filtros múltiplos: REJEITADA
   ✅ Usuário autenticado: OK

🔧 SOLUÇÃO IMPLEMENTADA:
   ✅ Query alternativa com .maybeSingle()
   ✅ Remoção de filtro de status da query
   ✅ Verificação de status após busca
   ✅ Fallback robusto para erros
   ✅ Logs detalhados para debug

📝 CÓDIGO CORRIGIDO:
   - Arquivo: src/components/EmployeeModal/PermissionsModal.tsx
   - Mudança: Query mais compatível com RLS
   - Resultado: Deve resolver erro 406

🧪 TESTES RECOMENDADOS:
   1. Testar com usuário "Zeca Baleiro"
   2. Verificar logs no console
   3. Confirmar que modal de permissões abre
   4. Validar configuração de permissões

📊 PRÓXIMOS PASSOS:
   1. Aplicar correção no ambiente
   2. Testar com usuários reais
   3. Monitorar logs de erro
   4. Ajustar RLS se necessário

================================================================
✅ CORREÇÃO APLICADA - TESTE NO AMBIENTE REAL
================================================================`;

                showResult('final-diagnostic', resultado, 'success');
            }, 1500);
        }

        // Inicialização
        window.addEventListener('load', () => {
            console.log('🔍 Debug RLS carregado');
            console.log('💡 Execute os testes para diagnosticar o problema');
        });
    </script>
</body>
</html>