<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Corre√ß√£o Urgente - Deadlock RLS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .section {
            padding: 30px;
            margin: 20px;
            border-radius: 10px;
            border-left: 5px solid;
        }
        
        .critical-section {
            border-left-color: #dc2626;
            background: #fef2f2;
        }
        
        .success-section {
            border-left-color: #16a34a;
            background: #f0fdf4;
        }
        
        .warning-section {
            border-left-color: #ea580c;
            background: #fff7ed;
        }
        
        .info-section {
            border-left-color: #2563eb;
            background: #eff6ff;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-critical {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .btn-critical:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(22, 163, 74, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(234, 88, 12, 0.3);
        }
        
        .output {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Corre√ß√£o Urgente - Deadlock RLS</h1>
            <p>Sistema de corre√ß√£o para problema de acesso bloqueado por pol√≠ticas RLS</p>
        </div>

        <!-- Diagn√≥stico do Problema -->
        <div class="critical-section section">
            <h2>‚ùå Problema Identificado</h2>
            <p><strong>DEADLOCK RLS:</strong> A fun√ß√£o <code>get_user_empresa_id()</code> n√£o consegue acessar a tabela <code>usuarios_empresa</code> porque ela est√° protegida por pol√≠ticas RLS que dependem da pr√≥pria fun√ß√£o.</p>
            
            <h3>üîÑ Ciclo Vicioso:</h3>
            <ol>
                <li>Pol√≠ticas RLS precisam de <code>get_user_empresa_id()</code></li>
                <li>Fun√ß√£o <code>get_user_empresa_id()</code> precisa acessar <code>usuarios_empresa</code></li>
                <li>Tabela <code>usuarios_empresa</code> est√° protegida por RLS</li>
                <li>RLS bloqueia a fun√ß√£o = DEADLOCK</li>
            </ol>
            
            <h3>üí• Resultado:</h3>
            <p><strong>TODOS os usu√°rios ficam sem acesso</strong> porque o sistema n√£o consegue carregar suas permiss√µes.</p>
        </div>

        <!-- A√ß√µes de Corre√ß√£o -->
        <div class="grid">
            <div class="card">
                <span class="status-icon">üîß</span>
                <h3>1. Diagn√≥stico Completo</h3>
                <p>Verificar estado atual do sistema e confirmar o problema</p>
                <button class="btn btn-warning" onclick="executarDiagnostico()">
                    üîç Executar Diagn√≥stico
                </button>
            </div>

            <div class="card">
                <span class="status-icon">‚ö°</span>
                <h3>2. Corre√ß√£o Autom√°tica</h3>
                <p>Aplicar corre√ß√£o das pol√≠ticas RLS e fun√ß√£o get_user_empresa_id</p>
                <button class="btn btn-critical" onclick="aplicarCorrecaoUrgente()">
                    üö® Corrigir Agora
                </button>
            </div>

            <div class="card">
                <span class="status-icon">‚úÖ</span>
                <h3>3. Valida√ß√£o da Corre√ß√£o</h3>
                <p>Testar se a corre√ß√£o resolveu o problema de acesso</p>
                <button class="btn btn-success" onclick="validarCorrecao()">
                    ‚úÖ Validar Fix
                </button>
            </div>

            <div class="card">
                <span class="status-icon">üîí</span>
                <h3>4. Rollback de Emerg√™ncia</h3>
                <p>Desabilitar RLS temporariamente se necess√°rio</p>
                <button class="btn btn-warning" onclick="rollbackEmergencia()">
                    ‚ö†Ô∏è Rollback
                </button>
            </div>
        </div>

        <!-- Script SQL para Aplica√ß√£o Manual -->
        <div class="info-section section">
            <h2>üìã Script SQL para Aplica√ß√£o Manual</h2>
            <p>Se preferir aplicar manualmente, copie e execute este script no SQL Editor do Supabase:</p>
            <div class="code-block">
-- CORRE√á√ÉO URGENTE DO DEADLOCK RLS
-- Corrigir fun√ß√£o get_user_empresa_id com SECURITY DEFINER

CREATE OR REPLACE FUNCTION public.get_user_empresa_id()
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  empresa_uuid UUID;
BEGIN
  IF auth.uid() IS NULL THEN
    RETURN NULL;
  END IF;

  SELECT empresa_id INTO empresa_uuid
  FROM usuarios_empresa 
  WHERE user_id = auth.uid()
    AND status = 'ativo'
  ORDER BY created_at DESC
  LIMIT 1;

  RETURN empresa_uuid;
EXCEPTION
  WHEN OTHERS THEN
    RETURN NULL;
END;
$$;

-- Pol√≠ticas RLS simplificadas
DROP POLICY IF EXISTS "usuarios_empresa_select_simple" ON usuarios_empresa;
CREATE POLICY "usuarios_empresa_select_simple" ON usuarios_empresa
  FOR SELECT USING (
    auth.uid() IS NOT NULL AND (
      user_id = auth.uid() OR
      empresa_id = get_user_empresa_id() OR
      current_setting('role') = 'service_role'
    )
  );
            </div>
            <button class="btn btn-critical" onclick="copiarScript()">üìã Copiar Script</button>
        </div>

        <!-- √Årea de Output -->
        <div class="section">
            <h2>üìä Logs de Execu√ß√£o</h2>
            <div id="output" class="output">
Aguardando execu√ß√£o...
Clique em uma das op√ß√µes acima para come√ßar o diagn√≥stico ou corre√ß√£o.
            </div>
        </div>

        <!-- Status Final -->
        <div id="statusFinal" class="section" style="display: none;">
            <h2>üìä Status Final da Corre√ß√£o</h2>
            <div id="statusContent"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jtfdzjmravketpkwjkvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZmR6am1yYXZrZXRwa3dqa3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjM1NjIsImV4cCI6MjA3MzkzOTU2Mn0.AOFSlSLFVw-pU1-lpUzxJ2fov3kR95eBlz_92mtSMgs';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').textContent = '';
        }

        async function executarDiagnostico() {
            clearLog();
            log('üîç INICIANDO DIAGN√ìSTICO COMPLETO...');
            log('==========================================');

            try {
                // 1. Testar autentica√ß√£o
                log('\n1Ô∏è‚É£ Testando autentica√ß√£o...');
                const { data: { session }, error: authError } = await supabase.auth.getSession();
                
                if (authError || !session) {
                    log('‚ùå ERRO: Usu√°rio n√£o autenticado');
                    log('   Execute o login primeiro');
                    return;
                }
                
                log(`‚úÖ Usu√°rio autenticado: ${session.user.email}`);

                // 2. Testar acesso √† tabela usuarios_empresa
                log('\n2Ô∏è‚É£ Testando acesso √† tabela usuarios_empresa...');
                try {
                    const { data, error } = await supabase
                        .from('usuarios_empresa')
                        .select('id, user_id, nome_completo')
                        .limit(1);
                    
                    if (error) {
                        log(`‚ùå ERRO RLS CONFIRMADO: ${error.message}`);
                        log('   C√≥digo: ' + (error.code || 'N/A'));
                        log('   Hint: ' + (error.hint || 'N/A'));
                    } else {
                        log(`‚úÖ Acesso OK: ${data.length} registros encontrados`);
                    }
                } catch (err) {
                    log(`‚ùå ERRO DE CONEX√ÉO: ${err.message}`);
                }

                // 3. Testar fun√ß√£o get_user_empresa_id
                log('\n3Ô∏è‚É£ Testando fun√ß√£o get_user_empresa_id...');
                try {
                    const { data, error } = await supabase.rpc('get_user_empresa_id');
                    
                    if (error) {
                        log(`‚ùå FUN√á√ÉO COM ERRO: ${error.message}`);
                    } else {
                        log(`‚úÖ Fun√ß√£o retornou: ${data || 'NULL'}`);
                    }
                } catch (err) {
                    log(`‚ùå ERRO AO CHAMAR FUN√á√ÉO: ${err.message}`);
                }

                // 4. Testar permiss√µes
                log('\n4Ô∏è‚É£ Testando acesso √† tabela permissoes_usuario...');
                try {
                    const { data, error } = await supabase
                        .from('permissoes_usuario')
                        .select('modulo')
                        .limit(1);
                    
                    if (error) {
                        log(`‚ùå ERRO PERMISS√ïES: ${error.message}`);
                    } else {
                        log(`‚úÖ Permiss√µes OK: ${data.length} registros`);
                    }
                } catch (err) {
                    log(`‚ùå ERRO PERMISS√ïES: ${err.message}`);
                }

                log('\nüîç DIAGN√ìSTICO CONCLU√çDO');
                log('==========================================');
                
            } catch (error) {
                log(`‚ùå ERRO FATAL NO DIAGN√ìSTICO: ${error.message}`);
            }
        }

        async function aplicarCorrecaoUrgente() {
            clearLog();
            log('üö® APLICANDO CORRE√á√ÉO URGENTE...');
            log('==========================================');

            const scriptSQL = `
-- CORRE√á√ÉO URGENTE DO DEADLOCK RLS
CREATE OR REPLACE FUNCTION public.get_user_empresa_id()
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  empresa_uuid UUID;
BEGIN
  IF auth.uid() IS NULL THEN
    RETURN NULL;
  END IF;

  SELECT empresa_id INTO empresa_uuid
  FROM usuarios_empresa 
  WHERE user_id = auth.uid()
    AND status = 'ativo'
  ORDER BY created_at DESC
  LIMIT 1;

  RETURN empresa_uuid;
EXCEPTION
  WHEN OTHERS THEN
    RETURN NULL;
END;
$$;

-- Remover pol√≠ticas conflitantes
DROP POLICY IF EXISTS "Usu√°rios podem ver colegas da mesma empresa" ON usuarios_empresa;
DROP POLICY IF EXISTS "Administradores podem gerenciar usu√°rios da empresa" ON usuarios_empresa;
DROP POLICY IF EXISTS "usuarios_empresa_select_policy" ON usuarios_empresa;

-- Pol√≠tica simples para SELECT
CREATE POLICY "usuarios_empresa_select_simple" ON usuarios_empresa
  FOR SELECT USING (
    auth.uid() IS NOT NULL AND (
      user_id = auth.uid() OR
      empresa_id = get_user_empresa_id() OR
      current_setting('role') = 'service_role'
    )
  );

-- Pol√≠tica para permiss√µes
DROP POLICY IF EXISTS "Usu√°rios podem ver permiss√µes da mesma empresa" ON permissoes_usuario;
DROP POLICY IF EXISTS "Administradores podem gerenciar permiss√µes da empresa" ON permissoes_usuario;

CREATE POLICY "permissoes_usuario_simple" ON permissoes_usuario
  FOR ALL USING (
    auth.uid() IS NOT NULL AND (
      EXISTS (SELECT 1 FROM usuarios_empresa WHERE id = permissoes_usuario.usuario_empresa_id AND user_id = auth.uid()) OR
      EXISTS (
        SELECT 1 FROM usuarios_empresa ue1, usuarios_empresa ue2 
        WHERE ue1.user_id = auth.uid() 
        AND ue1.papel IN ('SUPER_ADMIN', 'ADMIN')
        AND ue2.id = permissoes_usuario.usuario_empresa_id
        AND ue1.empresa_id = ue2.empresa_id
      ) OR
      current_setting('role') = 'service_role'
    )
  );

-- Fun√ß√£o de teste
CREATE OR REPLACE FUNCTION test_rls_fix()
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  user_count INTEGER;
  empresa_id UUID;
  test_result TEXT;
BEGIN
  SELECT COUNT(*) INTO user_count FROM usuarios_empresa;
  SELECT get_user_empresa_id() INTO empresa_id;
  
  test_result := format(
    'RLS FIX TEST: Users=%s, EmpresaId=%s, Working=%s',
    COALESCE(user_count::text, 'ERROR'),
    COALESCE(empresa_id::text, 'NULL'),
    CASE WHEN empresa_id IS NOT NULL THEN 'YES' ELSE 'NO' END
  );
  
  RETURN test_result;
END;
$$;
            `;

            log('üìù EXECUTANDO CORRE√á√ÉO...');
            log('‚ö†Ô∏è IMPORTANTE: Execute este script no SQL Editor do Supabase:');
            log('');
            log(scriptSQL);
            log('');
            log('‚ùó AP√ìS EXECUTAR O SCRIPT, CLIQUE EM "VALIDAR FIX"');
        }

        async function validarCorrecao() {
            clearLog();
            log('‚úÖ VALIDANDO CORRE√á√ÉO...');
            log('==========================================');

            try {
                // 1. Testar fun√ß√£o de teste
                log('1Ô∏è‚É£ Testando fun√ß√£o test_rls_fix...');
                try {
                    const { data, error } = await supabase.rpc('test_rls_fix');
                    
                    if (error) {
                        log(`‚ùå ERRO NA FUN√á√ÉO DE TESTE: ${error.message}`);
                    } else {
                        log(`üìä RESULTADO DO TESTE: ${data}`);
                        
                        if (data.includes('Working=YES')) {
                            log('üéâ CORRE√á√ÉO BEM-SUCEDIDA!');
                        } else {
                            log('‚ö†Ô∏è Corre√ß√£o parcial - requer ajustes');
                        }
                    }
                } catch (err) {
                    log(`‚ùå ERRO: ${err.message}`);
                }

                // 2. Testar acesso normal
                log('\n2Ô∏è‚É£ Testando acesso normal √†s tabelas...');
                
                const { data: usuarios, error: userError } = await supabase
                    .from('usuarios_empresa')
                    .select('id, nome_completo')
                    .limit(3);
                
                if (userError) {
                    log(`‚ùå AINDA COM ERRO: ${userError.message}`);
                } else {
                    log(`‚úÖ USU√ÅRIOS ACESS√çVEIS: ${usuarios.length} registros`);
                    usuarios.forEach(u => log(`   - ${u.nome_completo} (${u.id})`));
                }

                // 3. Testar permiss√µes
                const { data: permissoes, error: permError } = await supabase
                    .from('permissoes_usuario')
                    .select('modulo')
                    .limit(3);
                
                if (permError) {
                    log(`‚ùå PERMISS√ïES COM ERRO: ${permError.message}`);
                } else {
                    log(`‚úÖ PERMISS√ïES ACESS√çVEIS: ${permissoes.length} registros`);
                }

                // 4. Status final
                if (!userError && !permError) {
                    log('\nüéâ CORRE√á√ÉO COMPLETA - SISTEMA FUNCIONANDO!');
                    mostrarStatusFinal(true);
                } else {
                    log('\n‚ö†Ô∏è CORRE√á√ÉO PARCIAL - AJUSTES NECESS√ÅRIOS');
                    mostrarStatusFinal(false);
                }

            } catch (error) {
                log(`‚ùå ERRO NA VALIDA√á√ÉO: ${error.message}`);
            }
        }

        async function rollbackEmergencia() {
            clearLog();
            log('‚ö†Ô∏è EXECUTANDO ROLLBACK DE EMERG√äNCIA...');
            log('==========================================');

            const rollbackSQL = `
-- ROLLBACK DE EMERG√äNCIA - DESABILITAR RLS
ALTER TABLE usuarios_empresa DISABLE ROW LEVEL SECURITY;
ALTER TABLE permissoes_usuario DISABLE ROW LEVEL SECURITY;
ALTER TABLE empresas DISABLE ROW LEVEL SECURITY;

-- Log do rollback
INSERT INTO logs_auditoria (empresa_id, acao, recurso, detalhes)
VALUES (
  '00000000-0000-0000-0000-000000000000',
  'EMERGENCY_RLS_DISABLE',
  'system',
  '{"reason": "deadlock_fix", "timestamp": "' || NOW() || '"}'
);
            `;

            log('üö® SCRIPT DE ROLLBACK GERADO:');
            log('');
            log(rollbackSQL);
            log('');
            log('‚ö†Ô∏è CUIDADO: Isso remove TODA a prote√ß√£o RLS!');
            log('‚ö†Ô∏è Use apenas em emerg√™ncia!');
            log('‚ö†Ô∏è Reabilite o RLS ap√≥s resolver o problema!');
            log('');
            log('üìã Para reabilitar depois:');
            log('ALTER TABLE usuarios_empresa ENABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE permissoes_usuario ENABLE ROW LEVEL SECURITY;');
            log('ALTER TABLE empresas ENABLE ROW LEVEL SECURITY;');
        }

        function copiarScript() {
            const script = document.querySelector('.code-block').textContent;
            navigator.clipboard.writeText(script).then(() => {
                log('üìã Script copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                log('‚ùå Erro ao copiar: ' + err.message);
            });
        }

        function mostrarStatusFinal(sucesso) {
            const statusDiv = document.getElementById('statusFinal');
            const contentDiv = document.getElementById('statusContent');
            
            if (sucesso) {
                statusDiv.className = 'section success-section';
                contentDiv.innerHTML = `
                    <h3>üéâ CORRE√á√ÉO BEM-SUCEDIDA!</h3>
                    <p><strong>‚úÖ Sistema totalmente funcional</strong></p>
                    <ul>
                        <li>‚úÖ Fun√ß√£o get_user_empresa_id() corrigida</li>
                        <li>‚úÖ Pol√≠ticas RLS simplificadas</li>
                        <li>‚úÖ Acesso √†s tabelas restaurado</li>
                        <li>‚úÖ Permiss√µes funcionando</li>
                    </ul>
                    <p><strong>Todos os usu√°rios devem ter acesso normal novamente!</strong></p>
                `;
            } else {
                statusDiv.className = 'section warning-section';
                contentDiv.innerHTML = `
                    <h3>‚ö†Ô∏è CORRE√á√ÉO PARCIAL</h3>
                    <p><strong>Alguns problemas ainda persistem</strong></p>
                    <p>Considere:</p>
                    <ul>
                        <li>üîÑ Executar novamente a corre√ß√£o</li>
                        <li>üîß Verificar logs do Supabase</li>
                        <li>‚ö†Ô∏è Usar rollback de emerg√™ncia se necess√°rio</li>
                    </ul>
                `;
            }
            
            statusDiv.style.display = 'block';
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üö® Sistema de Corre√ß√£o RLS carregado');
            log('üí° Execute o diagn√≥stico primeiro para confirmar o problema');
        });
    </script>
</body>
</html>