<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Corre√ß√£o de Credenciais</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .results { margin-top: 20px; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .credentials { background: #e7f3ff; border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Corre√ß√£o de Credenciais</h1>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3>‚ö†Ô∏è Configura√ß√£o Necess√°ria</h3>
            <p>Antes de executar os testes:</p>
            <ol>
                <li>Execute o script <strong>fix-credentials-issue.sql</strong> no SQL Editor do Supabase</li>
                <li>Configure as credenciais do Supabase no c√≥digo abaixo</li>
                <li>Use a <strong>service role key</strong> para testes com admin</li>
            </ol>
        </div>

        <div>
            <h3>üîß Testes de Corre√ß√£o</h3>
            <button class="button" onclick="test1_VerifySetup()">1Ô∏è‚É£ Verificar Configura√ß√£o</button>
            <button class="button" onclick="test2_CreateEmployee()">2Ô∏è‚É£ Criar Funcion√°rio</button>
            <button class="button" onclick="test3_TestLogin()">3Ô∏è‚É£ Testar Login</button>
            <button class="button" onclick="test4_DebugUser()">4Ô∏è‚É£ Debug Usu√°rio</button>
            <button class="button" onclick="clearResults()">üóëÔ∏è Limpar</button>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURE SUAS CREDENCIAIS AQUI
        const supabaseUrl = 'https://your-project-id.supabase.co';
        const supabaseServiceKey = 'your-service-role-key'; // Use service role para testes admin
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey);
        
        let testCredentials = null;

        function addMessage(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `results ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // 1Ô∏è‚É£ Verificar se a configura√ß√£o est√° correta
        async function test1_VerifySetup() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Verificando...';

            try {
                addMessage('üîç <strong>Verificando configura√ß√£o do sistema...</strong>', 'info');

                // Verificar conex√£o
                const { data: connection, error: connError } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);

                if (connError) {
                    if (connError.code === 'PGRST116') {
                        addMessage('‚ùå <strong>Tabela profiles n√£o existe!</strong><br>Execute o script fix-credentials-issue.sql primeiro', 'error');
                        return;
                    }
                    addMessage(`‚ùå Erro de conex√£o: ${connError.message}`, 'error');
                    return;
                }

                addMessage('‚úÖ Conex√£o com Supabase OK', 'success');
                addMessage('‚úÖ Tabela profiles acess√≠vel', 'success');

                // Verificar se √© service role
                try {
                    const { data: users } = await supabase.auth.admin.listUsers();
                    addMessage(`‚úÖ Service role configurada (${users.users.length} usu√°rios no Auth)`, 'success');
                } catch (adminError) {
                    addMessage('‚ö†Ô∏è Service role n√£o configurada - alguns testes podem falhar', 'warning');
                }

                // Verificar fun√ß√£o de debug
                const { data: debugResult, error: debugError } = await supabase
                    .rpc('debug_user_auth', { user_email: 'teste@exemplo.com' });

                if (debugError) {
                    addMessage('‚ö†Ô∏è Fun√ß√£o de debug n√£o encontrada - execute o script SQL primeiro', 'warning');
                } else {
                    addMessage('‚úÖ Fun√ß√µes de debug dispon√≠veis', 'success');
                }

                addMessage('üéâ <strong>Sistema configurado corretamente!</strong>', 'success');

            } catch (error) {
                addMessage(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '1Ô∏è‚É£ Verificar Configura√ß√£o';
            }
        }

        // 2Ô∏è‚É£ Criar funcion√°rio de teste
        async function test2_CreateEmployee() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Criando...';

            try {
                addMessage('üë§ <strong>Criando funcion√°rio de teste...</strong>', 'info');

                const testEmail = `teste.${Date.now()}@exemplo.com`;
                const testPassword = generateSecurePassword();

                addMessage(`üìß Email: ${testEmail}<br>üîë Senha: ${testPassword}`, 'info');

                // Usar admin.createUser com email confirmado
                const { data: authData, error: authError } = await supabase.auth.admin.createUser({
                    email: testEmail,
                    password: testPassword,
                    email_confirm: true, // CR√çTICO: Confirmar email
                    user_metadata: {
                        name: 'Funcion√°rio Teste',
                        role: 'funcionario',
                        cargo: 'Gar√ßom',
                        temporary_password: true
                    }
                });

                if (authError) {
                    addMessage(`‚ùå Erro ao criar usu√°rio: ${authError.message}`, 'error');
                    return;
                }

                if (!authData.user) {
                    addMessage('‚ùå Usu√°rio n√£o foi criado (data.user √© null)', 'error');
                    return;
                }

                addMessage(`‚úÖ <strong>Usu√°rio criado no Auth!</strong><br>
                    ID: ${authData.user.id}<br>
                    Email confirmado: ${authData.user.email_confirmed_at ? 'Sim' : 'N√£o'}`, 'success');

                // Aguardar processamento do trigger
                addMessage('‚è≥ Aguardando processamento do trigger...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Verificar se perfil foi criado
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', authData.user.id)
                    .single();

                if (profile) {
                    addMessage('‚úÖ Perfil criado automaticamente pelo trigger', 'success');
                } else {
                    addMessage('‚ö†Ô∏è Perfil n√£o foi criado automaticamente', 'warning');
                }

                // Salvar credenciais para teste de login
                testCredentials = {
                    email: testEmail,
                    password: testPassword,
                    userId: authData.user.id
                };

                addMessage(`
                    <div class="credentials">
                        <h4>üîë Credenciais Geradas:</h4>
                        <div><strong>Email:</strong> ${testEmail}</div>
                        <div><strong>Senha:</strong> ${testPassword}</div>
                        <div><strong>Tempor√°ria:</strong> Sim</div>
                        <div><strong>Status:</strong> Pronto para login</div>
                    </div>
                `, 'success');

            } catch (error) {
                addMessage(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '2Ô∏è‚É£ Criar Funcion√°rio';
            }
        }

        // 3Ô∏è‚É£ Testar login com credenciais
        async function test3_TestLogin() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Testando...';

            try {
                if (!testCredentials) {
                    addMessage('‚ùå Execute o teste 2 primeiro para ter credenciais', 'error');
                    return;
                }

                addMessage('üîê <strong>Testando login com credenciais geradas...</strong>', 'info');

                // Tentar login
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: testCredentials.email,
                    password: testCredentials.password
                });

                if (error) {
                    addMessage(`‚ùå <strong>ERRO NO LOGIN:</strong> ${error.message}`, 'error');
                    
                    // Debug adicional
                    if (error.message.includes('Invalid login credentials')) {
                        addMessage('üîç Investigando o problema...', 'info');
                        
                        // Verificar se usu√°rio existe
                        const { data: users } = await supabase.auth.admin.listUsers();
                        const userExists = users.users.find(u => u.email === testCredentials.email);
                        
                        if (userExists) {
                            addMessage(`‚úÖ Usu√°rio existe no Auth: ${userExists.id}`, 'info');
                            addMessage(`üìß Email confirmado: ${userExists.email_confirmed_at ? 'Sim' : 'N√ÉO'}`, 
                                userExists.email_confirmed_at ? 'success' : 'error');
                        } else {
                            addMessage('‚ùå Usu√°rio N√ÉO existe no Auth', 'error');
                        }
                    }
                    
                } else if (data.user) {
                    addMessage(`üéâ <strong>LOGIN FUNCIONOU!</strong><br>
                        User ID: ${data.user.id}<br>
                        Email: ${data.user.email}<br>
                        Session: ${data.session ? 'Ativa' : 'Inativa'}`, 'success');
                    
                    addMessage('‚úÖ <strong>PROBLEMA RESOLVIDO!</strong> As credenciais agora funcionam corretamente.', 'success');
                    
                    // Fazer logout
                    await supabase.auth.signOut();
                    addMessage('‚Ü©Ô∏è Logout realizado', 'info');
                    
                } else {
                    addMessage('‚ùå Erro inesperado: Login n√£o retornou erro nem usu√°rio', 'error');
                }

            } catch (error) {
                addMessage(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '3Ô∏è‚É£ Testar Login';
            }
        }

        // 4Ô∏è‚É£ Debug de usu√°rio espec√≠fico
        async function test4_DebugUser() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Debugando...';

            try {
                let email = testCredentials?.email;
                
                if (!email) {
                    email = prompt('Digite o email do usu√°rio para debug:');
                    if (!email) return;
                }

                addMessage(`üîç <strong>Debug do usu√°rio: ${email}</strong>`, 'info');

                // Usar fun√ß√£o de debug criada
                const { data: debugResult, error: debugError } = await supabase
                    .rpc('debug_user_auth', { user_email: email });

                if (debugError) {
                    addMessage(`‚ùå Erro no debug: ${debugError.message}`, 'error');
                    return;
                }

                if (!debugResult || debugResult.length === 0) {
                    addMessage('‚ùå Usu√°rio n√£o encontrado', 'error');
                    return;
                }

                const user = debugResult[0];
                
                addMessage(`üìä <strong>Resultado do Debug:</strong><br>
                    <strong>User ID:</strong> ${user.user_id}<br>
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>Email confirmado:</strong> ${user.email_confirmed ? 'Sim' : 'N√ÉO'}<br>
                    <strong>Tem perfil:</strong> ${user.has_profile ? 'Sim' : 'N√£o'}<br>
                    <strong>Tem usuarios_empresa:</strong> ${user.has_usuarios_empresa ? 'Sim' : 'N√£o'}<br>
                    <strong>Pode fazer login:</strong> ${user.can_login}`, 
                    user.can_login.includes('SIM') ? 'success' : 'error');

                // Se n√£o pode fazer login, sugerir corre√ß√£o
                if (!user.can_login.includes('SIM')) {
                    if (!user.email_confirmed) {
                        addMessage('üí° <strong>Corre√ß√£o sugerida:</strong> Confirmar email', 'warning');
                        
                        if (confirm('Confirmar email automaticamente?')) {
                            const { data: confirmResult } = await supabase
                                .rpc('confirm_user_email', { user_email: email });
                            addMessage(`üìß ${confirmResult}`, 'info');
                        }
                    }
                }

            } catch (error) {
                addMessage(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '4Ô∏è‚É£ Debug Usu√°rio';
            }
        }

        function generateSecurePassword() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789@#$%';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Mensagem inicial
        window.onload = function() {
            addMessage('üöÄ <strong>Teste de corre√ß√£o de credenciais iniciado!</strong>', 'info');
            addMessage('‚ö†Ô∏è Configure as credenciais do Supabase no c√≥digo antes de usar', 'warning');
        };
    </script>
</body>
</html>