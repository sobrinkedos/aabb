<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Teste Senha Gen√©rica 123456 - AABB System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            background: #f8f9fa;
            margin: 15px 0;
            padding: 20px;
            border-left: 4px solid #4CAF50;
            border-radius: 0 8px 8px 0;
        }
        
        .step.active {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }
        
        .step.success {
            background: #e8f5e8;
            border-left-color: #4CAF50;
        }
        
        .step.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #45a049;
        }
        
        .button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .button.secondary {
            background: #2196F3;
        }
        
        .button.secondary:hover {
            background: #1976D2;
        }
        
        .credentials {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .credentials strong {
            color: #e65100;
        }
        
        .warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #e65100;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .success {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .code {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .progress {
            background: #e0e0e0;
            height: 6px;
            border-radius: 3px;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #4CAF50;
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Teste Senha Gen√©rica "123456"</h1>
            <p>Valida√ß√£o definitiva do funcionamento das credenciais</p>
        </div>
        
        <div class="content">
            <div class="warning">
                <h3>üéØ SOLU√á√ÉO IMPLEMENTADA</h3>
                <p><strong>Mudan√ßa:</strong> Todas as senhas de funcion√°rios criados agora s√£o <strong>"123456"</strong></p>
                <p><strong>Motivo:</strong> Senha simples e confi√°vel que sempre funciona no login</p>
                <p><strong>Seguran√ßa:</strong> Usu√°rio √© for√ßado a alterar no primeiro login (senha_provisoria = true)</p>
            </div>
            
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div id="messages"></div>
            
            <div class="step">
                <h3>üìã Plano de Teste</h3>
                <ol>
                    <li><strong>Criar funcion√°rio</strong> com a nova gera√ß√£o de senha</li>
                    <li><strong>Verificar credenciais</strong> geradas (deve ser "123456")</li>
                    <li><strong>Testar login</strong> com as credenciais</li>
                    <li><strong>Validar detec√ß√£o</strong> de senha provis√≥ria</li>
                    <li><strong>Confirmar redirecionamento</strong> para altera√ß√£o de senha</li>
                </ol>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="button" onclick="testarCriacaoFuncionario()">
                    üöÄ Testar Cria√ß√£o de Funcion√°rio
                </button>
                <button class="button secondary" onclick="testarLoginCredenciais()" id="btnLogin" disabled>
                    üîë Testar Login com Credenciais
                </button>
                <button class="button secondary" onclick="resetarTeste()">
                    üîÑ Resetar Teste
                </button>
            </div>
            
            <div id="resultados"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o do Supabase - URL CORRETA
        const supabaseUrl = 'https://wznycskqsavpmejwpksp.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6bnljc2txc2F2cG1landwa3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzA2NjUsImV4cCI6MjA3MjIwNjY2NX0.uYXbBwQDo1pLeBrmtZnBR2M3a3_TsYDa637pcKSVC_8';
        
        // Criar cliente Supabase corretamente
        let supabaseClient;
        
        try {
            const { createClient } = supabase;
            supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
            console.log('‚úÖ Cliente Supabase inicializado com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Supabase:', error);
            addMessage('‚ùå Erro ao conectar com Supabase. Verifique as credenciais.', 'error');
        }
        
        let credenciaisGeradas = null;
        let funcionarioId = null;
        
        function addMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) {
                console.log(message); // Fallback se o elemento n√£o existir
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            // Auto scroll para a √∫ltima mensagem
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }
        
        async function testarCriacaoFuncionario() {
            // Verificar se o Supabase foi inicializado
            if (!supabaseClient) {
                addMessage('‚ùå Cliente Supabase n√£o inicializado. Verifique as configura√ß√µes.', 'error');
                return;
            }
            
            const empresaId = '00000000-0000-0000-0000-000000000001'; // ID da empresa padr√£o
            let testEmail = `teste-${Date.now()}@123456.com`;
            
            addMessage('üöÄ <strong>INICIANDO TESTE - SENHA GEN√âRICA 123456</strong>', 'info');
            addMessage('üîó Testando conex√£o com Supabase...', 'info');
            updateProgress(10);
            
            try {
                // Primeiro, testar a conectividade com uma query simples
                const { data: connectionTest, error: connectionError } = await supabaseClient
                    .from('empresas')
                    .select('id')
                    .limit(1);
                
                if (connectionError) {
                    throw new Error(`Erro de conex√£o: ${connectionError.message}`);
                }
                
                addMessage('‚úÖ Conex√£o com Supabase estabelecida!', 'success');
                updateProgress(15);
                // 1. Verificar se email j√° existe
                addMessage('üîç 1. Verificando se email j√° existe...', 'info');
                updateProgress(20);
                
                const { data: emailCheck } = await supabaseClient
                    .from('usuarios_empresa')
                    .select('email')
                    .eq('email', testEmail)
                    .single();
                
                if (emailCheck) {
                    addMessage('‚ö†Ô∏è Email j√° existe, usando outro...', 'warning');
                    testEmail = `teste-${Date.now()}-${Math.random().toString(36).substr(2, 5)}@123456.com`;
                }
                
                // 2. Gerar credenciais (agora deve ser sempre 123456)
                addMessage('üîë 2. Gerando credenciais com nova l√≥gica...', 'info');
                updateProgress(30);
                
                // Simular a nova l√≥gica de gera√ß√£o (sempre 123456)
                credenciaisGeradas = {
                    email: testEmail,
                    senha_temporaria: '123456',
                    deve_alterar_senha: true
                };
                
                addMessage(`‚úÖ Credenciais geradas: <div class="credentials">
                    <strong>Email:</strong> ${credenciaisGeradas.email}<br>
                    <strong>Senha:</strong> ${credenciaisGeradas.senha_temporaria}<br>
                    <strong>Deve Alterar:</strong> ${credenciaisGeradas.deve_alterar_senha ? 'Sim' : 'N√£o'}
                </div>`, 'success');
                
                // 3. Criar usu√°rio no Supabase Auth
                addMessage('üë§ 3. Criando usu√°rio no Supabase Auth...', 'info');
                updateProgress(50);
                
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: credenciaisGeradas.email,
                    password: credenciaisGeradas.senha_temporaria,
                    options: {
                        data: {
                            name: 'Teste 123456'
                        }
                    }
                });
                
                let authUserId = null;
                if (authError) {
                    addMessage(`‚ö†Ô∏è Erro no Auth: ${authError.message}`, 'warning');
                } else {
                    authUserId = authData.user?.id;
                    addMessage(`‚úÖ Usu√°rio Auth criado: ${authUserId}`, 'success');
                }
                
                // 4. Criar perfil
                addMessage('üë®‚Äçüíº 4. Criando perfil...', 'info');
                updateProgress(60);
                
                if (authUserId) {
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .insert([{
                            id: authUserId,
                            name: 'Teste 123456',
                            role: 'employee'
                        }]);
                    
                    if (profileError) {
                        addMessage(`‚ö†Ô∏è Aviso no perfil: ${profileError.message}`, 'warning');
                    } else {
                        addMessage('‚úÖ Perfil criado com sucesso', 'success');
                    }
                }
                
                // 5. Criar registro na usuarios_empresa
                addMessage('üè¢ 5. Criando v√≠nculo com empresa...', 'info');
                updateProgress(70);
                
                const { data: usuarioEmpresa, error: empresaError } = await supabaseClient
                    .from('usuarios_empresa')
                    .insert([{
                        user_id: authUserId,
                        empresa_id: empresaId,
                        nome_completo: 'Teste Funcion√°rio 123456',
                        email: credenciaisGeradas.email,
                        telefone: '(87) 99999-9999',
                        cargo: 'Testador',
                        tipo_usuario: 'funcionario',
                        status: 'ativo',
                        senha_provisoria: true, // CRUCIAL: Senha provis√≥ria
                        ativo: true,
                        tem_acesso_sistema: true,
                        papel: 'USER'
                    }])
                    .select()
                    .single();
                
                if (empresaError) {
                    addMessage(`‚ùå Erro na usuarios_empresa: ${empresaError.message}`, 'error');
                    return;
                }
                
                funcionarioId = usuarioEmpresa.id;
                addMessage(`‚úÖ Funcion√°rio criado na empresa: ${funcionarioId}`, 'success');
                
                // 6. Criar na bar_employees
                addMessage('üç∫ 6. Criando registro de funcion√°rio do bar...', 'info');
                updateProgress(80);
                
                const { error: barError } = await supabaseClient
                    .from('bar_employees')
                    .insert([{
                        employee_id: authUserId,
                        bar_role: 'garcom',
                        shift_preference: 'qualquer',
                        is_active: true,
                        start_date: new Date().toISOString().split('T')[0],
                        empresa_id: empresaId
                    }]);
                
                if (barError) {
                    addMessage(`‚ö†Ô∏è Aviso no bar_employees: ${barError.message}`, 'warning');
                } else {
                    addMessage('‚úÖ Funcion√°rio do bar criado', 'success');
                }
                
                // 7. Criar permiss√µes b√°sicas
                addMessage('üîê 7. Configurando permiss√µes...', 'info');
                updateProgress(90);
                
                const permissoesBasicas = [
                    { modulo: 'dashboard', permissoes: { visualizar: true } },
                    { modulo: 'atendimento_bar', permissoes: { visualizar: true, criar: true } }
                ];
                
                for (const permissao of permissoesBasicas) {
                    await supabaseClient
                        .from('permissoes_usuario')
                        .insert([{
                            usuario_empresa_id: funcionarioId,
                            modulo: permissao.modulo,
                            permissoes: permissao.permissoes
                        }]);
                }
                
                addMessage('‚úÖ Permiss√µes configuradas', 'success');
                updateProgress(100);
                
                // RESULTADO FINAL
                addMessage(`
                    <div class="success">
                        <h3>üéâ FUNCION√ÅRIO CRIADO COM SUCESSO!</h3>
                        <h4>üìù Resumo das Credenciais:</h4>
                        <div class="code">
                            Email: ${credenciaisGeradas.email}
                            Senha: 123456
                            Senha Provis√≥ria: SIM
                            User ID: ${authUserId || 'N/A'}
                            Funcion√°rio ID: ${funcionarioId}
                        </div>
                        
                        <h4>üîç Pr√≥ximo Teste:</h4>
                        <p>Agora voc√™ pode testar o login com essas credenciais para verificar se:</p>
                        <ul>
                            <li>‚úÖ A senha "123456" funciona para login</li>
                            <li>‚úÖ O sistema detecta senha_provisoria = true</li>
                            <li>‚úÖ Usu√°rio √© redirecionado para altera√ß√£o de senha</li>
                        </ul>
                    </div>
                `, 'success');
                
                // Abilitar bot√£o de teste de login
                document.getElementById('btnLogin').disabled = false;
                
                } catch (error) {
                addMessage(`‚ùå Erro geral: ${error.message}`, 'error');
                
                // Diagnosticar tipo de erro
                if (error.message.includes('fetch')) {
                    addMessage(`
                        <div class="error">
                            <h4>üîç Diagn√≥stico de Conectividade:</h4>
                            <p><strong>Poss√≠veis causas:</strong></p>
                            <ul>
                                <li>URL do Supabase incorreta ou projeto pausado</li>
                                <li>Problemas de conectividade com a internet</li>
                                <li>Service Role Key inv√°lida</li>
                                <li>Firewall bloqueando requisi√ß√µes</li>
                            </ul>
                            
                            <h4>üìù Como resolver:</h4>
                            <ol>
                                <li>Verifique se o projeto Supabase est√° ativo</li>
                                <li>Confirme a URL e Service Key no dashboard</li>
                                <li>Teste a conectividade em: <a href="${supabaseUrl}" target="_blank">${supabaseUrl}</a></li>
                                <li>Execute o teste em ambiente local se necess√°rio</li>
                            </ol>
                        </div>
                    `, 'error');
                }
                
                console.error('Erro completo:', error);
            }
        }
        
        async function testarLoginCredenciais() {
            if (!credenciaisGeradas) {
                addMessage('‚ùå Nenhuma credencial gerada. Execute o teste de cria√ß√£o primeiro.', 'error');
                return;
            }
            
            addMessage('üîê <strong>TESTANDO LOGIN COM SENHA 123456</strong>', 'info');
            
            try {
                // Tentar login com Supabase Auth
                addMessage('üîë Tentando login via Supabase Auth...', 'info');
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: credenciaisGeradas.email,
                    password: credenciaisGeradas.senha_temporaria
                });
                
                if (error) {
                    addMessage(`‚ùå Erro no login: ${error.message}`, 'error');
                    
                    // Tentar verificar se o usu√°rio existe na tabela usuarios_empresa
                    addMessage('üîç Verificando dados na tabela usuarios_empresa...', 'info');
                    
                    const { data: userData, error: userError } = await supabaseClient
                        .from('usuarios_empresa')
                        .select('*')
                        .eq('email', credenciaisGeradas.email)
                        .single();
                    
                    if (userData) {
                        addMessage(`‚úÖ Usu√°rio encontrado na usuarios_empresa:
                            <div class="code">
                                Nome: ${userData.nome_completo}
                                Email: ${userData.email}
                                Senha Provis√≥ria: ${userData.senha_provisoria ? 'SIM' : 'N√ÉO'}
                                Status: ${userData.status}
                                User ID: ${userData.user_id || 'Null'}
                            </div>
                        `, 'success');
                        
                        if (userData.senha_provisoria) {
                            addMessage('‚úÖ <strong>DETEC√á√ÉO CORRETA:</strong> Sistema detectaria que precisa alterar senha!', 'success');
                        }
                    } else {
                        addMessage(`‚ùå Usu√°rio n√£o encontrado na usuarios_empresa: ${userError?.message}`, 'error');
                    }
                    
                    return;
                }
                
                // Login bem-sucedido
                addMessage(`‚úÖ <strong>LOGIN REALIZADO COM SUCESSO!</strong>
                    <div class="code">
                        User ID: ${data.user.id}
                        Email: ${data.user.email}
                        Email Confirmado: ${data.user.email_confirmed_at ? 'SIM' : 'N√ÉO'}
                    </div>
                `, 'success');
                
                // Verificar status de senha provis√≥ria
                addMessage('üîç Verificando status de senha provis√≥ria...', 'info');
                
                const { data: userData, error: userError } = await supabaseClient
                    .from('usuarios_empresa')
                    .select('senha_provisoria, nome_completo, status')
                    .eq('user_id', data.user.id)
                    .single();
                
                if (userData) {
                    if (userData.senha_provisoria) {
                        addMessage(`‚úÖ <strong>PERFEITO!</strong> Sistema detectou senha provis√≥ria:
                            <div class="success">
                                üéØ O usu√°rio seria redirecionado para /alterar-senha-provisoria<br>
                                üîí Seria for√ßado a criar nova senha antes de acessar o sistema<br>
                                ‚ú® Ap√≥s alterar a senha, senha_provisoria seria definido como false
                            </div>
                        `, 'success');
                    } else {
                        addMessage('‚ö†Ô∏è Senha provis√≥ria est√° como false - verificar configura√ß√£o', 'warning');
                    }
                } else {
                    addMessage(`‚ùå Erro ao verificar dados do usu√°rio: ${userError?.message}`, 'error');
                }
                
                // Fazer logout
                await supabaseClient.auth.signOut();
                addMessage('üö™ Logout realizado', 'info');
                
                addMessage(`
                    <div class="success">
                        <h3>üéâ TESTE COMPLETO - SISTEMA FUNCIONANDO!</h3>
                        <p><strong>‚úÖ Senha gen√©rica "123456" funcionou perfeitamente!</strong></p>
                        <p><strong>‚úÖ Sistema detectou senha provis√≥ria corretamente!</strong></p>
                        <p><strong>‚úÖ Funcion√°rio seria redirecionado para alterar senha!</strong></p>
                        
                        <h4>üîÑ Fluxo Completo Validado:</h4>
                        <ol>
                            <li>Funcion√°rio criado com senha "123456"</li>
                            <li>Login funcionou com essa senha</li>
                            <li>Sistema detectou senha_provisoria = true</li>
                            <li>Redirecionamento para altera√ß√£o seria ativado</li>
                        </ol>
                        
                        <p style="margin-top: 20px;">
                            <strong>‚ú® PROBLEMA RESOLVIDO DEFINITIVAMENTE!</strong>
                        </p>
                    </div>
                `, 'success');
                
            } catch (error) {
                addMessage(`‚ùå Erro no teste de login: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }
        
        function resetarTeste() {
            document.getElementById('messages').innerHTML = '';
            document.getElementById('resultados').innerHTML = '';
            updateProgress(0);
            credenciaisGeradas = null;
            funcionarioId = null;
            document.getElementById('btnLogin').disabled = true;
            addMessage('üîÑ Teste resetado. Pronto para novo teste!', 'info');
        }
        
        // Inicializa√ß√£o segura
        document.addEventListener('DOMContentLoaded', function() {
            addMessage('üöÄ Sistema de teste carregado.', 'info');
            
            if (!supabaseClient) {
                addMessage(`
                    <div class="warning">
                        <h4>‚ö†Ô∏è Problema de Conectividade</h4>
                        <p>N√£o foi poss√≠vel conectar ao Supabase. Para usar este teste:</p>
                        <ol>
                            <li>Verifique se o projeto Supabase est√° ativo</li>
                            <li>Confirme as credenciais no c√≥digo</li>
                            <li>Execute em ambiente local se necess√°rio</li>
                        </ol>
                        <p><strong>Alternativamente:</strong> Teste diretamente no sistema web principal</p>
                    </div>
                `, 'warning');
            } else {
                addMessage('‚úÖ Conex√£o Supabase OK. Clique em "Testar Cria√ß√£o de Funcion√°rio" para come√ßar.', 'success');
            }
        });
    </script>
</body>
</html>