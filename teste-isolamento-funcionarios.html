<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Isolamento de Funcion√°rios</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        .error-section {
            background: #fff5f5;
            border-left-color: #e53e3e;
        }
        .success-section {
            background: #f0fff4;
            border-left-color: #38a169;
        }
        .warning-section {
            background: #fffaf0;
            border-left-color: #d69e2e;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .config-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #cbd5e0;
        }
        .config-section input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-family: monospace;
        }
        .employee-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Isolamento de Funcion√°rios</h1>
        
        <div class="config-section">
            <h3>‚öôÔ∏è Configura√ß√£o do Supabase</h3>
            <input type="text" id="supabaseUrl" placeholder="URL do Supabase" value="">
            <input type="password" id="anonKey" placeholder="Anon Key" value="">
            <input type="password" id="serviceKey" placeholder="Service Role Key" value="">
            <button onclick="initializeSupabase()">üîß Configurar</button>
        </div>

        <div class="section">
            <h2>üîê Testes de Autentica√ß√£o</h2>
            <button onclick="loginAsAdmin1()" disabled id="loginAdmin1Btn">üë§ Login como Admin 1</button>
            <button onclick="loginAsAdmin2()" disabled id="loginAdmin2Btn">üë§ Login como Admin 2</button>
            <button onclick="checkCurrentUser()" disabled id="checkUserBtn">üîç Verificar Usu√°rio Atual</button>
            <button onclick="logout()" disabled id="logoutBtn">üö™ Logout</button>
        </div>

        <div class="section">
            <h2>üë• Testes de Funcion√°rios</h2>
            <button onclick="testNewSecureHook()" disabled id="testSecureBtn">üõ°Ô∏è Testar Hook Seguro</button>
            <button onclick="createTestEmployee()" disabled id="createEmpBtn">‚ûï Criar Funcion√°rio Teste</button>
            <button onclick="listEmployeesSecure()" disabled id="listSecureBtn">üìã Listar (Modo Seguro)</button>
            <button onclick="testCrossCompanyAccess()" disabled id="testCrossBtn">‚ö†Ô∏è Testar Acesso Cruzado</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let supabase = null;
        let supabaseAdmin = null;
        let currentUser = null;

        function addMessage(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const messageDiv = document.createElement('div');
            
            let className = 'section';
            if (type === 'success') className = 'section success-section';
            if (type === 'error') className = 'section error-section';
            if (type === 'warning') className = 'section warning-section';
            
            messageDiv.className = className;
            messageDiv.innerHTML = message;
            resultsDiv.appendChild(messageDiv);
            
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function initializeSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const anonKey = document.getElementById('anonKey').value;
            const serviceKey = document.getElementById('serviceKey').value;

            if (!url || !anonKey) {
                addMessage('‚ùå <strong>Erro:</strong> Preencha URL e Anon Key', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, anonKey);
                if (serviceKey) {
                    supabaseAdmin = window.supabase.createClient(url, serviceKey);
                }
                
                addMessage('‚úÖ <strong>Supabase configurado com sucesso!</strong>', 'success');
                
                // Habilitar bot√µes
                document.querySelectorAll('button[disabled]').forEach(btn => {
                    btn.disabled = false;
                });
                
            } catch (error) {
                addMessage(`‚ùå <strong>Erro ao configurar Supabase:</strong> ${error.message}`, 'error');
            }
        }

        async function loginAsAdmin1() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                addMessage('üîê <strong>Tentando login como Admin 1...</strong>', 'info');
                
                // Tentar login com credenciais de teste
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin1@teste.com',
                    password: 'admin123456'
                });

                if (error) {
                    addMessage(`‚ùå <strong>Erro no login:</strong> ${error.message}`, 'error');
                } else {
                    currentUser = data.user;
                    addMessage(`‚úÖ <strong>Login realizado como Admin 1:</strong> ${data.user.email}`, 'success');
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function loginAsAdmin2() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                addMessage('üîê <strong>Tentando login como Admin 2...</strong>', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin2@teste.com',
                    password: 'admin123456'
                });

                if (error) {
                    addMessage(`‚ùå <strong>Erro no login:</strong> ${error.message}`, 'error');
                } else {
                    currentUser = data.user;
                    addMessage(`‚úÖ <strong>Login realizado como Admin 2:</strong> ${data.user.email}`, 'success');
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function checkCurrentUser() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session?.user) {
                    addMessage('‚ö†Ô∏è <strong>Nenhum usu√°rio logado</strong>', 'warning');
                    return;
                }

                addMessage(`üë§ <strong>Usu√°rio atual:</strong> ${session.user.email}`, 'info');

                // Buscar empresa do usu√°rio
                const { data: usuarioEmpresa, error } = await supabase
                    .from('usuarios_empresa')
                    .select(`
                        empresa_id,
                        nome_completo,
                        tipo_usuario,
                        empresas!inner(nome, cnpj)
                    `)
                    .eq('user_id', session.user.id)
                    .single();

                if (error) {
                    addMessage(`‚ùå <strong>Erro ao buscar empresa:</strong> ${error.message}`, 'error');
                } else if (usuarioEmpresa) {
                    addMessage(`üè¢ <strong>Empresa:</strong> ${usuarioEmpresa.empresas.nome} (${usuarioEmpresa.empresas.cnpj})<br>
                               <strong>ID da Empresa:</strong> ${usuarioEmpresa.empresa_id}<br>
                               <strong>Tipo:</strong> ${usuarioEmpresa.tipo_usuario}`, 'success');
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function logout() {
            if (!supabase) return;

            try {
                await supabase.auth.signOut();
                currentUser = null;
                addMessage('üö™ <strong>Logout realizado com sucesso</strong>', 'success');
            } catch (error) {
                addMessage(`‚ùå <strong>Erro no logout:</strong> ${error.message}`, 'error');
            }
        }

        async function testNewSecureHook() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                addMessage('üõ°Ô∏è <strong>Testando fun√ß√£o getCurrentUserEmpresaId()...</strong>', 'info');
                
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session?.user) {
                    addMessage('‚ö†Ô∏è <strong>Nenhum usu√°rio logado</strong>', 'warning');
                    return;
                }

                // Simular a fun√ß√£o getCurrentUserEmpresaId
                const { data, error } = await supabase
                    .from('usuarios_empresa')
                    .select('empresa_id')
                    .eq('user_id', session.user.id)
                    .eq('ativo', true)
                    .limit(1);

                if (error) {
                    addMessage(`‚ùå <strong>Erro na verifica√ß√£o:</strong> ${error.message}`, 'error');
                } else if (!data || data.length === 0) {
                    addMessage('‚ö†Ô∏è <strong>Usu√°rio n√£o associado a nenhuma empresa</strong>', 'warning');
                } else {
                    const empresaId = data[0]?.empresa_id;
                    addMessage(`‚úÖ <strong>EmpresaId obtido com seguran√ßa:</strong> ${empresaId}`, 'success');
                    
                    // Testar se consegue acessar dados de outra empresa
                    const outrasEmpresas = ['00000000-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111'];
                    const empresaInvalida = outrasEmpresas.find(id => id !== empresaId);
                    
                    if (empresaInvalida) {
                        addMessage(`üîí <strong>Testando acesso a empresa n√£o autorizada...</strong>`, 'info');
                        
                        // Tentar buscar funcion√°rios de outra empresa (deve falhar)
                        const { data: funcionariosInvalidos, error: errorInvalido } = await supabase
                            .from('bar_employees')
                            .select('*')
                            .eq('empresa_id', empresaInvalida);

                        if (errorInvalido) {
                            addMessage(`‚úÖ <strong>Acesso negado corretamente:</strong> ${errorInvalido.message}`, 'success');
                        } else if (!funcionariosInvalidos || funcionariosInvalidos.length === 0) {
                            addMessage(`‚úÖ <strong>Isolamento funcionando:</strong> Nenhum dado de outra empresa acess√≠vel`, 'success');
                        } else {
                            addMessage(`üö® <strong>VAZAMENTO DETECTADO!</strong> Acessou ${funcionariosInvalidos.length} funcion√°rios de outra empresa`, 'error');
                        }
                    }
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function createTestEmployee() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session?.user) {
                    addMessage('‚ö†Ô∏è <strong>Fa√ßa login primeiro</strong>', 'warning');
                    return;
                }

                addMessage('‚ûï <strong>Criando funcion√°rio teste com verifica√ß√£o de seguran√ßa...</strong>', 'info');

                // Obter empresa do usu√°rio atual
                const { data: userData, error: userError } = await supabase
                    .from('usuarios_empresa')
                    .select('empresa_id')
                    .eq('user_id', session.user.id)
                    .single();

                if (userError || !userData) {
                    addMessage(`‚ùå <strong>Erro ao obter empresa:</strong> ${userError?.message || 'Empresa n√£o encontrada'}`, 'error');
                    return;
                }

                const empresaId = userData.empresa_id;
                const funcionarioTeste = {
                    nome: `Funcion√°rio Teste ${new Date().getTime()}`,
                    email: `teste${new Date().getTime()}@empresa.com`,
                    cargo: 'Gar√ßom',
                    setor: 'Atendimento',
                    data_admissao: new Date().toISOString().split('T')[0],
                    empresa_id: empresaId,
                    tem_acesso_sistema: false,
                    ativo: true,
                    auth_user_id: null
                };

                // Criar funcion√°rio b√°sico
                const { data: funcionario, error: createError } = await supabase
                    .from('bar_employees')
                    .insert(funcionarioTeste)
                    .select()
                    .single();

                if (createError) {
                    addMessage(`‚ùå <strong>Erro ao criar funcion√°rio:</strong> ${createError.message}`, 'error');
                } else {
                    addMessage(`‚úÖ <strong>Funcion√°rio criado com seguran√ßa:</strong><br>
                               ‚Ä¢ Nome: ${funcionario.nome}<br>
                               ‚Ä¢ Email: ${funcionario.email}<br>
                               ‚Ä¢ Empresa ID: ${funcionario.empresa_id}<br>
                               ‚Ä¢ Acesso Sistema: ${funcionario.tem_acesso_sistema ? 'Sim' : 'N√£o'}`, 'success');
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function listEmployeesSecure() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session?.user) {
                    addMessage('‚ö†Ô∏è <strong>Fa√ßa login primeiro</strong>', 'warning');
                    return;
                }

                addMessage('üìã <strong>Listando funcion√°rios com verifica√ß√£o de seguran√ßa...</strong>', 'info');

                // Obter empresa do usu√°rio atual (fun√ß√£o de seguran√ßa)
                const { data: userData, error: userError } = await supabase
                    .from('usuarios_empresa')
                    .select('empresa_id')
                    .eq('user_id', session.user.id)
                    .single();

                if (userError || !userData) {
                    addMessage(`‚ùå <strong>Acesso negado:</strong> Usu√°rio n√£o associado a empresa`, 'error');
                    return;
                }

                const empresaId = userData.empresa_id;

                // Listar apenas funcion√°rios da empresa do usu√°rio
                const { data: funcionarios, error } = await supabase
                    .from('bar_employees')
                    .select('*')
                    .eq('empresa_id', empresaId)
                    .eq('ativo', true)
                    .order('nome');

                if (error) {
                    addMessage(`‚ùå <strong>Erro ao listar funcion√°rios:</strong> ${error.message}`, 'error');
                } else {
                    addMessage(`‚úÖ <strong>Funcion√°rios encontrados (apenas da sua empresa):</strong> ${funcionarios.length}`, 'success');
                    
                    if (funcionarios.length > 0) {
                        let html = '<div style="margin-top: 15px;">';
                        funcionarios.slice(0, 5).forEach(func => {
                            const acessoIcon = func.tem_acesso_sistema ? 'üîì' : 'üîí';
                            html += `
                                <div class="employee-card">
                                    <strong>${func.nome}</strong> (${func.email})<br>
                                    <span style="color: #666;">
                                        ${acessoIcon} Cargo: ${func.cargo} | 
                                        Acesso: ${func.tem_acesso_sistema ? 'Sim' : 'N√£o'}
                                    </span>
                                </div>
                            `;
                        });
                        if (funcionarios.length > 5) {
                            html += `<div>... e mais ${funcionarios.length - 5} funcion√°rios</div>`;
                        }
                        html += '</div>';
                        addMessage(html, 'success');
                    }
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        async function testCrossCompanyAccess() {
            if (!supabase) {
                addMessage('‚ùå Configure o Supabase primeiro', 'error');
                return;
            }

            try {
                addMessage('‚ö†Ô∏è <strong>Testando tentativa de acesso entre empresas...</strong>', 'warning');

                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session?.user) {
                    addMessage('‚ö†Ô∏è <strong>Fa√ßa login primeiro</strong>', 'warning');
                    return;
                }

                // Buscar todas as empresas
                const { data: empresas, error: empresasError } = await supabase
                    .from('empresas')
                    .select('id, nome')
                    .limit(5);

                if (empresasError) {
                    addMessage(`‚ùå <strong>Erro ao buscar empresas:</strong> ${empresasError.message}`, 'error');
                    return;
                }

                // Obter empresa do usu√°rio atual
                const { data: userData, error: userError } = await supabase
                    .from('usuarios_empresa')
                    .select('empresa_id')
                    .eq('user_id', session.user.id)
                    .single();

                if (userError || !userData) {
                    addMessage(`‚ùå <strong>Erro ao obter empresa do usu√°rio</strong>`, 'error');
                    return;
                }

                const minhaEmpresa = userData.empresa_id;
                const outrasEmpresas = empresas.filter(e => e.id !== minhaEmpresa);

                addMessage(`üîç <strong>Sua empresa:</strong> ${minhaEmpresa.slice(0,8)}...`, 'info');
                addMessage(`üîç <strong>Testando acesso a ${outrasEmpresas.length} outras empresas...</strong>`, 'info');

                let problemasDetectados = 0;

                for (const empresa of outrasEmpresas.slice(0, 2)) {
                    const { data: funcionariosOutraEmpresa, error } = await supabase
                        .from('bar_employees')
                        .select('id, nome, email')
                        .eq('empresa_id', empresa.id);

                    if (error) {
                        addMessage(`‚úÖ <strong>Acesso negado para empresa ${empresa.id.slice(0,8)}...</strong> (${error.message})`, 'success');
                    } else if (!funcionariosOutraEmpresa || funcionariosOutraEmpresa.length === 0) {
                        addMessage(`‚úÖ <strong>Nenhum dado acess√≠vel da empresa ${empresa.id.slice(0,8)}...</strong>`, 'success');
                    } else {
                        addMessage(`üö® <strong>VAZAMENTO!</strong> Acessou ${funcionariosOutraEmpresa.length} funcion√°rios da empresa ${empresa.id.slice(0,8)}...`, 'error');
                        problemasDetectados++;
                    }
                }

                if (problemasDetectados === 0) {
                    addMessage(`üéâ <strong>ISOLAMENTO FUNCIONANDO PERFEITAMENTE!</strong> Nenhum vazamento detectado.`, 'success');
                } else {
                    addMessage(`‚ö†Ô∏è <strong>PROBLEMA DE SEGURAN√áA!</strong> Detectados ${problemasDetectados} vazamentos entre empresas.`, 'error');
                }

            } catch (error) {
                addMessage(`‚ùå <strong>Erro inesperado:</strong> ${error.message}`, 'error');
            }
        }

        // Carregar configura√ß√µes salvas
        window.addEventListener('load', () => {
            const savedUrl = localStorage.getItem('supabase_url');
            const savedAnonKey = localStorage.getItem('supabase_anon_key');
            const savedServiceKey = localStorage.getItem('supabase_service_key');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedAnonKey) document.getElementById('anonKey').value = savedAnonKey;
            if (savedServiceKey) document.getElementById('serviceKey').value = savedServiceKey;
        });

        // Salvar configura√ß√µes
        document.getElementById('supabaseUrl').addEventListener('change', (e) => {
            localStorage.setItem('supabase_url', e.target.value);
        });
        
        document.getElementById('anonKey').addEventListener('change', (e) => {
            localStorage.setItem('supabase_anon_key', e.target.value);
        });
        
        document.getElementById('serviceKey').addEventListener('change', (e) => {
            localStorage.setItem('supabase_service_key', e.target.value);
        });
    </script>
</body>
</html>