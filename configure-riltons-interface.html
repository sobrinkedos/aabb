<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Configurar Riltons como Primeiro Usu√°rio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .step {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .step h3 {
            color: #495057;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.running { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            border-left: 4px solid;
        }
        .message.info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        .message.success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .message.warning { background: #fff3e0; border-color: #ff9800; color: #f57c00; }
        .message.error { background: #ffebee; border-color: #f44336; color: #c62828; }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        .data-table th, .data-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .data-table td {
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Configurar Riltons como Primeiro Usu√°rio</h1>
        
        <div class="message info">
            <strong>üìã Este script ir√°:</strong>
            1. Verificar dados atuais do usu√°rio riltons@gmail.com
            2. Configur√°-lo como primeiro usu√°rio (is_primeiro_usuario = true)
            3. Ativar triggers autom√°ticos para criar:
               ‚Ä¢ public.configuracoes_empresa (5 categorias)
               ‚Ä¢ public.permissoes_usuario (10+ m√≥dulos)
               ‚Ä¢ public.logs_auditoria (registro da cria√ß√£o)
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="step">
            <h3>üîß Configura√ß√£o do Supabase</h3>
            <div>
                <label>URL do Supabase:</label>
                <input type="url" id="supabaseUrl" value="https://egfkflqhqfqagwzxppdo.supabase.co" style="width: 100%; padding: 8px; margin: 5px 0;">
            </div>
            <div>
                <label>Service Role Key:</label>
                <input type="password" id="supabaseKey" placeholder="Cole sua service role key aqui..." style="width: 100%; padding: 8px; margin: 5px 0;">
            </div>
            <button onclick="testConnection()">üîó Testar Conex√£o</button>
            <span id="connectionStatus" class="status pending">Aguardando teste</span>
        </div>
        
        <div class="step">
            <h3>üìä Status Atual</h3>
            <button onclick="checkCurrentStatus()">üîç Verificar Status Atual</button>
            <div id="currentStatusResult"></div>
        </div>
        
        <div class="step">
            <h3>üöÄ Executar Configura√ß√£o</h3>
            <button onclick="executeConfiguration()" id="executeBtn" disabled>üéØ Configurar como Primeiro Usu√°rio</button>
            <div id="executionResult"></div>
        </div>
        
        <div class="step">
            <h3>‚úÖ Verifica√ß√£o Final</h3>
            <button onclick="verifyResults()">üìã Verificar Resultados</button>
            <div id="verificationResult"></div>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        let supabase = null;
        let currentStep = 0;
        const totalSteps = 7;
        
        function updateProgress(step) {
            currentStep = step;
            const percentage = (step / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }
        
        function addMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
            messagesDiv.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            const statusSpan = document.getElementById('connectionStatus');
            
            if (!url || !key) {
                statusSpan.className = 'status error';
                statusSpan.textContent = 'URL e chave s√£o obrigat√≥rios';
                return;
            }
            
            try {
                statusSpan.className = 'status running';
                statusSpan.textContent = 'Testando...';
                
                supabase = window.supabase.createClient(url, key);
                
                // Teste b√°sico
                const { data, error } = await supabase
                    .from('empresas')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                statusSpan.className = 'status success';
                statusSpan.textContent = 'Conectado com sucesso!';
                document.getElementById('executeBtn').disabled = false;
                addMessage('üéâ Conex√£o com Supabase estabelecida!', 'success');
                updateProgress(1);
                
            } catch (error) {
                statusSpan.className = 'status error';
                statusSpan.textContent = `Erro: ${error.message}`;
                addMessage(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
            }
        }
        
        async function checkCurrentStatus() {
            if (!supabase) {
                addMessage('‚ùå Conecte-se ao Supabase primeiro!', 'error');
                return;
            }
            
            try {
                addMessage('üîç Verificando status atual do usu√°rio riltons@gmail.com...', 'info');
                updateProgress(2);
                
                // Verificar se existe no auth.users
                const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
                const riltonUser = authUsers?.users?.find(u => u.email === 'riltons@gmail.com');
                
                const resultDiv = document.getElementById('currentStatusResult');
                let html = '<h4>üìä Status Atual:</h4>';
                
                if (riltonUser) {
                    html += `<div class="message success">‚úÖ Usu√°rio encontrado no auth.users - ID: ${riltonUser.id}</div>`;
                    
                    // Verificar usuarios_empresa
                    const { data: usuariosEmpresa, error: ueError } = await supabase
                        .from('usuarios_empresa')
                        .select('*')
                        .eq('user_id', riltonUser.id);
                    
                    if (usuariosEmpresa && usuariosEmpresa.length > 0) {
                        const usuario = usuariosEmpresa[0];
                        html += `<div class="message info">üìã Dados em usuarios_empresa:
- Nome: ${usuario.nome_completo}
- Email: ${usuario.email}
- Papel: ${usuario.papel}
- Primeiro usu√°rio: ${usuario.is_primeiro_usuario ? 'SIM' : 'N√ÉO'}
- Status: ${usuario.status}</div>`;
                        
                        // Verificar configura√ß√µes
                        const { data: configs } = await supabase
                            .from('configuracoes_empresa')
                            .select('*')
                            .eq('empresa_id', usuario.empresa_id);
                        
                        html += `<div class="message info">‚öôÔ∏è Configura√ß√µes da empresa: ${configs?.length || 0} registros</div>`;
                        
                        // Verificar permiss√µes
                        const { data: perms } = await supabase
                            .from('permissoes_usuario')
                            .select('*')
                            .eq('usuario_empresa_id', usuario.id);
                        
                        html += `<div class="message info">üîê Permiss√µes do usu√°rio: ${perms?.length || 0} registros</div>`;
                        
                    } else {
                        html += `<div class="message warning">‚ö†Ô∏è Usu√°rio N√ÉO encontrado em usuarios_empresa</div>`;
                    }
                    
                } else {
                    html += `<div class="message error">‚ùå Usu√°rio N√ÉO encontrado no auth.users</div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                addMessage(`‚ùå Erro ao verificar status: ${error.message}`, 'error');
            }
        }
        
        async function executeConfiguration() {
            if (!supabase) {
                addMessage('‚ùå Conecte-se ao Supabase primeiro!', 'error');
                return;
            }
            
            try {
                addMessage('üöÄ Iniciando configura√ß√£o do primeiro usu√°rio...', 'info');
                updateProgress(3);
                
                const resultDiv = document.getElementById('executionResult');
                let html = '<h4>üîÑ Executando configura√ß√£o:</h4>';
                
                // Passo 1: Verificar/criar empresa
                addMessage('üìä Verificando empresa...', 'info');
                let { data: empresas, error: empresaError } = await supabase
                    .from('empresas')
                    .select('*')
                    .limit(1);
                
                let empresaId;
                if (!empresas || empresas.length === 0) {
                    addMessage('üè¢ Criando empresa AABB Garanhuns...', 'info');
                    const { data: novaEmpresa, error: criarEmpresaError } = await supabase
                        .from('empresas')
                        .insert({
                            nome: 'AABB Garanhuns',
                            cnpj: '12.345.678/0001-90',
                            email_admin: 'riltons@gmail.com',
                            telefone: '(87) 99999-9999',
                            plano: 'premium',
                            status: 'ativo',
                            configuracoes: { tema: 'claro', primeira_configuracao: true }
                        })
                        .select()
                        .single();
                    
                    if (criarEmpresaError) throw criarEmpresaError;
                    empresaId = novaEmpresa.id;
                    html += `<div class="message success">‚úÖ Empresa criada - ID: ${empresaId}</div>`;
                } else {
                    empresaId = empresas[0].id;
                    html += `<div class="message info">‚ÑπÔ∏è Empresa existente - ID: ${empresaId}</div>`;
                }
                
                updateProgress(4);
                
                // Passo 2: Verificar usu√°rio auth
                addMessage('üë§ Verificando usu√°rio no auth...', 'info');
                const { data: authUsers } = await supabase.auth.admin.listUsers();
                const riltonUser = authUsers?.users?.find(u => u.email === 'riltons@gmail.com');
                
                if (!riltonUser) {
                    html += `<div class="message error">‚ùå Usu√°rio riltons@gmail.com n√£o encontrado no auth.users. Crie primeiro!</div>`;
                    resultDiv.innerHTML = html;
                    return;
                }
                
                html += `<div class="message success">‚úÖ Usu√°rio encontrado no auth - ID: ${riltonUser.id}</div>`;
                updateProgress(5);
                
                // Passo 3: Limpar dados existentes
                addMessage('üßπ Limpando dados existentes...', 'info');
                
                // Remover configura√ß√µes
                await supabase
                    .from('configuracoes_empresa')
                    .delete()
                    .eq('empresa_id', empresaId);
                
                // Remover usuarios_empresa existente
                const { data: usuarioExistente } = await supabase
                    .from('usuarios_empresa')
                    .select('id')
                    .eq('user_id', riltonUser.id)
                    .eq('empresa_id', empresaId)
                    .single();
                
                if (usuarioExistente) {
                    await supabase
                        .from('permissoes_usuario')
                        .delete()
                        .eq('usuario_empresa_id', usuarioExistente.id);
                    
                    await supabase
                        .from('usuarios_empresa')
                        .delete()
                        .eq('id', usuarioExistente.id);
                }
                
                await supabase
                    .from('logs_auditoria')
                    .delete()
                    .eq('empresa_id', empresaId)
                    .eq('usuario_id', riltonUser.id);
                
                html += `<div class="message info">üóëÔ∏è Dados existentes limpos</div>`;
                updateProgress(6);
                
                // Passo 4: Criar como primeiro usu√°rio (ativa triggers)
                addMessage('üéØ Criando registro como primeiro usu√°rio (ativando triggers)...', 'info');
                
                const { data: novoUsuario, error: criarUsuarioError } = await supabase
                    .from('usuarios_empresa')
                    .insert({
                        user_id: riltonUser.id,
                        empresa_id: empresaId,
                        nome_completo: 'Rilton Silva',
                        email: 'riltons@gmail.com',
                        telefone: '(87) 99999-9999',
                        cargo: 'Diretor Geral',
                        tipo_usuario: 'administrador',
                        papel: 'SUPER_ADMIN',
                        is_primeiro_usuario: true, // üî• ATIVA TRIGGERS
                        status: 'ativo',
                        senha_provisoria: false
                    })
                    .select()
                    .single();
                
                if (criarUsuarioError) throw criarUsuarioError;
                
                html += `<div class="message success">üéâ PRIMEIRO USU√ÅRIO CRIADO - ID: ${novoUsuario.id}</div>`;
                html += `<div class="message success">üöÄ Triggers autom√°ticos foram ativados!</div>`;
                
                updateProgress(7);
                resultDiv.innerHTML = html;
                
                addMessage('‚úÖ Configura√ß√£o conclu√≠da com sucesso!', 'success');
                
                // Auto-verificar resultados ap√≥s 2 segundos
                setTimeout(() => {
                    verifyResults();
                }, 2000);
                
            } catch (error) {
                addMessage(`‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }
        
        async function verifyResults() {
            if (!supabase) {
                addMessage('‚ùå Conecte-se ao Supabase primeiro!', 'error');
                return;
            }
            
            try {
                addMessage('üìã Verificando resultados dos triggers autom√°ticos...', 'info');
                
                const resultDiv = document.getElementById('verificationResult');
                let html = '<h4>üìä Resultados da Configura√ß√£o:</h4>';
                
                // Buscar dados do usu√°rio
                const { data: authUsers } = await supabase.auth.admin.listUsers();
                const riltonUser = authUsers?.users?.find(u => u.email === 'riltons@gmail.com');
                
                if (!riltonUser) {
                    html += `<div class="message error">‚ùå Usu√°rio n√£o encontrado</div>`;
                    resultDiv.innerHTML = html;
                    return;
                }
                
                const { data: usuariosEmpresa } = await supabase
                    .from('usuarios_empresa')
                    .select('*')
                    .eq('user_id', riltonUser.id);
                
                if (!usuariosEmpresa || usuariosEmpresa.length === 0) {
                    html += `<div class="message error">‚ùå Usu√°rio n√£o encontrado em usuarios_empresa</div>`;
                    resultDiv.innerHTML = html;
                    return;
                }
                
                const usuario = usuariosEmpresa[0];
                
                // Verificar status do usu√°rio
                html += `<div class="message ${usuario.is_primeiro_usuario ? 'success' : 'error'}">
üë§ Status do Usu√°rio:
- Nome: ${usuario.nome_completo}
- Papel: ${usuario.papel}
- Primeiro usu√°rio: ${usuario.is_primeiro_usuario ? '‚úÖ SIM' : '‚ùå N√ÉO'}
- Status: ${usuario.status}
</div>`;
                
                // Verificar configura√ß√µes da empresa
                const { data: configs } = await supabase
                    .from('configuracoes_empresa')
                    .select('*')
                    .eq('empresa_id', usuario.empresa_id);
                
                html += `<div class="message ${configs && configs.length >= 5 ? 'success' : 'warning'}">
‚öôÔ∏è Configura√ß√µes da Empresa: ${configs?.length || 0} registros
${configs && configs.length >= 5 ? '‚úÖ Todas as categorias criadas' : '‚ö†Ô∏è Algumas categorias podem estar faltando'}
</div>`;
                
                if (configs && configs.length > 0) {
                    html += '<table class="data-table"><tr><th>Categoria</th><th>Configura√ß√µes</th></tr>';
                    configs.forEach(config => {
                        html += `<tr><td>${config.categoria}</td><td>${JSON.stringify(config.configuracoes, null, 2)}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                // Verificar permiss√µes
                const { data: perms } = await supabase
                    .from('permissoes_usuario')
                    .select('*')
                    .eq('usuario_empresa_id', usuario.id);
                
                html += `<div class="message ${perms && perms.length >= 10 ? 'success' : 'warning'}">
üîê Permiss√µes do Usu√°rio: ${perms?.length || 0} registros
${perms && perms.length >= 10 ? '‚úÖ Todas as permiss√µes criadas' : '‚ö†Ô∏è Algumas permiss√µes podem estar faltando'}
</div>`;
                
                if (perms && perms.length > 0) {
                    html += '<table class="data-table"><tr><th>M√≥dulo</th><th>Permiss√µes</th></tr>';
                    perms.forEach(perm => {
                        html += `<tr><td>${perm.modulo}</td><td>${JSON.stringify(perm.permissoes, null, 2)}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                // Verificar logs de auditoria
                const { data: logs } = await supabase
                    .from('logs_auditoria')
                    .select('*')
                    .eq('empresa_id', usuario.empresa_id)
                    .eq('usuario_id', riltonUser.id)
                    .eq('acao', 'PRIMEIRO_USUARIO_CRIADO');
                
                html += `<div class="message ${logs && logs.length > 0 ? 'success' : 'warning'}">
üìù Logs de Auditoria: ${logs?.length || 0} registros
${logs && logs.length > 0 ? '‚úÖ Log de cria√ß√£o registrado' : '‚ö†Ô∏è Log de cria√ß√£o n√£o encontrado'}
</div>`;
                
                if (logs && logs.length > 0) {
                    html += '<table class="data-table"><tr><th>A√ß√£o</th><th>Recurso</th><th>Detalhes</th><th>Data</th></tr>';
                    logs.forEach(log => {
                        html += `<tr>
                            <td>${log.acao}</td>
                            <td>${log.recurso}</td>
                            <td>${JSON.stringify(log.detalhes, null, 2)}</td>
                            <td>${new Date(log.created_at).toLocaleString()}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }
                
                // Resumo final
                const configsOk = configs && configs.length >= 5;
                const permsOk = perms && perms.length >= 10;
                const logsOk = logs && logs.length > 0;
                const isFirstUser = usuario.is_primeiro_usuario;
                
                if (configsOk && permsOk && logsOk && isFirstUser) {
                    html += `<div class="message success">
üéâ === CONFIGURA√á√ÉO CONCLU√çDA COM SUCESSO! ===
‚úÖ riltons@gmail.com configurado como primeiro usu√°rio
‚úÖ ${configs.length} configura√ß√µes da empresa criadas automaticamente
‚úÖ ${perms.length} permiss√µes completas atribu√≠das automaticamente
‚úÖ ${logs.length} log(s) de auditoria registrado(s) automaticamente

üöÄ Todos os triggers autom√°ticos funcionaram corretamente!
</div>`;
                } else {
                    html += `<div class="message warning">
‚ö†Ô∏è Configura√ß√£o parcialmente conclu√≠da
- Primeiro usu√°rio: ${isFirstUser ? '‚úÖ' : '‚ùå'}
- Configura√ß√µes: ${configsOk ? '‚úÖ' : '‚ùå'} (${configs?.length || 0}/5)
- Permiss√µes: ${permsOk ? '‚úÖ' : '‚ùå'} (${perms?.length || 0}/10+)
- Logs: ${logsOk ? '‚úÖ' : '‚ùå'} (${logs?.length || 0}/1)

Verifique se os triggers est√£o funcionando corretamente.
</div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                addMessage(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
            }
        }
        
        // Auto-focus no campo da chave
        document.getElementById('supabaseKey').focus();
    </script>
</body>
</html>