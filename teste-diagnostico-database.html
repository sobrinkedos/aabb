<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ DiagnÃ³stico Database - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            background: #f8f9ff;
        }
        .success { border-left-color: #10b981; background: #f0fdf4; }
        .error { border-left-color: #ef4444; background: #fef2f2; }
        .warning { border-left-color: #f59e0b; background: #fffbeb; }
        .info { border-left-color: #3b82f6; background: #eff6ff; }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #5a67d8; transform: translateY(-2px); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        
        .result {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e5e7eb;
        }
        
        .status-ok { border-color: #10b981; background: #f0fdf4; }
        .status-error { border-color: #ef4444; background: #fef2f2; }
        .status-warning { border-color: #f59e0b; background: #fffbeb; }
        
        .config-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .config-item:last-child { border-bottom: none; }
        
        .config-label {
            font-weight: 600;
            color: #374151;
        }
        
        .config-value {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6b7280;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .hidden-key {
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ DiagnÃ³stico Database - Supabase</h1>
            <p>Ferramenta para diagnosticar problemas de conectividade com o banco de dados</p>
        </div>

        <!-- ConfiguraÃ§Ãµes Atuais -->
        <div class="test-section info">
            <h3>ğŸ“‹ ConfiguraÃ§Ãµes Atuais</h3>
            <div class="config-display" id="configDisplay">
                <div class="config-item">
                    <span class="config-label">URL do Projeto:</span>
                    <span class="config-value" id="urlDisplay">Carregando...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Anon Key:</span>
                    <span class="config-value hidden-key" id="anonKeyDisplay">Carregando...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Service Key:</span>
                    <span class="config-value hidden-key" id="serviceKeyDisplay">Carregando...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Ambiente:</span>
                    <span class="config-value" id="environmentDisplay">Carregando...</span>
                </div>
            </div>
        </div>

        <!-- Status dos ServiÃ§os -->
        <div class="test-section">
            <h3>ğŸ” Status dos ServiÃ§os</h3>
            <div class="status-grid" id="statusGrid">
                <div class="status-card" id="urlStatus">
                    <h4>ğŸŒ URL do Projeto</h4>
                    <p id="urlStatusText">Verificando...</p>
                </div>
                <div class="status-card" id="authStatus">
                    <h4>ğŸ” AutenticaÃ§Ã£o</h4>
                    <p id="authStatusText">Verificando...</p>
                </div>
                <div class="status-card" id="dbStatus">
                    <h4>ğŸ—„ï¸ Database</h4>
                    <p id="dbStatusText">Verificando...</p>
                </div>
                <div class="status-card" id="rlsStatus">
                    <h4>ğŸ›¡ï¸ RLS Policies</h4>
                    <p id="rlsStatusText">Verificando...</p>
                </div>
            </div>
        </div>

        <!-- Testes de Conectividade -->
        <div class="test-section">
            <h3>ğŸ§ª Testes de Conectividade</h3>
            <button class="btn" onclick="testarConectividadeBasica()">ğŸ”Œ Teste BÃ¡sico</button>
            <button class="btn" onclick="testarAutenticacao()">ğŸ” Teste Auth</button>
            <button class="btn" onclick="testarDatabase()">ğŸ—„ï¸ Teste Database</button>
            <button class="btn" onclick="testarUsuarioRiltons()">ğŸ‘¤ Teste UsuÃ¡rio Riltons</button>
            <button class="btn" onclick="executarDiagnosticoCompleto()">ğŸ” DiagnÃ³stico Completo</button>
            
            <div class="result" id="testResults"></div>
        </div>

        <!-- SoluÃ§Ãµes Sugeridas -->
        <div class="test-section warning" id="solutionsSection" style="display: none;">
            <h3>ğŸ’¡ SoluÃ§Ãµes Sugeridas</h3>
            <div id="suggestedSolutions"></div>
        </div>
    </div>

    <script>
        // ConfiguraÃ§Ãµes do Supabase
        const SUPABASE_URL = 'https://jtfdzjmravketpkwjkvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZmR6am1yYXZrZXRwa3dqa3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjM1NjIsImV4cCI6MjA3MzkzOTU2Mn0.AOFSlSLFVw-pU1-lpUzxJ2fov3kR95eBlz_92mtSMgs';
        
        // Inicializar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let diagnosticResults = {
            url: null,
            auth: null,
            database: null,
            rls: null,
            user: null
        };

        // Carregar configuraÃ§Ãµes na inicializaÃ§Ã£o
        window.addEventListener('DOMContentLoaded', function() {
            carregarConfiguracoes();
            verificarStatusInicial();
        });

        function carregarConfiguracoes() {
            document.getElementById('urlDisplay').textContent = SUPABASE_URL;
            document.getElementById('anonKeyDisplay').textContent = SUPABASE_ANON_KEY.substring(0, 20) + '...';
            document.getElementById('serviceKeyDisplay').textContent = 'NÃ£o disponÃ­vel no frontend';
            document.getElementById('environmentDisplay').textContent = 'PRODUÃ‡ÃƒO';
        }

        async function verificarStatusInicial() {
            await Promise.all([
                verificarURL(),
                verificarAuth(),
                verificarDatabase(),
                verificarRLS()
            ]);
        }

        async function verificarURL() {
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (response.ok) {
                    updateStatus('urlStatus', 'ok', 'âœ… URL AcessÃ­vel');
                    diagnosticResults.url = true;
                } else {
                    updateStatus('urlStatus', 'error', 'âŒ URL InacessÃ­vel');
                    diagnosticResults.url = false;
                }
            } catch (error) {
                updateStatus('urlStatus', 'error', 'âŒ Erro de Rede');
                diagnosticResults.url = false;
            }
        }

        async function verificarAuth() {
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    updateStatus('authStatus', 'warning', 'âš ï¸ NÃ£o Autenticado');
                    diagnosticResults.auth = false;
                } else {
                    updateStatus('authStatus', 'ok', 'âœ… Auth Funcionando');
                    diagnosticResults.auth = true;
                }
            } catch (error) {
                updateStatus('authStatus', 'error', 'âŒ Erro Auth');
                diagnosticResults.auth = false;
            }
        }

        async function verificarDatabase() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    updateStatus('dbStatus', 'error', 'âŒ DB InacessÃ­vel');
                    diagnosticResults.database = false;
                    log('âŒ Erro Database: ' + error.message);
                } else {
                    updateStatus('dbStatus', 'ok', 'âœ… DB Conectado');
                    diagnosticResults.database = true;
                }
            } catch (error) {
                updateStatus('dbStatus', 'error', 'âŒ Erro DB');
                diagnosticResults.database = false;
            }
        }

        async function verificarRLS() {
            try {
                const { data, error } = await supabase
                    .from('usuarios_empresa')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('RLS') || error.message.includes('policy')) {
                        updateStatus('rlsStatus', 'warning', 'âš ï¸ RLS Restritivo');
                        diagnosticResults.rls = 'restrictive';
                    } else {
                        updateStatus('rlsStatus', 'error', 'âŒ RLS Erro');
                        diagnosticResults.rls = false;
                    }
                } else {
                    updateStatus('rlsStatus', 'ok', 'âœ… RLS OK');
                    diagnosticResults.rls = true;
                }
            } catch (error) {
                updateStatus('rlsStatus', 'error', 'âŒ RLS Erro');
                diagnosticResults.rls = false;
            }
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = 'status-card status-' + status;
            element.querySelector('p').textContent = text;
        }

        async function testarConectividadeBasica() {
            log('ğŸ”Œ Iniciando teste de conectividade bÃ¡sica...');
            
            try {
                // Teste 1: Ping bÃ¡sico
                log('ğŸ“¡ Testando ping para o servidor...');
                const startTime = Date.now();
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: { 'apikey': SUPABASE_ANON_KEY }
                });
                const endTime = Date.now();
                
                if (response.ok) {
                    log('âœ… Servidor respondeu em ' + (endTime - startTime) + 'ms');
                    log('ğŸ“‹ Status: ' + response.status + ' ' + response.statusText);
                    log('ğŸ”‘ Headers recebidos: ' + JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2));
                } else {
                    log('âŒ Servidor retornou erro: ' + response.status + ' ' + response.statusText);
                }
                
                // Teste 2: Verificar chave API
                log('ğŸ” Testando chave API...');
                const { data: authData, error: authError } = await supabase.auth.getSession();
                
                if (authError) {
                    log('âš ï¸ Auth nÃ£o inicializado: ' + authError.message);
                } else {
                    log('âœ… Cliente Supabase inicializado corretamente');
                }
                
            } catch (error) {
                log('âŒ Erro na conectividade bÃ¡sica: ' + error.message);
            }
        }

        async function testarAutenticacao() {
            log('ğŸ” Iniciando teste de autenticaÃ§Ã£o...');
            
            try {
                // Teste 1: Verificar sessÃ£o atual
                log('ğŸ‘¤ Verificando sessÃ£o atual...');
                const { data: session, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log('âŒ Erro ao obter sessÃ£o: ' + sessionError.message);
                } else if (session.session) {
                    log('âœ… UsuÃ¡rio autenticado: ' + session.session.user.email);
                    log('ğŸ”‘ Token vÃ¡lido atÃ©: ' + new Date(session.session.expires_at * 1000));
                } else {
                    log('âš ï¸ Nenhum usuÃ¡rio autenticado');
                }
                
                // Teste 2: Verificar usuÃ¡rio atual
                log('ğŸ‘¤ Verificando usuÃ¡rio atual...');
                const { data: user, error: userError } = await supabase.auth.getUser();
                
                if (userError) {
                    log('âŒ Erro ao obter usuÃ¡rio: ' + userError.message);
                } else if (user.user) {
                    log('âœ… UsuÃ¡rio encontrado: ' + user.user.email);
                    log('ğŸ“‹ ID: ' + user.user.id);
                    log('ğŸ“… Criado em: ' + user.user.created_at);
                } else {
                    log('âš ï¸ Nenhum usuÃ¡rio encontrado');
                }
                
            } catch (error) {
                log('âŒ Erro no teste de autenticaÃ§Ã£o: ' + error.message);
            }
        }

        async function testarDatabase() {
            log('ğŸ—„ï¸ Iniciando teste de database...');
            
            try {
                // Teste 1: Query simples
                log('ğŸ“Š Executando query simples...');
                const { data: simpleData, error: simpleError } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);
                
                if (simpleError) {
                    log('âŒ Erro na query simples: ' + simpleError.message);
                    log('ğŸ” Detalhes: ' + JSON.stringify(simpleError, null, 2));
                } else {
                    log('âœ… Query simples executada com sucesso');
                }
                
                // Teste 2: Verificar tabelas principais
                log('ğŸ“‹ Verificando tabelas principais...');
                const tabelas = ['profiles', 'usuarios_empresa', 'empresas', 'permissoes_usuario'];
                
                for (const tabela of tabelas) {
                    try {
                        const { data, error } = await supabase
                            .from(tabela)
                            .select('*')
                            .limit(1);
                        
                        if (error) {
                            log('âŒ Tabela ' + tabela + ': ' + error.message);
                        } else {
                            log('âœ… Tabela ' + tabela + ': AcessÃ­vel');
                        }
                    } catch (err) {
                        log('âŒ Tabela ' + tabela + ': Erro de acesso');
                    }
                }
                
            } catch (error) {
                log('âŒ Erro no teste de database: ' + error.message);
            }
        }

        async function testarUsuarioRiltons() {
            log('ğŸ‘¤ Iniciando teste especÃ­fico do usuÃ¡rio riltons@gmail.com...');
            
            try {
                // Teste 1: Verificar na tabela profiles
                log('ğŸ” Buscando na tabela profiles...');
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .limit(10);
                
                if (profileError) {
                    log('âŒ Erro ao buscar profiles: ' + profileError.message);
                } else {
                    log('âœ… Profiles encontrados: ' + profileData.length);
                    const riltonProfile = profileData.find(p => p.name && p.name.toLowerCase().includes('rilton'));
                    if (riltonProfile) {
                        log('âœ… Profile Rilton encontrado: ' + JSON.stringify(riltonProfile, null, 2));
                    } else {
                        log('âš ï¸ Profile Rilton nÃ£o encontrado nos primeiros 10 registros');
                    }
                }
                
                // Teste 2: Verificar na tabela usuarios_empresa
                log('ğŸ” Buscando na tabela usuarios_empresa...');
                const { data: usuarioData, error: usuarioError } = await supabase
                    .from('usuarios_empresa')
                    .select('*')
                    .limit(10);
                
                if (usuarioError) {
                    log('âŒ Erro ao buscar usuarios_empresa: ' + usuarioError.message);
                } else {
                    log('âœ… UsuÃ¡rios empresa encontrados: ' + usuarioData.length);
                    const riltonUsuario = usuarioData.find(u => u.email === 'riltons@gmail.com');
                    if (riltonUsuario) {
                        log('âœ… UsuÃ¡rio Rilton encontrado: ' + JSON.stringify(riltonUsuario, null, 2));
                    } else {
                        log('âš ï¸ UsuÃ¡rio riltons@gmail.com nÃ£o encontrado');
                    }
                }
                
                // Teste 3: Verificar permissÃµes
                log('ğŸ” Verificando permissÃµes...');
                const { data: permissaoData, error: permissaoError } = await supabase
                    .from('permissoes_usuario')
                    .select('*')
                    .limit(10);
                
                if (permissaoError) {
                    log('âŒ Erro ao buscar permissÃµes: ' + permissaoError.message);
                } else {
                    log('âœ… PermissÃµes encontradas: ' + permissaoData.length);
                    log('ğŸ“‹ Primeiras permissÃµes: ' + JSON.stringify(permissaoData.slice(0, 3), null, 2));
                }
                
            } catch (error) {
                log('âŒ Erro no teste do usuÃ¡rio Riltons: ' + error.message);
            }
        }

        async function executarDiagnosticoCompleto() {
            log('ğŸ” Iniciando diagnÃ³stico completo...');
            log('=' .repeat(50));
            
            await testarConectividadeBasica();
            log('');
            await testarAutenticacao();
            log('');
            await testarDatabase();
            log('');
            await testarUsuarioRiltons();
            log('');
            
            // Gerar relatÃ³rio final
            log('ğŸ“Š RELATÃ“RIO FINAL:');
            log('=' .repeat(30));
            log('ğŸŒ URL: ' + (diagnosticResults.url ? 'âœ… OK' : 'âŒ FALHA'));
            log('ğŸ” Auth: ' + (diagnosticResults.auth ? 'âœ… OK' : 'âŒ FALHA'));
            log('ğŸ—„ï¸ Database: ' + (diagnosticResults.database ? 'âœ… OK' : 'âŒ FALHA'));
            log('ğŸ›¡ï¸ RLS: ' + (diagnosticResults.rls === true ? 'âœ… OK' : diagnosticResults.rls === 'restrictive' ? 'âš ï¸ RESTRITIVO' : 'âŒ FALHA'));
            
            // Mostrar soluÃ§Ãµes se houver problemas
            mostrarSolucoes();
        }

        function mostrarSolucoes() {
            const solutions = [];
            
            if (!diagnosticResults.url) {
                solutions.push('ğŸŒ Problema de URL: Verifique se a URL do Supabase estÃ¡ correta e se hÃ¡ conectividade com a internet.');
            }
            
            if (!diagnosticResults.auth) {
                solutions.push('ğŸ” Problema de Auth: Verifique se a chave anon estÃ¡ correta. Tente fazer login no sistema.');
            }
            
            if (!diagnosticResults.database) {
                solutions.push('ğŸ—„ï¸ Problema de Database: Verifique as polÃ­ticas RLS. Pode ser necessÃ¡rio usar service_role key para operaÃ§Ãµes administrativas.');
            }
            
            if (diagnosticResults.rls === 'restrictive') {
                solutions.push('ğŸ›¡ï¸ RLS Restritivo: As polÃ­ticas de seguranÃ§a estÃ£o bloqueando o acesso. FaÃ§a login como usuÃ¡rio autenticado ou use service_role key.');
            }
            
            if (solutions.length > 0) {
                document.getElementById('solutionsSection').style.display = 'block';
                document.getElementById('suggestedSolutions').innerHTML = solutions.map(s => '<p>â€¢ ' + s + '</p>').join('');
            }
        }

        function log(message) {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += '[' + timestamp + '] ' + message + '\\n';
            results.scrollTop = results.scrollHeight;
        }
    </script>
</body>
</html>