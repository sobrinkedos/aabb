<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Permiss√µes Din√¢micas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .success { background-color: #d4edda; border: 2px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 8px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .user-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .step { background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="test-section">
        <h1>üß™ Teste Permiss√µes Din√¢micas</h1>
        <p>Testar se o sistema est√° buscando e aplicando permiss√µes espec√≠ficas do banco de dados</p>
        
        <div class="info">
            <strong>‚úÖ Corre√ß√µes Aplicadas:</strong><br>
            1. Sistema agora busca permiss√µes espec√≠ficas mesmo em modo fallback<br>
            2. Quando h√° permiss√µes espec√≠ficas, usa APENAS elas (n√£o as padr√µes do role)<br>
            3. Logs detalhados para debug
        </div>
        
        <button onclick="testarPermissoesDinamicas()" id="btn-teste">üß™ Testar Sistema de Permiss√µes</button>
        
        <div id="resultado-teste"></div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://wznycskqsavpmejwpksp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6bnljc2txc2F2cG1landwa3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzA2NjUsImV4cCI6MjA3MjIwNjY2NX0.uYXbBwQDo1pLeBrmtZnBR2M3a3_TsYDa637pcKSVC_8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function testarPermissoesDinamicas() {
            try {
                document.getElementById('resultado-teste').innerHTML = `
                    <div class="info">üîÑ Testando sistema de permiss√µes din√¢micas...</div>
                `;

                // Passo 1: Login como admin
                console.log('üîê Fazendo login como admin...');
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: 'riltons@gmail.com',
                    password: '000000'
                });

                if (authError) {
                    throw new Error(`Erro no login: ${authError.message}`);
                }

                const empresaId = '9e445c5a-a382-444d-94f8-9d126ed6414e';
                console.log('‚úÖ Login realizado como admin');

                let html = `<div class="step"><h3>Passo 1: Login Admin ‚úÖ</h3></div>`;

                // Passo 2: Buscar todos os usu√°rios empresa
                console.log('üë• Buscando usu√°rios empresa...');
                const { data: usuariosEmpresa, error: usuariosError } = await supabase
                    .from('usuarios_empresa')
                    .select('*')
                    .eq('empresa_id', empresaId)
                    .eq('status', 'ativo')
                    .order('nome_completo');

                if (usuariosError) {
                    throw new Error(`Erro ao buscar usu√°rios: ${usuariosError.message}`);
                }

                html += `
                    <div class="step">
                        <h3>Passo 2: Usu√°rios Encontrados ‚úÖ</h3>
                        <p>Total: ${usuariosEmpresa?.length || 0} usu√°rios ativos</p>
                    </div>
                `;

                // Passo 3: Para cada usu√°rio, buscar suas permiss√µes
                if (usuariosEmpresa && usuariosEmpresa.length > 0) {
                    html += `<h3>üë• An√°lise de Permiss√µes por Usu√°rio:</h3>`;
                    
                    for (const usuario of usuariosEmpresa.slice(0, 10)) { // Limitar a 10 para n√£o sobrecarregar
                        console.log(`üîç Analisando usu√°rio: ${usuario.nome_completo}`);
                        
                        // Buscar permiss√µes espec√≠ficas
                        const { data: permissoes, error: permError } = await supabase
                            .from('permissoes_usuario')
                            .select('modulo, permissoes')
                            .eq('usuario_empresa_id', usuario.id);

                        if (permError) {
                            console.warn(`Erro ao buscar permiss√µes para ${usuario.nome_completo}:`, permError);
                        }

                        const temPermissoesEspecificas = permissoes && permissoes.length > 0;
                        
                        html += `
                            <div class="user-card">
                                <h4>üë§ ${usuario.nome_completo}</h4>
                                <p><strong>Email:</strong> ${usuario.email}</p>
                                <p><strong>Cargo:</strong> ${usuario.cargo}</p>
                                <p><strong>Tipo:</strong> ${usuario.tipo_usuario}</p>
                                <p><strong>Permiss√µes Espec√≠ficas:</strong> 
                                    <span style="background: ${temPermissoesEspecificas ? '#d4edda' : '#f8d7da'}; padding: 2px 5px; border-radius: 3px;">
                                        ${temPermissoesEspecificas ? `‚úÖ ${permissoes.length} m√≥dulos configurados` : '‚ùå Nenhuma (usa padr√µes do role)'}
                                    </span>
                                </p>
                        `;

                        if (temPermissoesEspecificas) {
                            html += `
                                <details>
                                    <summary>üìã Ver Permiss√µes Espec√≠ficas</summary>
                                    <table>
                                        <tr><th>M√≥dulo</th><th>Permiss√µes</th></tr>
                            `;
                            
                            permissoes.forEach(perm => {
                                html += `
                                    <tr>
                                        <td><strong>${perm.modulo}</strong></td>
                                        <td><pre>${JSON.stringify(perm.permissoes, null, 2)}</pre></td>
                                    </tr>
                                `;
                            });
                            
                            html += `</table></details>`;
                        }
                        
                        html += `</div>`;
                    }
                }

                // Passo 4: Criar um usu√°rio de teste com permiss√µes espec√≠ficas
                html += `
                    <div class="step">
                        <h3>Passo 4: Teste de Permiss√µes Espec√≠ficas</h3>
                        <p>Vamos criar um usu√°rio de teste com permiss√µes espec√≠ficas apenas para "gestao_caixa"</p>
                    </div>
                `;

                // Criar usu√°rio de teste
                const testUserData = {
                    user_id: 'test-user-' + Date.now(),
                    empresa_id: empresaId,
                    nome_completo: 'Usu√°rio Teste Permiss√µes',
                    email: 'teste.permissoes@exemplo.com',
                    cargo: 'Operador de Caixa Teste',
                    tipo_usuario: 'funcionario',
                    status: 'ativo',
                    ativo: true,
                    tem_acesso_sistema: true
                };

                const { data: testUser, error: testUserError } = await supabase
                    .from('usuarios_empresa')
                    .insert(testUserData)
                    .select()
                    .single();

                if (testUserError) {
                    console.warn('Erro ao criar usu√°rio teste:', testUserError);
                    html += `<div class="error">‚ùå Erro ao criar usu√°rio teste: ${testUserError.message}</div>`;
                } else {
                    // Criar permiss√£o espec√≠fica para o usu√°rio teste
                    const testPermission = {
                        usuario_empresa_id: testUser.id,
                        modulo: 'gestao_caixa',
                        permissoes: {
                            visualizar: true,
                            criar: true,
                            editar: true,
                            excluir: false,
                            administrar: false
                        }
                    };

                    const { error: permError } = await supabase
                        .from('permissoes_usuario')
                        .insert(testPermission);

                    if (permError) {
                        console.warn('Erro ao criar permiss√£o teste:', permError);
                    } else {
                        html += `
                            <div class="success">
                                ‚úÖ <strong>Usu√°rio teste criado com sucesso!</strong><br>
                                üë§ Nome: ${testUser.nome_completo}<br>
                                üìß Email: ${testUser.email}<br>
                                üîë Permiss√£o: Apenas "gestao_caixa" com visualizar/criar/editar
                            </div>
                        `;
                    }

                    // Limpar usu√°rio teste ap√≥s o teste
                    setTimeout(async () => {
                        await supabase.from('permissoes_usuario').delete().eq('usuario_empresa_id', testUser.id);
                        await supabase.from('usuarios_empresa').delete().eq('id', testUser.id);
                        console.log('üßπ Usu√°rio teste removido');
                    }, 5000);
                }

                // Conclus√£o
                html += `
                    <div class="step">
                        <h3>üéØ Como o Sistema Funciona Agora:</h3>
                        <ol>
                            <li><strong>Busca permiss√µes espec√≠ficas:</strong> Sistema sempre verifica a tabela permissoes_usuario</li>
                            <li><strong>Prioriza espec√≠ficas:</strong> Se encontrar permiss√µes espec√≠ficas, usa APENAS elas</li>
                            <li><strong>Fallback para role:</strong> Se n√£o encontrar espec√≠ficas, usa padr√µes do role</li>
                            <li><strong>Logs detalhados:</strong> Console mostra exatamente quais permiss√µes est√£o sendo aplicadas</li>
                        </ol>
                    </div>
                `;

                html += `
                    <div class="info">
                        <h4>üîç Para Verificar se Funciona:</h4>
                        <ol>
                            <li>Fa√ßa login como um usu√°rio que tem permiss√µes espec√≠ficas</li>
                            <li>Abra o console (F12) e procure por logs como:</li>
                            <ul>
                                <li><code>‚úÖ X permiss√µes espec√≠ficas carregadas: [m√≥dulos]</code></li>
                                <li><code>üéØ Usando APENAS permiss√µes espec√≠ficas do usu√°rio</code></li>
                                <li><code>üìã M√≥dulo 'gestao_caixa' configurado: {...}</code></li>
                            </ul>
                            <li>Verifique se o menu mostra apenas os m√≥dulos permitidos</li>
                        </ol>
                    </div>
                `;

                document.getElementById('resultado-teste').innerHTML = html;

            } catch (error) {
                document.getElementById('resultado-teste').innerHTML = `
                    <div class="error">‚ùå Erro no teste: ${error.message}</div>
                `;
                console.error('‚ùå Erro no teste:', error);
            }
        }
    </script>
</body>
</html>