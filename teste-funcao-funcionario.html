<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Fun√ß√£o - Funcion√°rios</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .success { background-color: #d4edda; border: 2px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 8px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .employee-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .role-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .role-atendente { background: #e3f2fd; color: #1976d2; }
        .role-garcom { background: #e8f5e8; color: #388e3c; }
        .role-cozinheiro { background: #fff3e0; color: #f57c00; }
        .role-barman { background: #f3e5f5; color: #7b1fa2; }
        .role-gerente { background: #ffebee; color: #d32f2f; }
    </style>
</head>
<body>
    <div class="test-section">
        <h1>üß™ Teste Fun√ß√£o - Funcion√°rios</h1>
        <p>Teste para verificar se as fun√ß√µes dos funcion√°rios est√£o sendo exibidas corretamente</p>
        
        <div class="info">
            <strong>‚úÖ Corre√ß√£o Aplicada:</strong> JOIN entre tabelas <code>employees</code> e <code>bar_employees</code> para buscar a fun√ß√£o real
        </div>
        
        <button onclick="testarFuncoesFuncionarios()" id="btn-teste">üß™ Testar Fun√ß√µes dos Funcion√°rios</button>
        
        <div id="resultado-teste"></div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://wznycskqsavpmejwpksp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6bnljc2txc2F2cG1landwa3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzA2NjUsImV4cCI6MjA3MjIwNjY2NX0.uYXbBwQDo1pLeBrmtZnBR2M3a3_TsYDa637pcKSVC_8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function getRoleIcon(role) {
            switch (role) {
                case 'atendente': return 'üë•';
                case 'garcom': return 'üçΩÔ∏è';
                case 'cozinheiro': return 'üë®‚Äçüç≥';
                case 'barman': return 'üçπ';
                case 'gerente': return 'üëî';
                default: return 'üë§';
            }
        }

        function getRoleName(role) {
            switch (role) {
                case 'atendente': return 'Atendente';
                case 'garcom': return 'Gar√ßom';
                case 'cozinheiro': return 'Cozinheiro';
                case 'barman': return 'Barman';
                case 'gerente': return 'Gerente';
                default: return role || 'N√£o definido';
            }
        }

        function getRoleClass(role) {
            return `role-${role || 'atendente'}`;
        }

        async function testarFuncoesFuncionarios() {
            try {
                document.getElementById('resultado-teste').innerHTML = `
                    <div class="info">üîÑ Testando fun√ß√µes dos funcion√°rios...</div>
                `;

                // Passo 1: Login
                console.log('üîê Fazendo login...');
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: 'riltons@gmail.com',
                    password: '000000'
                });

                if (authError) {
                    throw new Error(`Erro no login: ${authError.message}`);
                }

                const empresaId = '9e445c5a-a382-444d-94f8-9d126ed6414e';
                console.log('‚úÖ Login realizado');

                // Passo 2: Buscar funcion√°rios com JOIN (vers√£o corrigida)
                console.log('üìä Buscando funcion√°rios com JOIN...');
                const { data: employeesData, error: employeesError } = await supabase
                    .from('employees')
                    .select(`
                        id, name, email, phone, cpf, status, employee_code,
                        tem_acesso_sistema, auth_user_id, created_at, updated_at,
                        position_id, department_id,
                        bar_employees!inner(
                            bar_role, shift_preference, specialties, commission_rate,
                            is_active, start_date, end_date, notes
                        )
                    `)
                    .eq('empresa_id', empresaId)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (employeesError) {
                    throw new Error(`Erro ao buscar funcion√°rios: ${employeesError.message}`);
                }

                console.log('‚úÖ Funcion√°rios encontrados:', employeesData.length);

                // Passo 3: Mapear dados (simulando o hook corrigido)
                const mappedEmployees = (employeesData || []).map((emp) => {
                    const barEmployeeData = emp.bar_employees?.[0] || {};
                    
                    return {
                        id: emp.id,
                        employee_id: emp.id,
                        bar_role: barEmployeeData.bar_role || 'atendente',
                        shift_preference: barEmployeeData.shift_preference || 'qualquer',
                        specialties: barEmployeeData.specialties || [],
                        commission_rate: barEmployeeData.commission_rate || 0,
                        status: emp.status,
                        start_date: barEmployeeData.start_date || emp.created_at,
                        end_date: barEmployeeData.end_date || null,
                        notes: barEmployeeData.notes || `C√≥digo: ${emp.employee_code}`,
                        created_at: emp.created_at,
                        updated_at: emp.updated_at,
                        is_active: barEmployeeData.is_active !== undefined ? barEmployeeData.is_active : (emp.status === 'active'),
                        employee: {
                            id: emp.id,
                            name: emp.name || 'Nome n√£o informado',
                            cpf: emp.cpf,
                            email: emp.email,
                            phone: emp.phone,
                            hire_date: emp.created_at,
                            status: emp.status
                        }
                    };
                });

                console.log('‚úÖ Mapeamento conclu√≠do:', mappedEmployees.length);

                // An√°lise das fun√ß√µes
                const roleStats = {};
                mappedEmployees.forEach(emp => {
                    const role = emp.bar_role || 'n√£o definido';
                    roleStats[role] = (roleStats[role] || 0) + 1;
                });

                // Mostrar resultado
                let html = `
                    <div class="success">
                        ‚úÖ <strong>Teste Conclu√≠do!</strong><br>
                        üìä Total de funcion√°rios: ${employeesData.length}<br>
                        üîÑ Funcion√°rios mapeados: ${mappedEmployees.length}
                    </div>
                `;

                // Estat√≠sticas por fun√ß√£o
                html += `<h3>üìä Estat√≠sticas por Fun√ß√£o:</h3>`;
                html += `<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">`;
                Object.entries(roleStats).forEach(([role, count]) => {
                    html += `
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 24px;">${getRoleIcon(role)}</div>
                            <div style="font-weight: bold; font-size: 18px;">${count}</div>
                            <div style="font-size: 12px; color: #666;">${getRoleName(role)}</div>
                        </div>
                    `;
                });
                html += `</div>`;

                // Tabela de funcion√°rios
                html += `<h3>üë• Lista de Funcion√°rios com Fun√ß√µes:</h3>`;
                html += `<table>
                    <tr>
                        <th>Nome</th>
                        <th>Fun√ß√£o</th>
                        <th>Email</th>
                        <th>CPF</th>
                        <th>Status</th>
                    </tr>`;
                
                mappedEmployees.slice(0, 15).forEach(barEmployee => {
                    const employee = barEmployee.employee;
                    if (!employee) return;
                    
                    html += `
                        <tr>
                            <td>${employee.name}</td>
                            <td>
                                <span class="role-badge ${getRoleClass(barEmployee.bar_role)}">
                                    ${getRoleIcon(barEmployee.bar_role)} ${getRoleName(barEmployee.bar_role)}
                                </span>
                            </td>
                            <td>${employee.email || 'N/A'}</td>
                            <td>${employee.cpf || 'N/A'}</td>
                            <td>${barEmployee.status}</td>
                        </tr>
                    `;
                });
                html += `</table>`;

                if (mappedEmployees.length > 15) {
                    html += `<p><em>... e mais ${mappedEmployees.length - 15} funcion√°rios</em></p>`;
                }

                // Verifica√ß√£o se a corre√ß√£o funcionou
                const diverseFunctions = Object.keys(roleStats).length > 1;
                const hasNonAttendant = Object.keys(roleStats).some(role => role !== 'atendente');

                if (diverseFunctions && hasNonAttendant) {
                    html += `
                        <div class="success">
                            üéâ <strong>CORRE√á√ÉO FUNCIONOU!</strong><br>
                            ‚úÖ Encontradas ${Object.keys(roleStats).length} fun√ß√µes diferentes<br>
                            ‚úÖ N√£o s√£o todos "Atendente" como antes
                        </div>
                    `;
                } else {
                    html += `
                        <div class="error">
                            ‚ùå <strong>PROBLEMA PERSISTE!</strong><br>
                            ${!diverseFunctions ? '‚ùå Todos ainda t√™m a mesma fun√ß√£o' : ''}
                            ${!hasNonAttendant ? '‚ùå Todos ainda s√£o "Atendente"' : ''}
                        </div>
                    `;
                }

                document.getElementById('resultado-teste').innerHTML = html;

                // Logs detalhados
                console.log('üîç Estat√≠sticas por fun√ß√£o:', roleStats);
                console.log('üîç Primeiro funcion√°rio mapeado:', mappedEmployees[0]);

            } catch (error) {
                document.getElementById('resultado-teste').innerHTML = `
                    <div class="error">‚ùå Erro no teste: ${error.message}</div>
                `;
                console.error('‚ùå Erro no teste:', error);
            }
        }
    </script>
</body>
</html>